<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  <meta name="google-site-verification" content="VX-JY4ruJ-KE2MxXD4xtbsmVTG_NxEiPM-3Y8KNnWug" />
  
  
  <title>原始笔记--python爬虫 | Chanoch&#39;s Blog</title>
  <meta name="description" content="学习python爬虫的原始笔记，尚未进行整理。">
<meta property="og:type" content="article">
<meta property="og:title" content="原始笔记--python爬虫">
<meta property="og:url" content="https://blog.chanoch.top/2023/01/30/raw-spider-note/index.html">
<meta property="og:site_name" content="Chanoch&#39;s blog">
<meta property="og:description" content="学习python爬虫的原始笔记，尚未进行整理。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/image-20230202193031196.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/2-11.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/3-2.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/7-7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-5.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-18.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-21.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-25.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/9-1.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/13-1.jpg">
<meta property="article:published_time" content="2023-01-30T05:03:10.000Z">
<meta property="article:modified_time" content="2023-02-18T02:00:51.789Z">
<meta property="article:author" content="chanoch">
<meta property="article:tag" content="爬虫">
<meta property="article:tag" content="原始笔记">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/image-20230202193031196.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://blog.chanoch.top/2023/01/30/raw-spider-note/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Chanoch&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/logo.ico" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    <link href="//cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet">
  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/chanochLi" target="_blank">
          <img class="img-circle img-rotate" src="/images/favicon.ico" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">chanoch</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">student&amp;engineer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Nanjing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/chanochLi" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="mailto:kujou.zao@gmail.com" target="_blank" title="Email" data-toggle=tooltip data-placement=top><i class="icon icon-email"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8E%9F%E5%A7%8B%E7%AC%94%E8%AE%B0/">原始笔记</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/6800H/" style="font-size: 13px;">6800H</a> <a href="/tags/Linux/" style="font-size: 13px;">Linux</a> <a href="/tags/Thinkbook14/" style="font-size: 13px;">Thinkbook14+</a> <a href="/tags/python/" style="font-size: 13px;">python</a> <a href="/tags/%E5%8E%9F%E5%A7%8B%E7%AC%94%E8%AE%B0/" style="font-size: 13px;">原始笔记</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 13px;">爬虫</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Linux/">Linux</a>
              </p>
              <p class="item-title">
                <a href="/2023/02/26/thinkbook14/" class="title">Thinkbook14+锐龙版安装Linux避坑指南</a>
              </p>
              <p class="item-date">
                <time datetime="2023-02-26T15:25:50.000Z" itemprop="datePublished">2023-02-26</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%8E%9F%E5%A7%8B%E7%AC%94%E8%AE%B0/">原始笔记</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/30/raw-spider-note/" class="title">原始笔记--python爬虫</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-30T05:03:10.000Z" itemprop="datePublished">2023-01-30</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">预备知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URL"><span class="toc-number">1.1.</span> <span class="toc-text">URL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP%E5%92%8CHTTPS"><span class="toc-number">1.2.</span> <span class="toc-text">HTTP和HTTPS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5"><span class="toc-number">1.3.</span> <span class="toc-text">网页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%9E%84%E6%88%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">网页构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">网页结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.3.3.</span> <span class="toc-text">动态页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8A%93%E5%8C%85"><span class="toc-number">1.3.4.</span> <span class="toc-text">浏览器抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.5.</span> <span class="toc-text">编码格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E5%92%8CCookie"><span class="toc-number">1.4.</span> <span class="toc-text">会话和Cookie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Json%E4%B8%B2"><span class="toc-number">1.6.</span> <span class="toc-text">Json串</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%88%AC%E8%99%AB%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">爬虫基本原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.2.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">2.1.3.</span> <span class="toc-text">分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%88%E6%B3%95%E6%80%A7"><span class="toc-number">2.1.4.</span> <span class="toc-text">合法性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%9B%E4%B8%8E%E7%9B%BE"><span class="toc-number">2.2.</span> <span class="toc-text">矛与盾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E7%88%AC%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.1.</span> <span class="toc-text">反爬机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%8F%8D%E7%88%AC%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.2.</span> <span class="toc-text">反反爬策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#robots-txt%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.2.3.</span> <span class="toc-text">robots.txt协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UA%E4%BC%AA%E8%A3%85"><span class="toc-number">2.2.4.</span> <span class="toc-text">UA伪装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%B7%E6%B1%82%E5%BA%93"><span class="toc-number">3.</span> <span class="toc-text">基本请求库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#urllib%E5%BA%93"><span class="toc-number">3.1.</span> <span class="toc-text">urllib库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82-request%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.1.</span> <span class="toc-text">发送请求(request模块)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8-error%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.2.</span> <span class="toc-text">处理异常(error模块)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E9%93%BE%E6%8E%A5-parse%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.3.</span> <span class="toc-text">解析链接(parse模块)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90Robots%E5%8D%8F%E8%AE%AE-tobotparser%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.4.</span> <span class="toc-text">分析Robots协议(tobotparser模块)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requests%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.</span> <span class="toc-text">requests模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.1.</span> <span class="toc-text">环境安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B-requests%E6%A8%A1%E5%9D%97%E7%9A%84%E7%BC%96%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">浏览器请求过程(requests模块的编码流程)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GET%E8%AF%B7%E6%B1%82"><span class="toc-number">3.2.3.</span> <span class="toc-text">GET请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POST%E8%AF%B7%E6%B1%82"><span class="toc-number">3.2.4.</span> <span class="toc-text">POST请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">3.2.5.</span> <span class="toc-text">文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie"><span class="toc-number">3.2.6.</span> <span class="toc-text">Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%BB%B4%E6%8C%81"><span class="toc-number">3.2.7.</span> <span class="toc-text">会话维持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81"><span class="toc-number">3.2.8.</span> <span class="toc-text">SSL证书验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86-1"><span class="toc-number">3.2.9.</span> <span class="toc-text">代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.2.10.</span> <span class="toc-text">超时设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">3.2.11.</span> <span class="toc-text">身份认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prepared-Request%E7%B1%BB"><span class="toc-number">3.2.12.</span> <span class="toc-text">Prepared Request类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">数据解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%B1%BB-1"><span class="toc-number">4.1.</span> <span class="toc-text">分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">4.3.</span> <span class="toc-text">正则表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99"><span class="toc-number">4.3.1.</span> <span class="toc-text">规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0-%E6%8B%93%E5%B1%95%E6%AD%A3%E5%88%99"><span class="toc-number">4.3.2.</span> <span class="toc-text">参数(拓展正则)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#re%E6%A8%A1%E5%9D%97"><span class="toc-number">4.3.3.</span> <span class="toc-text">re模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bs4%E8%A7%A3%E6%9E%90-python%E7%8B%AC%E6%9C%89"><span class="toc-number">4.4.</span> <span class="toc-text">bs4解析(python独有)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">4.4.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">4.4.2.</span> <span class="toc-text">步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-1"><span class="toc-number">4.4.3.</span> <span class="toc-text">环境安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BeautifulSoup"><span class="toc-number">4.4.4.</span> <span class="toc-text">BeautifulSoup</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pyquery"><span class="toc-number">4.5.</span> <span class="toc-text">pyquery</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">4.5.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">4.5.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xpath"><span class="toc-number">4.6.</span> <span class="toc-text">xpath</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E8%A7%84%E5%88%99"><span class="toc-number">4.6.1.</span> <span class="toc-text">常用规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">4.6.2.</span> <span class="toc-text">步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-2"><span class="toc-number">4.6.3.</span> <span class="toc-text">环境安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etree"><span class="toc-number">4.6.4.</span> <span class="toc-text">etree</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">5.</span> <span class="toc-text">数据存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8"><span class="toc-number">5.1.</span> <span class="toc-text">文件存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#txt%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.1.</span> <span class="toc-text">txt文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.2.</span> <span class="toc-text">JSON文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSV%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.3.</span> <span class="toc-text">CSV文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%98%E5%82%A8"><span class="toc-number">5.2.</span> <span class="toc-text">关系型数据库存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PyMysql%E4%BD%BF%E7%94%A8"><span class="toc-number">5.2.1.</span> <span class="toc-text">PyMysql使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.3.</span> <span class="toc-text">非关系数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%B1%BB-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MongoDB"><span class="toc-number">5.3.2.</span> <span class="toc-text">MongoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis"><span class="toc-number">5.3.3.</span> <span class="toc-text">Redis</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%A1%B5%E9%9D%A2%E6%8A%93%E5%8F%96"><span class="toc-number">6.</span> <span class="toc-text">动态页面抓取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ajax%E6%95%B0%E6%8D%AE"><span class="toc-number">6.1.</span> <span class="toc-text">Ajax数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ajax%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.2.</span> <span class="toc-text">Ajax分析方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ajax%E7%BB%93%E6%9E%9C%E6%8A%93%E5%8F%96"><span class="toc-number">6.1.3.</span> <span class="toc-text">Ajax结果抓取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Selenium"><span class="toc-number">6.2.</span> <span class="toc-text">Selenium</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">6.2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-number">6.2.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chrome-Headless%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.2.3.</span> <span class="toc-text">Chrome Headless模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Splash"><span class="toc-number">6.3.</span> <span class="toc-text">Splash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">6.3.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">6.3.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">6.3.3.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E8%84%9A%E6%9C%AC"><span class="toc-number">6.3.4.</span> <span class="toc-text">Lua脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Splash-API"><span class="toc-number">6.3.5.</span> <span class="toc-text">Splash API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Splash%E5%9D%87%E8%A1%A1%E8%B4%9F%E8%BD%BD"><span class="toc-number">6.3.6.</span> <span class="toc-text">Splash均衡负载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB"><span class="toc-number">7.</span> <span class="toc-text">验证码识别</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">7.1.</span> <span class="toc-text">图形验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%81%E9%AA%8C%E6%BB%91%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">7.2.</span> <span class="toc-text">极验滑动验证码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">7.2.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%86%E5%88%AB"><span class="toc-number">7.2.2.</span> <span class="toc-text">识别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.3.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%82%B9%E8%A7%A6%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">7.3.</span> <span class="toc-text">点触验证码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">7.3.2.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%AB%E6%A0%BC%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">7.4.</span> <span class="toc-text">宫格验证码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%86%E5%88%AB%E6%80%9D%E8%B7%AF"><span class="toc-number">7.4.1.</span> <span class="toc-text">识别思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">7.4.2.</span> <span class="toc-text">实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%90%86-2"><span class="toc-number">8.</span> <span class="toc-text">代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.1.</span> <span class="toc-text">代理设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#urllib"><span class="toc-number">8.1.1.</span> <span class="toc-text">urllib</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requests"><span class="toc-number">8.1.2.</span> <span class="toc-text">requests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Selenium-1"><span class="toc-number">8.1.3.</span> <span class="toc-text">Selenium</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%B1%A0"><span class="toc-number">8.2.</span> <span class="toc-text">代理池</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-number">8.2.1.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP%E6%9C%89%E6%95%88%E6%80%A7%E5%88%A4%E6%96%AD"><span class="toc-number">8.2.2.</span> <span class="toc-text">IP有效性判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">8.2.3.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%98%E8%B4%B9%E4%BB%A3%E7%90%86"><span class="toc-number">8.3.</span> <span class="toc-text">付费代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ADSL%E6%8B%A8%E5%8F%B7%E4%BB%A3%E7%90%86"><span class="toc-number">8.4.</span> <span class="toc-text">ADSL拨号代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.4.1.</span> <span class="toc-text">设置代理服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%98%9F%E5%88%97"><span class="toc-number">8.5.</span> <span class="toc-text">请求队列</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E7%99%BB%E9%99%86"><span class="toc-number">9.</span> <span class="toc-text">模拟登陆</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E9%99%86"><span class="toc-number">9.1.</span> <span class="toc-text">登陆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie%E6%93%8D%E4%BD%9C"><span class="toc-number">9.2.</span> <span class="toc-text">cookie操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#session%E4%BC%9A%E8%AF%9D%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.2.1.</span> <span class="toc-text">session会话对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie%E6%B1%A0"><span class="toc-number">9.2.2.</span> <span class="toc-text">Cookie池</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB"><span class="toc-number">10.</span> <span class="toc-text">异步爬虫</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%B1%BB-3"><span class="toc-number">10.1.</span> <span class="toc-text">分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aiohttp"><span class="toc-number">10.2.</span> <span class="toc-text">aiohttp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#scrapy%E6%A1%86%E6%9E%B6"><span class="toc-number">11.</span> <span class="toc-text">scrapy框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">11.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">11.1.1.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-1"><span class="toc-number">11.1.2.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B"><span class="toc-number">11.1.3.</span> <span class="toc-text">过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">11.1.4.</span> <span class="toc-text">项目结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-2"><span class="toc-number">11.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">11.3.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E6%8C%87%E4%BB%A4"><span class="toc-number">11.3.1.</span> <span class="toc-text">工程指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%AC%E8%99%AB%E6%96%87%E4%BB%B6"><span class="toc-number">11.3.2.</span> <span class="toc-text">爬虫文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">11.3.3.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8-Item%E5%92%8CPipeline"><span class="toc-number">11.3.4.</span> <span class="toc-text">持久化存储(Item和Pipeline)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E7%AB%99%E7%88%AC%E5%8F%96-CrawlSpider"><span class="toc-number">11.3.5.</span> <span class="toc-text">全站爬取(CrawlSpider)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%BC%A0%E5%8F%82"><span class="toc-number">11.3.6.</span> <span class="toc-text">请求传参</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E7%88%AC%E5%8F%96ImagesPipeline"><span class="toc-number">11.3.7.</span> <span class="toc-text">图片爬取ImagesPipeline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB"><span class="toc-number">11.3.8.</span> <span class="toc-text">分布式爬虫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%BC%8F%E7%88%AC%E8%99%AB"><span class="toc-number">11.3.9.</span> <span class="toc-text">增量式爬虫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spider"><span class="toc-number">11.3.10.</span> <span class="toc-text">Spider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-number">11.3.11.</span> <span class="toc-text">调度器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%99%A8"><span class="toc-number">11.3.12.</span> <span class="toc-text">下载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E9%81%93"><span class="toc-number">11.3.13.</span> <span class="toc-text">管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E6%93%8E"><span class="toc-number">11.3.14.</span> <span class="toc-text">引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">11.3.15.</span> <span class="toc-text">中间件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#APP%E7%88%AC%E5%8F%96"><span class="toc-number">12.</span> <span class="toc-text">APP爬取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Charles"><span class="toc-number">12.1.</span> <span class="toc-text">Charles</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-5"><span class="toc-number">12.1.1.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mitmproxy"><span class="toc-number">12.2.</span> <span class="toc-text">mitmproxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-2"><span class="toc-number">12.2.1.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mitmdump"><span class="toc-number">12.2.2.</span> <span class="toc-text">mitmdump</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appium"><span class="toc-number">12.3.</span> <span class="toc-text">Appium</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8APP"><span class="toc-number">12.3.1.</span> <span class="toc-text">启动APP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API"><span class="toc-number">12.3.2.</span> <span class="toc-text">API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Appium-mitmdump"><span class="toc-number">12.3.3.</span> <span class="toc-text">Appium+mitmdump</span></a></li></ol></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-raw-spider-note" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      原始笔记--python爬虫
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2023/01/30/raw-spider-note/" class="article-date">
	  <time datetime="2023-01-30T05:03:10.000Z" itemprop="datePublished">2023-01-30</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E5%8E%9F%E5%A7%8B%E7%AC%94%E8%AE%B0/">原始笔记</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/python/" rel="tag">python</a>, <a class="article-tag-link-link" href="/tags/%E5%8E%9F%E5%A7%8B%E7%AC%94%E8%AE%B0/" rel="tag">原始笔记</a>, <a class="article-tag-link-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/01/30/raw-spider-note/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 30.3k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 128(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h1><h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><ul>
<li><p>URI称为统一资源标志符，包含URL(统一资源定位符)和URN(统一资源名称)</p>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/image-20230202193031196.png" alt="image-20230202193031196"></p>
</li>
<li><p>但URN几乎不使用，一般网页链接可以直接称为URL</p>
</li>
<li><p>url的格式如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme:<span class="regexp">//</span>netloc/path;params?query<span class="comment">#fragment</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>scheme</code>：使用的协议</li>
<li><code>netloc</code>：域名</li>
<li><code>path</code>：路径</li>
<li><code>params</code>：参数</li>
<li><code>query</code>：查询条件，一般用于GET类型的URL</li>
<li><code>fragment</code>：锚点，定位页面内部的下拉位置</li>
</ul>
</li>
</ul>
<h2 id="HTTP和HTTPS"><a href="#HTTP和HTTPS" class="headerlink" title="HTTP和HTTPS"></a>HTTP和HTTPS</h2><ul>
<li><p>超文本标记语言采用标签来表示不同的元素，排列成为网页</p>
</li>
<li><p>HTTP和HTTPS是超文本传输协议，客户端和服务端根据HTTP协议请求和响应数据</p>
</li>
<li><p>HTTPS是在HTTP的基础上经过SSL进行加密，客户端和服务端遵守协议进行通讯，加密方式有以下三种：</p>
<ul>
<li>对称密钥加密：密钥和密文一同传输</li>
<li>非对称密钥加密：制定公钥和私钥，先将公钥发送给客户端(效率低；无法保证客户端拿到的是服务器端的公钥)</li>
<li>证书密钥加密：证书认证机构对公钥进行签名(HTTPS使用)</li>
</ul>
</li>
<li><p>请求</p>
<ul>
<li><p>请求方法：常见分为GET和POST，其它可以参考<a target="_blank" rel="noopener" href="http://www.runoob.com/http/http-methods.html">http://www.runoob.com/http/http-methods.html</a></p>
<ul>
<li><p>GET请求的参数包含在URL中，POST请求的参数以表单形式传输，包含在请求体中</p>
<blockquote>
<p>一般POST请求的表单数据会在响应的from字段中返回</p>
</blockquote>
</li>
<li><p>GET请求提交数据有1024B的限制，POST没有</p>
<blockquote>
<p>一般情况下，提交敏感信息使用POST请求</p>
</blockquote>
</li>
</ul>
</li>
<li><p>请求地址：即URL</p>
</li>
<li><p>请求头：要使用的附加信息</p>
<ul>
<li><code>Accept</code>：请求报头域，指定客户端可以接受的信息类型</li>
<li><code>Accept-Language</code>：指定客户端能接受的语言</li>
<li><code>Accept-Encoding</code>：指定客户端能接受的编码</li>
<li><code>Host</code>：指定请求将要发送到的服务器主机名和端口号，HTTP1.1后必须包含</li>
<li><code>Cookie</code>：标识维持当前访问会话的数据</li>
<li><code>Referer</code>：标识请求是从哪个界面发送的</li>
<li><code>User-Agent</code>：标识客户使用的操作系统及版本、浏览器及版本等信息</li>
<li><code>Content-Type</code>：也叫互联网媒体类型，表示具体请求中媒体类型信息，可以查阅<a target="_blank" rel="noopener" href="https://tool.oschina.net/commons">https://tool.oschina.net/commons</a></li>
</ul>
</li>
<li><p>请求体：POST请求为表单数据(此时请求头中<code>Content-Type</code> 与POST请求有固定对应关系)，GET则为空</p>
<table>
<thead>
<tr>
<th>Content-Type</th>
<th>提交数据的方式</th>
</tr>
</thead>
<tbody><tr>
<td>application&#x2F;x-www-form-urlencoded</td>
<td>表单数据</td>
</tr>
<tr>
<td>multipart&#x2F;form-data</td>
<td>表单文件上传</td>
</tr>
<tr>
<td>application&#x2F;json</td>
<td>序列化 JSON 数据</td>
</tr>
<tr>
<td>text&#x2F;xml</td>
<td>XML 数据</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p>响应</p>
<ul>
<li><p>响应状态码：200为成功，404为未找到页面，500为服务器内部错误等</p>
</li>
<li><p>响应头：</p>
<ul>
<li><code>Date</code>：响应产生的时间</li>
<li><code>Last-Modified</code>：指定资源的最后修改时间</li>
<li><code>Content-Encoding</code>：指定响应内容的编码</li>
<li><code>Server</code>：包含服务器的信息，比如名称、版本号等</li>
<li><code>Content-Type</code>：文档类型</li>
<li><code>Set-Cookie</code>：设置 Cookies。响应头中的 <code>Set-Cookie </code>告诉浏览器需要将此内容放在 Cookies 中，下次请求携带 Cookies 请求</li>
<li><code>Expires</code>：指定响应的过期时间，如果在期限内再次访问时，就可以直接从缓存中加载</li>
</ul>
</li>
<li><p>响应体：内容即为数据</p>
</li>
</ul>
</li>
</ul>
<h2 id="网页"><a href="#网页" class="headerlink" title="网页"></a>网页</h2><h3 id="网页构成"><a href="#网页构成" class="headerlink" title="网页构成"></a>网页构成</h3><ul>
<li><p>HTML：即超文本标记语言，使用不同类型的标签表示不同的元素，嵌套排列成为网页</p>
<blockquote>
<p>一个网页的标准形式是 html 标签内嵌套 <code>head</code> 和 <code>body </code>标签，<code>head </code>内定义网页的配置和引用，<code>body</code> 内定义网页的正文</p>
</blockquote>
</li>
<li><p>CSS：即层叠样式表，层叠指HTML引用了几个样式文件且发生冲突时，浏览器依据层叠顺序处理，样式是指网页中元素的排列，大小，格式，间距等</p>
</li>
<li><p>JavaScript：脚本语言，实现了实时动态的交互功能，使用<code>&lt;script&gt;</code>引入</p>
</li>
</ul>
<h3 id="网页结构"><a href="#网页结构" class="headerlink" title="网页结构"></a>网页结构</h3><ul>
<li>节点树及节点：根据<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/htmldom/dom_nodes.asp">W3C(万维网联盟)的DOM标准</a>，HTML内容都为节点，构成节点树，具有相应地层级关系，顶端节点为根(root)</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/2-11.jpg"></p>
<ul>
<li>CSS选择器：css利用选择器来定位节点</li>
</ul>
<blockquote>
<p>选择器也是爬虫解析网页的一种方式</p>
</blockquote>
<ul>
<li><p>选择器中间加空格表示嵌套，不加空格表示并列，<code>&gt; </code>表示直属的父子标签</p>
</li>
<li><p><code>#</code>开头代表选择id，后紧跟id名称</p>
</li>
<li><p><code>.</code>代表选择class，后紧跟class名称</p>
</li>
<li><p>标签名也是筛选</p>
</li>
<li><p>其它语法如下表</p>
<table>
<thead>
<tr>
<th>选　择　器</th>
<th>例　　子</th>
<th>例子描述</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>*</td>
<td>选择所有节点</td>
</tr>
<tr>
<td>element,element</td>
<td>div,p</td>
<td>选择所有 div 节点和所有 p 节点</td>
</tr>
<tr>
<td>element+element</td>
<td>div+p</td>
<td>选择紧接在 div 节点之后的所有 p 节点</td>
</tr>
<tr>
<td>[attribute]</td>
<td>[target]</td>
<td>选择带有 target 属性的所有节点</td>
</tr>
<tr>
<td>[attribute&#x3D;value]</td>
<td>[target&#x3D;blank]</td>
<td>选择 target&#x3D;”blank” 的所有节点</td>
</tr>
<tr>
<td>[attribute~&#x3D;value]</td>
<td>[title~&#x3D;flower]</td>
<td>选择 title 属性包含单词 flower 的所有节点</td>
</tr>
<tr>
<td>:link</td>
<td>a:link</td>
<td>选择所有未被访问的链接</td>
</tr>
<tr>
<td>:visited</td>
<td>a:visited</td>
<td>选择所有已被访问的链接</td>
</tr>
<tr>
<td>:active</td>
<td>a:active</td>
<td>选择活动链接</td>
</tr>
<tr>
<td>:hover</td>
<td>a:hover</td>
<td>选择鼠标指针位于其上的链接</td>
</tr>
<tr>
<td>:focus</td>
<td>input:focus</td>
<td>选择获得焦点的 input 节点</td>
</tr>
<tr>
<td>:first-letter</td>
<td>p:first-letter</td>
<td>选择每个 p 节点的首字母</td>
</tr>
<tr>
<td>:first-line</td>
<td>p:first-line</td>
<td>选择每个 p 节点的首行</td>
</tr>
<tr>
<td>:first-child</td>
<td>p:first-child</td>
<td>选择属于父节点的第一个子节点的所有 p 节点</td>
</tr>
<tr>
<td>:before</td>
<td>p:before</td>
<td>在每个 p 节点的内容之前插入内容</td>
</tr>
<tr>
<td>:after</td>
<td>p:after</td>
<td>在每个 p 节点的内容之后插入内容</td>
</tr>
<tr>
<td>:lang(language)</td>
<td>p:lang</td>
<td>选择带有以 it 开头的 lang 属性值的所有 p 节点</td>
</tr>
<tr>
<td>element1~element2</td>
<td>p~ul</td>
<td>选择前面有 p 节点的所有 ul 节点</td>
</tr>
<tr>
<td>[attribute^&#x3D;value]</td>
<td>a[src^&#x3D;”https”]</td>
<td>选择其 src 属性值以 https 开头的所有 a 节点</td>
</tr>
<tr>
<td>[attribute$&#x3D;value]</td>
<td>a[src$&#x3D;”.pdf”]</td>
<td>选择其 src 属性以.pdf 结尾的所有 a 节点</td>
</tr>
<tr>
<td>[attribute*&#x3D;value]</td>
<td>a[src*&#x3D;”abc”]</td>
<td>选择其 src 属性中包含 abc 子串的所有 a 节点</td>
</tr>
<tr>
<td>:first-of-type</td>
<td>p:first-of-type</td>
<td>选择属于其父节点的首个 p 节点的所有 p 节点</td>
</tr>
<tr>
<td>:last-of-type</td>
<td>p:last-of-type</td>
<td>选择属于其父节点的最后 p 节点的所有 p 节点</td>
</tr>
<tr>
<td>:only-of-type</td>
<td>p:only-of-type</td>
<td>选择属于其父节点唯一的 p 节点的所有 p 节点</td>
</tr>
<tr>
<td>:only-child</td>
<td>p:only-child</td>
<td>选择属于其父节点的唯一子节点的所有 p 节点</td>
</tr>
<tr>
<td>:nth-child(n)</td>
<td>p:nth-child</td>
<td>选择属于其父节点的第二个子节点的所有 p 节点</td>
</tr>
<tr>
<td>:nth-last-child(n)</td>
<td>p:nth-last-child</td>
<td>同上，从最后一个子节点开始计数</td>
</tr>
<tr>
<td>:nth-of-type(n)</td>
<td>p:nth-of-type</td>
<td>选择属于其父节点第二个 p 节点的所有 p 节点</td>
</tr>
<tr>
<td>:nth-last-of-type(n)</td>
<td>p:nth-last-of-type</td>
<td>同上，但是从最后一个子节点开始计数</td>
</tr>
<tr>
<td>:last-child</td>
<td>p:last-child</td>
<td>选择属于其父节点最后一个子节点的所有 p 节点</td>
</tr>
<tr>
<td>:root</td>
<td>:root</td>
<td>选择文档的根节点</td>
</tr>
<tr>
<td>:empty</td>
<td>p:empty</td>
<td>选择没有子节点的所有 p 节点（包括文本节点）</td>
</tr>
<tr>
<td>:target</td>
<td>#news:target</td>
<td>选择当前活动的 #news 节点</td>
</tr>
<tr>
<td>:enabled</td>
<td>input:enabled</td>
<td>选择每个启用的 input 节点</td>
</tr>
<tr>
<td>:disabled</td>
<td>input:disabled</td>
<td>选择每个禁用的 input 节点</td>
</tr>
<tr>
<td>:checked</td>
<td>input:checked</td>
<td>选择每个被选中的 input 节点</td>
</tr>
<tr>
<td>:not(selector)</td>
<td>:not</td>
<td>选择非 p 节点的所有节点</td>
</tr>
<tr>
<td>::selection</td>
<td>::selection</td>
<td>选择被用户选取的节点部分</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="动态页面"><a href="#动态页面" class="headerlink" title="动态页面"></a>动态页面</h3><ul>
<li><p>使用AJAX，ASP，JSP等动态网页技术实现网页的局部加载或刷新(一般通过抓包获取交换的JSON数据)</p>
</li>
<li><p>浏览器打开页面时，先加载HTML内容，在引入文件处执行代码，而代码可能改变HTML中的节点</p>
</li>
<li><p>在爬虫请求时，不会加载代码，需要分析Ajax接口或使用Selenium，Splash等库实现渲染</p>
</li>
<li><p>检测：</p>
<ul>
<li>对URL发请求，查看是否缺失部分数据</li>
<li>抓包工具查看是否有动态请求</li>
<li>浏览网页是否有局部刷新</li>
</ul>
</li>
<li><p>提取：</p>
<ul>
<li>直接抓包</li>
<li>用正则解析html中的js等源码</li>
</ul>
</li>
</ul>
<h3 id="浏览器抓包"><a href="#浏览器抓包" class="headerlink" title="浏览器抓包"></a>浏览器抓包</h3><ul>
<li><p>一般F12进入浏览器抓包，Elements为网页源码数据，Network为数据包</p>
</li>
<li><p>Network中XHR表示动态请求，可以查询到GET&#x2F;POST方法，请求的url，参数，响应数据格式(<code>Content-Type</code>)，响应数据</p>
</li>
<li><p><code>Content-Type</code>：</p>
<ul>
<li><code>text/plain</code>：字符串</li>
<li><code>application/json</code>：json格式</li>
</ul>
</li>
</ul>
<h3 id="编码格式"><a href="#编码格式" class="headerlink" title="编码格式"></a>编码格式</h3><ul>
<li><p>requests库会基于http头部中<code>Content-Type</code>对响应的编码进行推测，其中的charset决定了编码方式，如果未指定，<code>Content-Type</code>默认为<code>text/html</code></p>
</li>
<li><p>可以使用chardet库推测编码格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chardet.detect(raw_data)</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以通过修改<code>response</code>的<code>encoding</code>属性进行修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.encoding = chardet.detect(response.content)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>通用中文乱码：</p>
<p>1.整体设置为utf-8</p>
<ol start="2">
<li></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span>.encode(<span class="string">&#x27;iso-8859-1&#x27;</span>).decode(<span class="string">&#x27;gbk&#x27;</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="会话和Cookie"><a href="#会话和Cookie" class="headerlink" title="会话和Cookie"></a>会话和Cookie</h2><ul>
<li><p>HTTP是无状态的，即服务器不知道客户端是什么状态</p>
</li>
<li><p>会话(Session)和Cookie用于保持HTTP连接状态</p>
<ul>
<li>会话在服务器端，保存用户的会话信息，存储特定用户的属性和配置信息</li>
<li>Cookie在客户端，在浏览器请求时附带上Cookie，服务器能识别用户，判断状态，返回对应的响应</li>
</ul>
</li>
<li><p>会话维持：客户端第一次请求服务器时，服务器会在响应头中带有<code>Set-Cookie</code>字段，标记用户，在下一次请求时，浏览器就会把Cookie放入请求</p>
</li>
<li><p>属性结构：</p>
<ul>
<li><code>Name</code>：Cookie名称，一旦创建，不可更改</li>
<li><code>Value</code>：Cookie的值，如果为Unicode，采用字符编码，如果为二进制，使用BASE64编码</li>
<li><code>Max Age</code>：失效时间，单位为秒，如果为负数，表示关闭浏览器即失效</li>
<li><code>Path</code>：Cookie使用的路径，如果设定，则只有路径为&#x2F;Path&#x2F;的页面能用此Cookie</li>
<li><code>Domain</code>：可以访问该Cookie的域名</li>
<li><code>Size</code>：Cookie的大小</li>
<li><code>Http</code>字段：Cookie的<code>httponly</code>属性，若为<code>True</code>，只能在<code>HTTP Headers</code>中带有Cookie信息，不能通过<code>document.cookie</code>访问</li>
<li><code>Secure</code>：是否使用安全协议，默认为<code>False</code></li>
</ul>
</li>
<li><p>持久Cookie：严格来说，是<code>Max Age</code>或<code>Expires</code>字段设置较长的Cookie，会保存在营盘中</p>
</li>
</ul>
<blockquote>
<p>关闭浏览器时，服务器无法知晓，因此关闭浏览器不会导致会话失效</p>
</blockquote>
<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><ul>
<li><p>代理指代理服务器，它能代理网络用户区获取网络信息，本机在访问Web服务器时，由代理服务器进行中转</p>
</li>
<li><p>优势：</p>
<ul>
<li>突破自身IP访问限制</li>
<li>访问一些单位或团体内部资源</li>
<li>提高访问速度(相对)，代理服务器通常有一个硬盘缓冲区，在多用户访问相同信息时，可以从缓冲区提取信息，提高访问速度</li>
<li>隐藏真实IP</li>
</ul>
</li>
<li><p>分类：</p>
<ul>
<li>按协议分</li>
<li>按匿名程度<ul>
<li>高度匿名：将数据包原封不动地转发，且记录的IP是代理服务器的IP</li>
<li>普通匿名：会在数据包上做一些改动，通常在HTTP头中加入<code>HTTP_VIA</code> 和 <code>HTTP_X_FORWARDED_FOR</code>，服务端可以知晓代理服务器，也有一定几率查到客户端真实IP</li>
<li>透明代理：不但改动数据包，也会告诉服务器端客户端的真实IP，常见的如内网中硬件防火墙</li>
</ul>
</li>
</ul>
</li>
<li><p>常见代理</p>
<ul>
<li>免费代理</li>
<li>付费代理服务</li>
<li>ADSL拨号，拨一次号更换次以IP</li>
</ul>
</li>
</ul>
<h2 id="Json串"><a href="#Json串" class="headerlink" title="Json串"></a>Json串</h2><ul>
<li><p>动态刷新的内容一般为Json串，可以使用request模块的<code>response.json()</code>获取</p>
</li>
<li><p><code>json.dump()</code></p>
<p>将字典类型的数据以Json格式存入文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">json.dump(dict_obj,file,ensure_ascii)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dict_obj</code>：字典类型的数据</li>
<li><code>file</code>：打开的文件描述符</li>
<li><code>ensure_ascii</code>：默认为True，对于非ASCII码，需要设置为<code>False</code></li>
</ul>
</li>
</ul>
<h1 id="爬虫基本原理"><a href="#爬虫基本原理" class="headerlink" title="爬虫基本原理"></a>爬虫基本原理</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ul>
<li>爬虫，就是通过编写程序，<strong>模拟</strong>浏览器上网，让其去<strong>抓取</strong>互联网上数据，简单来说，爬虫就是获取网页并提取和保存信息的自动化程序</li>
</ul>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ul>
<li>获取网页源码</li>
<li>分析网页源码，提取想要的数据，常见的有正则，CSS选择器，Xpath等</li>
<li>保存数据，持久化存储</li>
</ul>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><ul>
<li><p>通用爬虫：搜索引擎的抓取系统的重要组成部分</p>
</li>
<li><p>聚焦爬虫：建立在通用爬虫的基础上，抓取页面中特定的局部内容</p>
</li>
<li><p>增量式爬虫：监测网站中数据更新的情况，只会抓取网站中最新更新的数据</p>
</li>
</ul>
<h3 id="合法性"><a href="#合法性" class="headerlink" title="合法性"></a>合法性</h3><ul>
<li><p>在法律中不被禁止</p>
</li>
<li><p>但具有违法风险</p>
<ul>
<li>善意爬虫：</li>
<li>恶意爬虫：干扰了被访问网站的正常运营；抓取到了受到法律保护的特定类型的数据或信息</li>
</ul>
</li>
<li><p>避免风险</p>
<ul>
<li><p>优化自己的程序，避免干扰访问网站的正常运行</p>
</li>
<li><p>传播爬取到的数据时，审查抓取到的内容，涉及到商业机密等敏感内容时需要及时停止爬取或传播</p>
</li>
</ul>
</li>
</ul>
<h2 id="矛与盾"><a href="#矛与盾" class="headerlink" title="矛与盾"></a>矛与盾</h2><h3 id="反爬机制"><a href="#反爬机制" class="headerlink" title="反爬机制"></a>反爬机制</h3><ul>
<li>通过制定相应的策略或技术手段，防止爬虫程序进行数据的爬取</li>
</ul>
<h3 id="反反爬策略"><a href="#反反爬策略" class="headerlink" title="反反爬策略"></a>反反爬策略</h3><ul>
<li>爬虫程序通过制定相关的策略或技术手段，破解反爬机制</li>
</ul>
<h3 id="robots-txt协议"><a href="#robots-txt协议" class="headerlink" title="robots.txt协议"></a>robots.txt协议</h3><ul>
<li>也成为网络爬虫排除标准</li>
<li>君子协议，规定了网站中不能被爬虫爬取的数据</li>
<li>通常是一个叫作 robots.txt 的文本文件，一般放在网站的根目录下</li>
</ul>
<h3 id="UA伪装"><a href="#UA伪装" class="headerlink" title="UA伪装"></a>UA伪装</h3><ul>
<li><p>UA检测：网站服务器可能基于身份标识进行检测</p>
</li>
<li><p>UA伪装：让爬虫的身份标识伪装为浏览器</p>
</li>
</ul>
<h1 id="基本请求库"><a href="#基本请求库" class="headerlink" title="基本请求库"></a>基本请求库</h1><h2 id="urllib库"><a href="#urllib库" class="headerlink" title="urllib库"></a>urllib库</h2><blockquote>
<p><code>urllib</code>模块出现较早，可以被更高效的<code>requests</code>模块替代</p>
</blockquote>
<ul>
<li>python内置的HTTP请求库，分为四个模块<ul>
<li><code>request</code>：HTTP请求模块</li>
<li><code>error</code>：异常请求模块</li>
<li><code>parse</code>：工具模块，主要提供URL处理方法</li>
<li><code>robotparser</code>：用于识别robots.txt文件，使用较少</li>
</ul>
</li>
</ul>
<h3 id="发送请求-request模块"><a href="#发送请求-request模块" class="headerlink" title="发送请求(request模块)"></a>发送请求(request模块)</h3><ul>
<li><p><code>urlopen</code></p>
<blockquote>
<p><code>urlopen</code>文档：<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/urllib.request.html">https://docs.python.org/3/library/urllib.request.html</a></p>
</blockquote>
<p>提供了最基本的HTTP请求方法，还带有处理授权验证，重定向，Cookie等功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line">data = <span class="built_in">bytes</span>(urllib.parse.urlencode(&#123;<span class="string">&#x27;&#x27;</span>:<span class="string">&#x27;&#x27;</span>&#125;, encoding=<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">response = urllib.request.urlopen(url, data=data. timeout=)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>response</code>：<code>urlopen</code>返回一个<code>HTTPResponse</code>对象，包含<code>read</code>，<code>readinto</code>，<code>getheader</code>，<code>getheaders</code>，<code>fileno</code>等方法，以及<code>msg</code>，<code>ersion</code>，<code>status</code>，<code>reason</code>，<code>debuglevel</code>，<code>closed</code>属性</p>
</li>
<li><p><code>data</code>：bytes类型的请求数据(需要用<code>bytes</code>方法转换，要先用<code>urlencode</code>方法将字典转换为字符串)，设置后，请求方式为POST</p>
</li>
<li><p><code>timeout</code>：设置超时时间，超时就会抛出<code>urllib.error.URLError</code>错误，可以使用<code>reason</code>方法查看，<code>try-except</code>捕获</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line"><span class="keyword">import</span> urllib.request  </span><br><span class="line"><span class="keyword">import</span> urllib.error  </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:  </span><br><span class="line">    response = urllib.request.urlopen(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, timeout=<span class="number">0.1</span>)  </span><br><span class="line"><span class="keyword">except</span> urllib.error.URLError <span class="keyword">as</span> e:  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(e.reason, socket.timeout):  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;TIME OUT&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>context</code>：用于指定SSL设置，必须为<code>ssl.SSSLContext</code>类型</p>
</li>
<li><p><code>cafile</code>和<code>capath</code>：指定CA证书和路径</p>
</li>
</ul>
</li>
<li><p><code>Request</code></p>
<p><code>Request</code>类可以为请求加入Headers等信息，可以直接作为<code>urlopen</code>的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request  </span><br><span class="line"></span><br><span class="line">request = urllib.request.Request(<span class="string">&#x27;https://python.org&#x27;</span>)  </span><br><span class="line">response = urllib.request.urlopen(request)  </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">urllib</span>.request.Request(url, data=<span class="literal">None</span>, headers=&#123;&#125;, origin_req_host=<span class="literal">None</span>, unverifiable=<span class="literal">False</span>, method=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>url</code>：指定请求的url</p>
</li>
<li><p><code>data</code>：必须为<code>bytes</code>类型，如果为字典，先用<code>urllib.parse.urlencode()</code>进行编码再转换为<code>bytes</code>类型</p>
</li>
<li><p><code>headers</code>：字典类型，即请求头</p>
<blockquote>
<p><code>headers</code>可以使用<code>Request</code>的<code>add_headers</code>添加，参数为两个字符串</p>
</blockquote>
</li>
<li><p><code>origin_req_host</code>：请求的host名称或IP</p>
</li>
<li><p><code>unverifiable</code>：请求是否无法验证，即用户是否有权限接受请求的结果，默认为<code>False</code></p>
</li>
<li><p><code>nethod</code>：指定请求的方法</p>
</li>
</ul>
</li>
<li><p><code>Handler</code>类</p>
<p><code>urllib.request</code>中<code>Handler</code>类是各种处理器，可以用于处理登陆验证，Cookies等</p>
<ul>
<li><p><code>BaseHandler</code>：其它<code>Handler</code>的父类，提供最基本的方法</p>
</li>
<li><p><code>HTTPRedirectHandler</code>：用于处理重定向</p>
</li>
<li><p><code>HTTPCookieProcessor</code>：用于处理Cookies</p>
<p>更多可以参阅：<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/urllib.request.html#urllib.request.BaseHandler">https://docs.python.org/3/library/urllib.request.html#urllib.request.BaseHandler</a></p>
</li>
</ul>
</li>
<li><p><code>OpenerDirector</code>类</p>
<p><code>OpenerDirector</code>类也叫Opener，可以实现更高级的功能，<code>urlopen</code>就是<code>urllib</code>提供的一个Opener，需要借助<code>Handler</code>构建Opener</p>
<ul>
<li><p>验证</p>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/3-2.jpg" alt="3-2"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> HTTPPasswordMgrWithDefaultRealm, HTTPBasicAuthHandler, build_opener  </span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError  </span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;username&#x27;</span>  </span><br><span class="line">password = <span class="string">&#x27;password&#x27;</span>  </span><br><span class="line">url = <span class="string">&#x27;http://localhost:5000/&#x27;</span>  </span><br><span class="line"></span><br><span class="line">p = HTTPPasswordMgrWithDefaultRealm()  </span><br><span class="line">p.add_password(<span class="literal">None</span>, url, username, password)  </span><br><span class="line">auth_handler = HTTPBasicAuthHandler(p)  </span><br><span class="line">opener = build_opener(auth_handler)  </span><br><span class="line"></span><br><span class="line">result = opener.<span class="built_in">open</span>(url)</span><br></pre></td></tr></table></figure>

<p>最基本的验证界面可以用<code>HTTPBasicAuthHandler</code>完成：</p>
<ul>
<li><p>首先实例化一个<code>HTTPBasicAuthHandler</code>对象，参数为<code>HTTPPasswordMgrWithDefaultRealm</code>对象，使用<code>add_password</code>方法加入用户名和密码，由此建立一个处理验证的<code>Handler</code>对象</p>
</li>
<li><p>其次，将<code>Handler</code>作为参数使用<code>build_opener</code>创建Opener</p>
</li>
<li><p>最后，使用<code>open</code>方法进行请求</p>
</li>
</ul>
</li>
<li><p>代理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError  </span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener  </span><br><span class="line"></span><br><span class="line">proxy_handler = ProxyHandler(&#123;  </span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:9743&#x27;</span>,  </span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://127.0.0.1:9743&#x27;</span>  </span><br><span class="line">&#125;)  </span><br><span class="line">opener = build_opener(proxy_handler)  </span><br></pre></td></tr></table></figure>

<p>代理可以使用<code>ProxyHandler</code>来构建Opener</p>
</li>
<li><p>Cookies</p>
<p>生成Cookie必须先声明一个<code>CookieJar</code>对象，然后使用<code>HTTPCookieProcessor</code>构建<code>Handler</code>，再构建Opener，如果要存入文件，可以使用<code>MozillaCookieJar</code>或<code>LWPCookieJar</code>，两者存储格式不同</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http.cookiejar, urllib.request  </span><br><span class="line"></span><br><span class="line">cookie = http.cookiejar.CookieJar() </span><br><span class="line"><span class="comment"># filename = &#x27;cookies.txt&#x27;  </span></span><br><span class="line"><span class="comment"># cookie = http.cookiejar.MozillaCookieJar(filename)  </span></span><br><span class="line">handler = urllib.request.HTTPCookieProcessor(cookie)  </span><br><span class="line">opener = urllib.request.build_opener(handler)</span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">&#x27;http://www.baidu.com&#x27;</span>)</span><br><span class="line"><span class="comment"># cookie.save(ignore_discard=True, ignore_expires=True)</span></span><br></pre></td></tr></table></figure>

<p>读取Cookie也需要使用对应格式的类生成<code>CookieJar</code>对象，其余与生成时类似</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cookie = http.cookiejar.LWPCookieJar()  </span><br><span class="line">cookie.load(<span class="string">&#x27;cookies.txt&#x27;</span>, ignore_discard=<span class="literal">True</span>, ignore_expires=<span class="literal">True</span>)  </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="处理异常-error模块"><a href="#处理异常-error模块" class="headerlink" title="处理异常(error模块)"></a>处理异常(error模块)</h3><p><code>error</code>模块定义了<code>requests</code>模块产生的异常，出现问题便会抛出</p>
<ul>
<li><p><code>URLError</code></p>
<p>继承自<code>OSError</code>类，是<code>error</code>模块的基类，由<code>request</code>模块产生的异常都可以用<code>URLError</code>捕获</p>
<ul>
<li><p><code>reason</code>属性</p>
<p><code>reason</code>属性包含了返回错误的原因，有时可能为对象，例如超时为<code>socket.timeout</code>对象</p>
</li>
</ul>
</li>
<li><p><code>HTTPError</code></p>
<p>专用于处理HTTP请求错误</p>
<ul>
<li><code>code</code>：包含HTTP状态码</li>
<li><code>reason</code>：与父类相同</li>
<li><code>headers</code>：返回请求头</li>
</ul>
</li>
</ul>
<h3 id="解析链接-parse模块"><a href="#解析链接-parse模块" class="headerlink" title="解析链接(parse模块)"></a>解析链接(parse模块)</h3><p><code>parse</code>模块用于处理URL</p>
<ul>
<li><p><code>urlparse</code>方法</p>
<p>用于拆解标准的URL，返回拆解后的类(实际上为元组，但可以同时使用索引和属性)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urllib.parse.urlparse(urlstring, scheme=<span class="string">&#x27;&#x27;</span>, allow_fragments=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>urlstring</code>：待解析的URL</li>
<li><code>scheme</code>：指定默认协议，如果链接没有携带协议信息，会使用默认协议</li>
<li><code>allow_fragments</code>：是否解析fragments，如果为<code>False</code>，则fragments会被解析为path、parameters 或者 query 的一部分</li>
</ul>
</li>
<li><p><code>urlunparse</code>方法</p>
<p><code>urlparse</code>方法的反方法，接受URL的6个参数的可迭代对象(长度必须为6)，拼接为URL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlunparse  </span><br><span class="line"></span><br><span class="line">data = [<span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;www.baidu.com&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;a=6&#x27;</span>, <span class="string">&#x27;comment&#x27;</span>] </span><br><span class="line"><span class="built_in">print</span>(urlunparse(data))</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>urlsplit</code>方法</p>
<p>与<code>urlparse</code>类似，但将params合并到path中，返回5个参数</p>
</li>
<li><p><code>urlunsplit</code>方法</p>
<p>与<code>urlunparse</code>，但也是5个参数</p>
</li>
<li><p><code>urljoin</code>方法</p>
<p>与<code>urlunparse</code>和<code>urlunsplit</code>类似，生成链接</p>
</li>
<li><p><code>urlencode</code>方法</p>
<p>构造GET请求参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode  </span><br><span class="line"></span><br><span class="line">params = &#123;  </span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>,  </span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">22</span>  </span><br><span class="line">&#125;  </span><br><span class="line">base_url = <span class="string">&#x27;http://www.baidu.com?&#x27;</span>  </span><br><span class="line">url = base_url + urlencode(params)  </span><br></pre></td></tr></table></figure>
</li>
<li><p><code>parse_qs</code>方法</p>
<p><code>urlencode</code>的反方法，获取url的GET请求的参数，返回为字典</p>
</li>
<li><p><code>parse_qsl</code>方法</p>
<p>同上，但返回值为元组组成的列表，元组第一个参数为参数名，第二个值为参数值</p>
</li>
<li><p><code>quote</code>方法</p>
<p>对URL进行编码(在URL中只能出现ASCII类型的安全字符)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote  </span><br><span class="line"></span><br><span class="line">keyword = <span class="string">&#x27; 壁纸 &#x27;</span>  </span><br><span class="line">url = <span class="string">&#x27;https://www.baidu.com/s?wd=&#x27;</span> + quote(keyword)  </span><br></pre></td></tr></table></figure>
</li>
<li><p><code>unquote</code>方法</p>
<p><code>quote</code>的反方法，对URL进行解码</p>
</li>
</ul>
<h3 id="分析Robots协议-tobotparser模块"><a href="#分析Robots协议-tobotparser模块" class="headerlink" title="分析Robots协议(tobotparser模块)"></a>分析Robots协议(tobotparser模块)</h3><ul>
<li><p><code>RobotFileParser</code>类</p>
<p>根据网站的robots.txt文件判断爬虫是否有权限爬取页面</p>
<ul>
<li><p>声明：可以在声明时传入robots.txt的链接，也可以使用<code>set_url()</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urllib.robotparser.RobotFileParser(url=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>set_url()</code>：设置robots.txt文件的链接</p>
</li>
<li><p><code>read()</code>：读取robots.txt文件并进行分析，在进行判断前，需要执行，否则其它判断都会为False</p>
</li>
<li><p><code>parse()</code>：解析robots.txt文件，传入文件某些行的内容，根据语法进行解析</p>
</li>
<li><p><code>can_fetch()</code>：传入User-Agent和要抓取的URL，判断是否能抓取</p>
</li>
<li><p><code>mtime()</code>：返回上次抓取和分析robot.txt文件的时间，主要用于定期检查抓取最新的robots.txt</p>
</li>
<li><p><code>modified()</code>：将当前时间设置为上次抓取和分析robots.txt的时间</p>
</li>
</ul>
</li>
</ul>
<h2 id="requests模块"><a href="#requests模块" class="headerlink" title="requests模块"></a>requests模块</h2><ul>
<li>python中原生的基于网络请求的模块</li>
<li>作用：模拟浏览器发送请求</li>
</ul>
<h3 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> request</span><br></pre></td></tr></table></figure>

<h3 id="浏览器请求过程-requests模块的编码流程"><a href="#浏览器请求过程-requests模块的编码流程" class="headerlink" title="浏览器请求过程(requests模块的编码流程)"></a>浏览器请求过程(requests模块的编码流程)</h3><ul>
<li><p>指定url</p>
<blockquote>
<p>requests中会自动对url进行编码</p>
</blockquote>
</li>
<li><p>UA伪装</p>
</li>
<li><p>发起请求</p>
</li>
<li><p>获取响应数据</p>
</li>
<li><p>数据解析</p>
</li>
<li><p>持久化存储</p>
</li>
</ul>
<h3 id="GET请求"><a href="#GET请求" class="headerlink" title="GET请求"></a>GET请求</h3><ul>
<li><p><code>requests.get()</code></p>
<p>对指定url发起get请求，在请求过程中会自动对参数进行处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.get(url,params,headers)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>url</code>：发起请求的url(字符串，可以直接带参数)</li>
<li><code>params</code>：url携带的参数(字典)</li>
<li><code>headers</code>：所使用的头信息(字典)</li>
</ul>
</li>
<li><p>响应对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">response.text			<span class="comment"># 获取字符串类型的响应数据</span></span><br><span class="line">response.json()			<span class="comment"># 获取Json类型的响应数据，生成字典</span></span><br><span class="line">response.content		<span class="comment"># 获取二进制形式的响应数据</span></span><br><span class="line"></span><br><span class="line">response.status_code	<span class="comment"># 获取响应状态码</span></span><br><span class="line">response.headers		<span class="comment"># 获取响应头</span></span><br><span class="line">response.cookies		<span class="comment"># 获取cookies</span></span><br><span class="line">response.url			<span class="comment"># 获取URL</span></span><br><span class="line">response.history		<span class="comment"># 获取请求历史</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>若调用<code>json()</code>方法时，返回结果不是json格式，会抛出<code>json.decoder.JSONDecodeError</code>异常</p>
</blockquote>
<p><code>request</code>提供了内置的状态码查询对象<code>requests.codes</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 信息性状态码  </span></span><br><span class="line"><span class="number">100</span>: (<span class="string">&#x27;continue&#x27;</span>,),  </span><br><span class="line"><span class="number">101</span>: (<span class="string">&#x27;switching_protocols&#x27;</span>,),  </span><br><span class="line"><span class="number">102</span>: (<span class="string">&#x27;processing&#x27;</span>,),  </span><br><span class="line"><span class="number">103</span>: (<span class="string">&#x27;checkpoint&#x27;</span>,),  </span><br><span class="line"><span class="number">122</span>: (<span class="string">&#x27;uri_too_long&#x27;</span>, <span class="string">&#x27;request_uri_too_long&#x27;</span>),  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 成功状态码  </span></span><br><span class="line"><span class="number">200</span>: (<span class="string">&#x27;ok&#x27;</span>, <span class="string">&#x27;okay&#x27;</span>, <span class="string">&#x27;all_ok&#x27;</span>, <span class="string">&#x27;all_okay&#x27;</span>, <span class="string">&#x27;all_good&#x27;</span>, <span class="string">&#x27;\\o/&#x27;</span>, <span class="string">&#x27;✓&#x27;</span>),  </span><br><span class="line"><span class="number">201</span>: (<span class="string">&#x27;created&#x27;</span>,),  </span><br><span class="line"><span class="number">202</span>: (<span class="string">&#x27;accepted&#x27;</span>,),  </span><br><span class="line"><span class="number">203</span>: (<span class="string">&#x27;non_authoritative_info&#x27;</span>, <span class="string">&#x27;non_authoritative_information&#x27;</span>),  </span><br><span class="line"><span class="number">204</span>: (<span class="string">&#x27;no_content&#x27;</span>,),  </span><br><span class="line"><span class="number">205</span>: (<span class="string">&#x27;reset_content&#x27;</span>, <span class="string">&#x27;reset&#x27;</span>),  </span><br><span class="line"><span class="number">206</span>: (<span class="string">&#x27;partial_content&#x27;</span>, <span class="string">&#x27;partial&#x27;</span>),  </span><br><span class="line"><span class="number">207</span>: (<span class="string">&#x27;multi_status&#x27;</span>, <span class="string">&#x27;multiple_status&#x27;</span>, <span class="string">&#x27;multi_stati&#x27;</span>, <span class="string">&#x27;multiple_stati&#x27;</span>),  </span><br><span class="line"><span class="number">208</span>: (<span class="string">&#x27;already_reported&#x27;</span>,),  </span><br><span class="line"><span class="number">226</span>: (<span class="string">&#x27;im_used&#x27;</span>,),  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 重定向状态码  </span></span><br><span class="line"><span class="number">300</span>: (<span class="string">&#x27;multiple_choices&#x27;</span>,),  </span><br><span class="line"><span class="number">301</span>: (<span class="string">&#x27;moved_permanently&#x27;</span>, <span class="string">&#x27;moved&#x27;</span>, <span class="string">&#x27;\\o-&#x27;</span>),  </span><br><span class="line"><span class="number">302</span>: (<span class="string">&#x27;found&#x27;</span>,),  </span><br><span class="line"><span class="number">303</span>: (<span class="string">&#x27;see_other&#x27;</span>, <span class="string">&#x27;other&#x27;</span>),  </span><br><span class="line"><span class="number">304</span>: (<span class="string">&#x27;not_modified&#x27;</span>,),  </span><br><span class="line"><span class="number">305</span>: (<span class="string">&#x27;use_proxy&#x27;</span>,),  </span><br><span class="line"><span class="number">306</span>: (<span class="string">&#x27;switch_proxy&#x27;</span>,),  </span><br><span class="line"><span class="number">307</span>: (<span class="string">&#x27;temporary_redirect&#x27;</span>, <span class="string">&#x27;temporary_moved&#x27;</span>, <span class="string">&#x27;temporary&#x27;</span>),  </span><br><span class="line"><span class="number">308</span>: (<span class="string">&#x27;permanent_redirect&#x27;</span>,  </span><br><span class="line">      <span class="string">&#x27;resume_incomplete&#x27;</span>, <span class="string">&#x27;resume&#x27;</span>,), <span class="comment"># These 2 to be removed in 3.0  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端错误状态码  </span></span><br><span class="line"><span class="number">400</span>: (<span class="string">&#x27;bad_request&#x27;</span>, <span class="string">&#x27;bad&#x27;</span>),  </span><br><span class="line"><span class="number">401</span>: (<span class="string">&#x27;unauthorized&#x27;</span>,),  </span><br><span class="line"><span class="number">402</span>: (<span class="string">&#x27;payment_required&#x27;</span>, <span class="string">&#x27;payment&#x27;</span>),  </span><br><span class="line"><span class="number">403</span>: (<span class="string">&#x27;forbidden&#x27;</span>,),  </span><br><span class="line"><span class="number">404</span>: (<span class="string">&#x27;not_found&#x27;</span>, <span class="string">&#x27;-o-&#x27;</span>),  </span><br><span class="line"><span class="number">405</span>: (<span class="string">&#x27;method_not_allowed&#x27;</span>, <span class="string">&#x27;not_allowed&#x27;</span>),  </span><br><span class="line"><span class="number">406</span>: (<span class="string">&#x27;not_acceptable&#x27;</span>,),  </span><br><span class="line"><span class="number">407</span>: (<span class="string">&#x27;proxy_authentication_required&#x27;</span>, <span class="string">&#x27;proxy_auth&#x27;</span>, <span class="string">&#x27;proxy_authentication&#x27;</span>),  </span><br><span class="line"><span class="number">408</span>: (<span class="string">&#x27;request_timeout&#x27;</span>, <span class="string">&#x27;timeout&#x27;</span>),  </span><br><span class="line"><span class="number">409</span>: (<span class="string">&#x27;conflict&#x27;</span>,),  </span><br><span class="line"><span class="number">410</span>: (<span class="string">&#x27;gone&#x27;</span>,),  </span><br><span class="line"><span class="number">411</span>: (<span class="string">&#x27;length_required&#x27;</span>,),  </span><br><span class="line"><span class="number">412</span>: (<span class="string">&#x27;precondition_failed&#x27;</span>, <span class="string">&#x27;precondition&#x27;</span>),  </span><br><span class="line"><span class="number">413</span>: (<span class="string">&#x27;request_entity_too_large&#x27;</span>,),  </span><br><span class="line"><span class="number">414</span>: (<span class="string">&#x27;request_uri_too_large&#x27;</span>,),  </span><br><span class="line"><span class="number">415</span>: (<span class="string">&#x27;unsupported_media_type&#x27;</span>, <span class="string">&#x27;unsupported_media&#x27;</span>, <span class="string">&#x27;media_type&#x27;</span>),  </span><br><span class="line"><span class="number">416</span>: (<span class="string">&#x27;requested_range_not_satisfiable&#x27;</span>, <span class="string">&#x27;requested_range&#x27;</span>, <span class="string">&#x27;range_not_satisfiable&#x27;</span>),  </span><br><span class="line"><span class="number">417</span>: (<span class="string">&#x27;expectation_failed&#x27;</span>,),  </span><br><span class="line"><span class="number">418</span>: (<span class="string">&#x27;im_a_teapot&#x27;</span>, <span class="string">&#x27;teapot&#x27;</span>, <span class="string">&#x27;i_am_a_teapot&#x27;</span>),  </span><br><span class="line"><span class="number">421</span>: (<span class="string">&#x27;misdirected_request&#x27;</span>,),  </span><br><span class="line"><span class="number">422</span>: (<span class="string">&#x27;unprocessable_entity&#x27;</span>, <span class="string">&#x27;unprocessable&#x27;</span>),  </span><br><span class="line"><span class="number">423</span>: (<span class="string">&#x27;locked&#x27;</span>,),  </span><br><span class="line"><span class="number">424</span>: (<span class="string">&#x27;failed_dependency&#x27;</span>, <span class="string">&#x27;dependency&#x27;</span>),  </span><br><span class="line"><span class="number">425</span>: (<span class="string">&#x27;unordered_collection&#x27;</span>, <span class="string">&#x27;unordered&#x27;</span>),  </span><br><span class="line"><span class="number">426</span>: (<span class="string">&#x27;upgrade_required&#x27;</span>, <span class="string">&#x27;upgrade&#x27;</span>),  </span><br><span class="line"><span class="number">428</span>: (<span class="string">&#x27;precondition_required&#x27;</span>, <span class="string">&#x27;precondition&#x27;</span>),  </span><br><span class="line"><span class="number">429</span>: (<span class="string">&#x27;too_many_requests&#x27;</span>, <span class="string">&#x27;too_many&#x27;</span>),  </span><br><span class="line"><span class="number">431</span>: (<span class="string">&#x27;header_fields_too_large&#x27;</span>, <span class="string">&#x27;fields_too_large&#x27;</span>),  </span><br><span class="line"><span class="number">444</span>: (<span class="string">&#x27;no_response&#x27;</span>, <span class="string">&#x27;none&#x27;</span>),  </span><br><span class="line"><span class="number">449</span>: (<span class="string">&#x27;retry_with&#x27;</span>, <span class="string">&#x27;retry&#x27;</span>),  </span><br><span class="line"><span class="number">450</span>: (<span class="string">&#x27;blocked_by_windows_parental_controls&#x27;</span>, <span class="string">&#x27;parental_controls&#x27;</span>),  </span><br><span class="line"><span class="number">451</span>: (<span class="string">&#x27;unavailable_for_legal_reasons&#x27;</span>, <span class="string">&#x27;legal_reasons&#x27;</span>),  </span><br><span class="line"><span class="number">499</span>: (<span class="string">&#x27;client_closed_request&#x27;</span>,),  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端错误状态码  </span></span><br><span class="line"><span class="number">500</span>: (<span class="string">&#x27;internal_server_error&#x27;</span>, <span class="string">&#x27;server_error&#x27;</span>, <span class="string">&#x27;/o\\&#x27;</span>, <span class="string">&#x27;✗&#x27;</span>),  </span><br><span class="line"><span class="number">501</span>: (<span class="string">&#x27;not_implemented&#x27;</span>,),  </span><br><span class="line"><span class="number">502</span>: (<span class="string">&#x27;bad_gateway&#x27;</span>,),  </span><br><span class="line"><span class="number">503</span>: (<span class="string">&#x27;service_unavailable&#x27;</span>, <span class="string">&#x27;unavailable&#x27;</span>),  </span><br><span class="line"><span class="number">504</span>: (<span class="string">&#x27;gateway_timeout&#x27;</span>,),  </span><br><span class="line"><span class="number">505</span>: (<span class="string">&#x27;http_version_not_supported&#x27;</span>, <span class="string">&#x27;http_version&#x27;</span>),  </span><br><span class="line"><span class="number">506</span>: (<span class="string">&#x27;variant_also_negotiates&#x27;</span>,),  </span><br><span class="line"><span class="number">507</span>: (<span class="string">&#x27;insufficient_storage&#x27;</span>,),  </span><br><span class="line"><span class="number">509</span>: (<span class="string">&#x27;bandwidth_limit_exceeded&#x27;</span>, <span class="string">&#x27;bandwidth&#x27;</span>),  </span><br><span class="line"><span class="number">510</span>: (<span class="string">&#x27;not_extended&#x27;</span>,),  </span><br><span class="line"><span class="number">511</span>: (<span class="string">&#x27;network_authentication_required&#x27;</span>, <span class="string">&#x27;network_auth&#x27;</span>, <span class="string">&#x27;network_authentication&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>例如判断响应是否成功可以使用<code>requests.codes.ok</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> r.status_code == requests.codes.ok:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h3><ul>
<li><p><code>requests.post()</code></p>
<p>对指定url发起post请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requests.pose(url,data,headers)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>url</code>：post请求的url(字符串)</p>
</li>
<li><p><code>data</code>：请求的参数(字典)</p>
</li>
<li><p><code>headers</code>：所使用的头信息(字典)</p>
</li>
</ul>
<blockquote>
<p>注意POST请求中参数变为<code>data</code></p>
</blockquote>
</li>
</ul>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;favicon.ico&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line">r = requests.post(<span class="string">&#x27;http://httpbin.org/post&#x27;</span>, files=files)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上传文件的返回值中，会包含file字段，而不使用from字段</p>
</blockquote>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><ul>
<li><p>获取cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response.cookies</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> r.cookies.items():	<span class="comment"># 也可以使用items方法遍历</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>携带cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookies&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以使用<code>RequestsCookieJar</code>对象构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jar = requests.cookies.RequestsCookieJar()</span><br><span class="line">jar.<span class="built_in">set</span>(key, value)</span><br><span class="line">requests.get(url, cookie=jar)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="会话维持"><a href="#会话维持" class="headerlink" title="会话维持"></a>会话维持</h3><p>每一次get或post请求实际上相当于不同的会话，如果需要会话维持(例如登陆后获取用户信息)可以采用以下两种方法</p>
<ul>
<li><p>请求时设置相同的cookies值</p>
</li>
<li><p>使用<code>Session</code>对象</p>
<p><code>Session</code>对象会保持同一个会话，且不同用户手动设置cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.get()</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="SSL证书验证"><a href="#SSL证书验证" class="headerlink" title="SSL证书验证"></a>SSL证书验证</h3><p>在发送请求时，可以使用<code>verify</code>参数设定是否检查证书，默认为<code>True</code></p>
<p>如果请求一个HTTPS站点，且证书验证错误，则会抛出<code>requests.excceptions.SSLError</code>异常</p>
<p>也可以在请求时使用<code>cert</code>参数指定本地证书，可以是单个文件（包含密钥和证书）或一个包含两个文件路径的元组</p>
<blockquote>
<p>注意私有证书的key必须是解密状态，不支持加密</p>
</blockquote>
<h3 id="代理-1"><a href="#代理-1" class="headerlink" title="代理"></a>代理</h3><p>可以使用<code>proxies</code>参数设置代理进行请求</p>
<blockquote>
<p><code>request</code>可以使用http代理和socks代理，socks代理可以代理http</p>
</blockquote>
<h3 id="超时设置"><a href="#超时设置" class="headerlink" title="超时设置"></a>超时设置</h3><p>使用<code>timeout</code>设置超时时间，请求时间分为连接时间和读取时间，传入元组可以分别设置</p>
<p><code>timeout</code>默认为<code>None</code>，即永远不会超时</p>
<h3 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h3><p><code>requests</code>也像<code>urllib</code>自带身份认证，可以使用<code>HTTPBasicAuth</code>类，简略写法可以省去，传入一个元组，<code>requests</code>会自动调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests  </span><br><span class="line"><span class="keyword">from</span> requests.auth <span class="keyword">import</span> HTTPBasicAuth  </span><br><span class="line"></span><br><span class="line">r = requests.get(<span class="string">&#x27;http://localhost:5000&#x27;</span>, auth=HTTPBasicAuth(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>))  </span><br><span class="line">r = requests.get(<span class="string">&#x27;http://localhost:5000&#x27;</span>, auth=(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>OAuth 认证可以参考<a target="_blank" rel="noopener" href="https://requests-oauthlib.readthedocs.org/">https://requests-oauthlib.readthedocs.org/</a></p>
<h3 id="Prepared-Request类"><a href="#Prepared-Request类" class="headerlink" title="Prepared Request类"></a>Prepared Request类</h3><p><code>urllib</code>可以构造<code>Request</code>对象进行请求，<code>requests</code>也有相同功能，叫做<code>Prepared Request</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> Request, Session</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://httpbin.org/post&#x27;</span></span><br><span class="line">data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>&#125;</span><br><span class="line">headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">s = Session()</span><br><span class="line">req = Request(<span class="string">&#x27;POST&#x27;</span>, url, data=data, headers=headers)</span><br><span class="line">prepped = s.prepare_request(req)</span><br><span class="line">r = s.send(prepped)</span><br></pre></td></tr></table></figure>

<p><code>prepare_request</code>使用<code>Session</code>的<code>prepare_request</code>方法构造，调用<code>send()</code>方法发送</p>
<blockquote>
<p><code>Request</code>对象可以将请求视为独立的对象，在构造队列调度时非常方便</p>
</blockquote>
<h1 id="数据解析"><a href="#数据解析" class="headerlink" title="数据解析"></a>数据解析</h1><h2 id="分类-1"><a href="#分类-1" class="headerlink" title="分类"></a>分类</h2><ul>
<li><p>正则</p>
</li>
<li><p>bs4</p>
</li>
<li><p><em><strong>xpath</strong></em></p>
</li>
<li><p>pyquery</p>
</li>
</ul>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul>
<li>解析的局部文本内容都会在标签之间或标签的属性中存储</li>
<li>步骤：<ul>
<li>指定标签的定位</li>
<li>标签或标签对应属性中存储的数据值进行提取</li>
</ul>
</li>
</ul>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><blockquote>
<p><a target="_blank" rel="noopener" href="http://tool.oschina.net/regex/">正则表达式测试工具</a></p>
</blockquote>
<h3 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h3><ul>
<li><p>单字符</p>
<ul>
<li><p><code>. </code>：除换行符外的任意一个字符</p>
</li>
<li><p><code>[] </code>：匹配集合中任意一个字符</p>
</li>
<li><p><code>[^]</code>：匹配不在集合中的一个字符</p>
</li>
<li><p><code>\d</code> ：匹配一个数字</p>
</li>
<li><p><code>\w</code> ：匹配一个数字，字母，下划线，中文</p>
</li>
<li><p><code>\s</code> ：所有的空白字符，包括空格，制表符，换页符等。等价于<code>[ \f\n\r\t\v]</code></p>
<blockquote>
<p>以上存在大写取反</p>
</blockquote>
</li>
<li><p><code>\t</code>：匹配制表符</p>
</li>
<li><p><code>\n</code>：匹配换行符</p>
</li>
</ul>
</li>
<li><p>数量修饰</p>
<ul>
<li><p><code>*</code> ：0或任意次</p>
</li>
<li><p><code>+</code>：至少一次</p>
</li>
<li><p><code>?</code> ：0或1次，非贪婪模式</p>
</li>
<li><p><code>&#123;m&#125;</code>：固定m次</p>
</li>
<li><p><code>&#123;m,&#125; </code>：至少m次</p>
</li>
<li><p><code>&#123;m,n&#125;</code>：m-n次</p>
</li>
</ul>
</li>
<li><p>边界</p>
<ul>
<li><p><code>$</code> ：匹配开头</p>
</li>
<li><p><code>^ </code>：匹配结尾</p>
</li>
<li><p><code>\A</code>：匹配字符串开头</p>
</li>
<li><p><code>\Z</code>：匹配字符串结尾，不匹配换行</p>
</li>
<li><p><code>\z</code>：匹配字符串结尾，匹配换行</p>
</li>
<li><p><code>\G</code>：匹配最后匹配完成的位置</p>
</li>
</ul>
</li>
<li><p>分组</p>
<ul>
<li><p><code>(ab)</code></p>
<blockquote>
<p>使用()可以指明需要提取的对象</p>
</blockquote>
</li>
</ul>
</li>
<li><p>贪婪模式</p>
<ul>
<li><p>贪婪模式：使用<code>.*</code>，会匹配尽可能多的内容</p>
</li>
<li><p>非贪婪模式：使用<code>.*?</code>，匹配尽可能少的内容</p>
<blockquote>
<p>注意如果<code>.*?</code>在结尾可能匹配不到内容</p>
</blockquote>
</li>
</ul>
</li>
<li><p>转义</p>
<p>如果匹配用于正则中的字符，需要加<code>\</code>进行转义</p>
</li>
</ul>
<h3 id="参数-拓展正则"><a href="#参数-拓展正则" class="headerlink" title="参数(拓展正则)"></a>参数(拓展正则)</h3><ul>
<li><p><code>re.I</code>：忽略大小写</p>
</li>
<li><p><code>re.M</code>：多行匹配，影响^和$</p>
</li>
<li><p><code>re.S</code>：使.能匹配换行符在内的所有字符</p>
<blockquote>
<p>由于HTML中大多有换行符，因此尽量加上<code>re.S</code></p>
</blockquote>
</li>
</ul>
<h3 id="re模块"><a href="#re模块" class="headerlink" title="re模块"></a><code>re</code>模块</h3><ul>
<li><p><code>re.match()</code></p>
<p>从开头检测正则是否匹配字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.<span class="keyword">match</span>(regex, content)</span><br></pre></td></tr></table></figure>

<p>返回一个<code>SRE_Match </code>对象，<code>group()</code>方法可以获取匹配到的内容(如果有分组则传入<code>index</code>参数获取第几个分组)，<code>span()</code>可以获取匹配的范围</p>
<p>无匹配结果返回<code>None</code></p>
</li>
<li><p><code>re.search()</code></p>
<p>匹配第一个符合的内容，返回匹配对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.search(pattern, string, flag)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为了保证匹配结果，可以尽量使用<code>search()</code>代替<code>match()</code></p>
</blockquote>
</li>
<li><p><code>re.findall()</code></p>
<p>返回匹配的列表内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.findall(pattern, string, flag)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>re.sub()</code></p>
<p>替换匹配到的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.sub(pattern, replace, string, <span class="built_in">max</span>, flag)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>max</code>：最多替换次数，默认为全部</li>
</ul>
</li>
<li><p><code>re.split()</code></p>
<p>用正则表达式切割字符串，返回为列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.split(pattern, string, flag)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>re.compile()</code></p>
<p>生成正则表达式对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regex = re.<span class="built_in">compile</span>(pattern, flag)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>pattern</code>：正则表达式</li>
<li><code>flags</code>：功能标志位，拓展正则表达式</li>
</ul>
</li>
<li><p><code>regex.findall()</code></p>
<p>用正则表达式对象匹配字符串内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regex.findall(string, pos, endpos)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>pos</code>，<code>endpos</code>：起始和结束的位置</li>
</ul>
</li>
<li><p><code>re.split()</code></p>
<p>用正则表达式切割字符串，返回为列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.split(pattern, string, flag)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="bs4解析-python独有"><a href="#bs4解析-python独有" class="headerlink" title="bs4解析(python独有)"></a>bs4解析(python独有)</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>bs4会将html文档转换为一个树形结构，每个节点对应一个标签或内容，对应一个python对象，可以分为4类：</p>
<ul>
<li><code>tag</code>：所有html标签可以视为tag对象</li>
<li><code>navigableString</code>：字符串类，标签中的文本内容</li>
<li><code>beautifulSoup</code>：一个html文档的全部内容，根节点，特殊的tag对象</li>
<li><code>comment</code>：html中的注释和特殊字符串，特殊的<code>navigableString</code></li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ul>
<li>实例化一个<code>BeautifulSoup</code>对象，并将页面源码加载到该对象中</li>
<li>通过调用<code>BeautifulSoup</code>对象的相关属性和方法进行数据提取</li>
</ul>
<h3 id="环境安装-1"><a href="#环境安装-1" class="headerlink" title="环境安装"></a>环境安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install bs4</span><br><span class="line">pip install lxml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>lxml为bs4支持的解析器之一，支持解析HTML和XML，速度快，容错率高，推荐使用</p>
</blockquote>
<h3 id="BeautifulSoup"><a href="#BeautifulSoup" class="headerlink" title="BeautifulSoup"></a>BeautifulSoup</h3><ul>
<li><p>实例化</p>
<ul>
<li>&#96;&#96;&#96;python<br>soup &#x3D; BeautifulSoup(fp, ‘lxml’)<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  将本地的html文件加载到该对象中，使用lxml解析器</span><br><span class="line"></span><br><span class="line">  `fp`：文件描述符</span><br><span class="line"></span><br><span class="line">- ```python</span><br><span class="line">  soup = BeautifulSoup(response.text, &#x27;lxml&#x27;)</span><br></pre></td></tr></table></figure>

将互联网获取的页面源码加载到该对象</li>
</ul>
<blockquote>
<p>bs4对不标准的HTML字符串，可以在初始化时自动更正</p>
</blockquote>
</li>
<li><p>方法和属性</p>
<blockquote>
<p>除text&#x2F;string等特殊外，其它返回仍为<code>bs4.element.Tag </code>类型，可以继续调用方法解析</p>
</blockquote>
<ul>
<li><p><code>soup.tagName</code></p>
<p>获取<strong>第一次</strong>出现的tagName</p>
</li>
<li><p>子节点</p>
<ul>
<li><p><code>soup.tagName.contents</code></p>
<p><code>soup.tagName.children</code></p>
<p>获取第一个p节点的内容与直接子节点的列表</p>
</li>
<li><p><code>soup.tagName.descendants</code></p>
<p>获取所有子孙节点及内容的列表</p>
</li>
</ul>
</li>
<li><p>父节点</p>
<ul>
<li><p><code>soup.tagName.parent</code></p>
<p>获取直接父节点及器内容(本节点同样包含一次)</p>
</li>
<li><p><code>soup.tagName.parents</code></p>
<p>获取所有的祖先节点</p>
</li>
</ul>
</li>
<li><p>兄弟节点</p>
<ul>
<li><p><code>soup.tagName.next_sibling</code></p>
<p>下一个兄弟节点</p>
</li>
<li><p><code>soup.tagName.previous_sibling</code></p>
<p>上一个兄弟节点</p>
</li>
<li><p><code>soup.tagName.next_siblings</code></p>
<p>之前的所有兄弟节点</p>
</li>
<li><p><code>soup.tagName.previous_siblings</code></p>
<p>之后的所有兄弟节点</p>
</li>
</ul>
</li>
<li><p><code>soup.find()</code></p>
<p>获取<strong>第一次</strong>出现的tagName</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">soup.find(<span class="string">&#x27;tagName&#x27;</span>) <span class="comment"># 等同于soup.tagName</span></span><br><span class="line">soup.find(<span class="string">&#x27;tagName&#x27;</span>, attribute=<span class="string">&#x27;&#x27;</span>) <span class="comment"># 获取第一次具有固定属性的tagName</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>attribute</code>：标签的属性，<code>class</code>需要写为<code>class_</code></li>
</ul>
<blockquote>
<p>find有许多类似方法，例如<code>find_parents</code>，<code>find_next_siblings</code>等</p>
</blockquote>
</li>
<li><p><code>soup.find_all()</code></p>
<p>获取所有tagName的标签内容列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">soup.findall(name=<span class="string">&#x27;tagName&#x27;</span>, attrs=&#123;<span class="string">&#x27;&#x27;</span>:<span class="string">&#x27;&#x27;</span>&#125;, text) </span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>name</code>：使用名称查找</p>
</li>
<li><p><code>attrs</code>：使用属性查找，常用属性如<code>id</code>，<code>class</code>可以直接传入</p>
<blockquote>
<p><code>class</code>需要写为<code>class_</code></p>
</blockquote>
</li>
<li><p><code>text</code>：使用文本查找节点，可以是字符串，也可以是正则表达式对象</p>
</li>
</ul>
</li>
<li><p><code>soup.select()</code></p>
<p>返回符合选择器的标签列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">soup.select(<span class="string">&#x27;selector&#x27;</span>) <span class="comment"># 标签选择器</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>selector</code>：某种选择器</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.p1	<span class="comment"># 类选择器，html中对应&lt;p class=&quot;p1&quot;&gt;</span></span><br><span class="line"><span class="comment">#id	# id选择器，html中对应&lt;p id=&quot;text&quot;&gt;</span></span><br><span class="line">p	<span class="comment"># 标签选择器，html中对应&lt;p&gt;</span></span><br><span class="line">p,a,li	<span class="comment"># 分组选择器，一次选取多个标签</span></span><br><span class="line">duv ul li	<span class="comment"># 后代选择器，选择包含在之前标签中的最后一个标签</span></span><br><span class="line">[name=<span class="string">&quot;pra1&quot;</span>]	<span class="comment"># 属性选择器，如name，对应&lt;p name=&quot;pra1&quot;&gt;</span></span><br><span class="line">*	<span class="comment"># 通用选择器</span></span><br><span class="line">p+a	<span class="comment"># 兄弟选择器，选择同级的标签</span></span><br><span class="line">div&gt;p	<span class="comment"># 选择直属于div的p</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>soup.tagName.text/string/get_text()</code></p>
<p>获取标签之间的文本数据</p>
<blockquote>
<p><code>text/get_text()</code>获取标签中所有的文本内容(包括子标签)，<code>string</code>只能获取直接属于该标签的文本</p>
</blockquote>
</li>
<li><p><code>soup.tagName[&#39;attribute&#39;]</code></p>
<p><code>soup.tagName.attrs[&#39;attribute&#39;]</code></p>
<p>获取对应标签的属性内容，可以直接或使用attrs获取，单独使用attrs返回所有属性的字典</p>
</li>
</ul>
</li>
</ul>
<h2 id="pyquery"><a href="#pyquery" class="headerlink" title="pyquery"></a><code>pyquery</code></h2><p><code>pyquery</code>是利用CSS选择器对网页进行解析的工具</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyquery</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li><p>实例化</p>
<p>初始化<code>pyquery</code>时，也需要传入HTML文本来实例化一个<code>PyQuery</code>对象</p>
<ul>
<li><p>字符串初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery</span><br><span class="line">doc = PyQuery(html)</span><br></pre></td></tr></table></figure>
</li>
<li><p>url初始化</p>
<p>传入网页的url后，<code>pyquery</code>会先对url进行请求，用得到的HTML内容进行初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery</span><br><span class="line">doc = PyQuery(url=<span class="string">&#x27;http://cuiqingcai.com&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>文件初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery</span><br><span class="line">doc = PyQuery(filename=<span class="string">&#x27;demo.html&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>使用选择器</p>
<ul>
<li><p>基本用法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc = doc(<span class="string">&#x27;#container .list li&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>传入一个CSS选择器，选择出所有符合条件的节点，返回仍为<code>PyQuery</code>对象</p>
</li>
<li><p>查找节点</p>
<ul>
<li><p>子孙节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc.find(selector)</span><br></pre></td></tr></table></figure>

<p>查找出所有符合<code>selector</code>的所有子孙节点</p>
</li>
<li><p>直系子节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc.children(selector)</span><br></pre></td></tr></table></figure>

<p>查找出所有符合<code>selector</code>的所有子节点</p>
</li>
<li><p>父节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc.parent(selector)</span><br></pre></td></tr></table></figure>

<p>查找节点的直接父节点</p>
</li>
<li><p>祖先节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc.parents(selector)</span><br></pre></td></tr></table></figure>
</li>
<li><p>兄弟节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc.siblings(selector)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>遍历</p>
<p><code>pyquery</code>的结果可能是多个节点，但返回不为列表</p>
<p>对单个节点，可以直接输出或转为字符串</p>
<p>对于多节点，可以使用<code>items</code>方法获取生成器，并进行遍历</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lis = doc(<span class="string">&#x27;li&#x27;</span>).items()</span><br><span class="line"><span class="keyword">for</span> li <span class="keyword">in</span> lis:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取信息</p>
<ul>
<li><p>获取属性</p>
<p>调用<code>attr()</code>方法获取属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">doc.attr(<span class="string">&#x27;href&#x27;</span>)</span><br><span class="line">doc.attr.href	<span class="comment"># 两者结果一致</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>多个节点调用<code>attr</code>只会返回第一个</p>
</blockquote>
</li>
<li><p>获取文本</p>
<p>调用<code>text()</code>或<code>html()</code>方法获取文本，<code>text()</code>会忽略所有html标签(子节点)，<code>html()</code>会返回节点内部的html文本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">doc.text()	<span class="comment"># text会返回所有节点的文本内容的字符串，用空格分割</span></span><br><span class="line">doc.html()	<span class="comment"># html只会返回第一个</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>节点操作</p>
<ul>
<li><p>添加，删除当前节点<code>class</code>属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">doc.addClass(className)</span><br><span class="line">doc.removeClass(className)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>attr</code>，<code>text</code>，<code>html</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">doc.attr(tagName, content)	<span class="comment"># 改变属性值</span></span><br><span class="line">doc.text()	<span class="comment"># 改变内容</span></span><br><span class="line">doc.html()	<span class="comment"># 改变html文本</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>remove()</code></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>​	更多节点操作可以参考<a target="_blank" rel="noopener" href="http://pyquery.readthedocs.io/en/latest/api.html">http://pyquery.readthedocs.io/en/latest/api.html</a></p>
<ul>
<li><p>伪类选择器</p>
<p>CSS选择器支持多种伪类选择器，例如第一个节点，奇偶数节点等</p>
<p>可以参考<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/css/index.asp">http://www.w3school.com.cn/css/index.asp</a></p>
</li>
</ul>
<h2 id="xpath"><a href="#xpath" class="headerlink" title="xpath"></a>xpath</h2><p>即<a target="_blank" rel="noopener" href="https://www.w3.org/TR/xpath/">XML路径语言</a>，是最常用且最便捷高效的一种解析方式，通用性最强</p>
<h3 id="常用规则"><a href="#常用规则" class="headerlink" title="常用规则"></a>常用规则</h3><ul>
<li><p>根据层级关系，例如，html下的<code>head</code>下的<code>title</code>表示为<code>/html/head/title</code></p>
<ul>
<li><code>/</code>：开始表示从根目录开始定位，后续表示一个层级</li>
<li><code>//</code>：开始表示从任意位置开始定位，后续表示多个层级</li>
<li><code>[@attrName=&quot;attrValue&quot;]</code>：属性定位，跟在标签后，表示指定属性的标签</li>
<li><code>[n]</code>：索引定位，跟在标签后，定位到第n个标签(从1开始)</li>
<li><code>.</code>：表示当前标签</li>
<li><code>..</code>：当前标签的父标签</li>
<li>取文本：<ul>
<li><code>/text()</code>：取得直属于标签的文本</li>
<li><code>//text()</code>：取得所有属于标签的文本，包括子标签</li>
</ul>
</li>
<li>取属性：<ul>
<li><code>/@attrName</code>：取得标签的特定属性值</li>
</ul>
</li>
<li>关系运算法：主要使用逻辑或<code> |</code></li>
</ul>
</li>
</ul>
<blockquote>
<p> xpath不可以匹配<code>tbody</code>标签</p>
<p> xpath表达式可以在浏览器中直接生成</p>
</blockquote>
<h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h3><ul>
<li>实例化一个<code>etree</code>的对象，且需要将页面源码加载到该对象中</li>
<li>调用<code>etree</code>对象中的<code>xpath</code>方法结合xpath表达式实现标签的定位和内容的捕获</li>
</ul>
<h3 id="环境安装-2"><a href="#环境安装-2" class="headerlink" title="环境安装"></a>环境安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install lxml</span><br></pre></td></tr></table></figure>

<h3 id="etree"><a href="#etree" class="headerlink" title="etree"></a>etree</h3><ul>
<li><p>实例化对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">etree.parse(filePath)	<span class="comment"># 输入文件路径，返回一个etree对象</span></span><br><span class="line">etree.HTML(page_text)	<span class="comment"># 输入html文本，返回一个etree对象</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在etree对象初始化时，不标准的HTML会自动更正</p>
</blockquote>
</li>
<li><p>xpath表达式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etree.xpath(<span class="string">&#x27;xpath表达式&#x27;</span>)	<span class="comment"># 返回符合表达式的列表</span></span><br><span class="line">lable.xpath(<span class="string">&#x27;xpath表达式&#x27;</span>)	<span class="comment"># 返回的标签对象也有xpath表达式方法，可以使用./来表示当前label下</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p> xpath返回都为列表，使用需要索引</p>
</blockquote>
<ul>
<li><p>属性多值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree.xpath(<span class="string">&#x27;//li[contains(@class, &quot;li&quot;)]/a/text()&#x27;</span>)	<span class="comment"># 如果属性有多个值，则可以使用contains()选取包含属性的</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>多属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree.xpath(<span class="string">&#x27;//li[contains(@class, &quot;li&quot;) and @name=&quot;item&quot;]/a/text()&#x27;</span>)	<span class="comment">#多属性匹配使用and来连接</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>更多运算符：<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xpath/xpath_operators.asp">http://www.w3school.com.cn/xpath/xpath_operators.asp</a></p>
</blockquote>
<ul>
<li><p>索引选择</p>
<p>除了能使用索引定位<code>[n]</code>(从1开始)，还能使用在<code>[]</code>中使用<code>last()</code>，<code>position()&lt;n</code>等，具体可以参考<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xpath/xpath_functions.asp">http://www.w3school.com.cn/xpath/xpath_functions.asp</a></p>
</li>
<li><p>节点轴选择</p>
<p>Xpath也提供了节点轴选择</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tree.xpath(<span class="string">&#x27;//li[1]/ancestor::*&#x27;</span>)</span><br><span class="line">tree.xpath(<span class="string">&#x27;//li[1]/attribute::*&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>::</code>前加<code>ancestor</code>(获取祖先节点)，<code>attribute</code>(获取所有属性)，<code>child</code>(获取子节点)，<code>descentdant</code>(获取子孙节点)，<code>following</code>(当前节点之后的所有节点)，<code>following-sibling</code>(当前节点之后所有同级节点)等轴名</p>
<p>Xpath轴可以参考<a href="%5Bhttp://www.w3school.com.cn/xpath/xpath_axes.asp">http://www.w3school.com.cn/xpath/xpath_axes.asp</a></p>
</li>
</ul>
<h1 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h1><p>数据存储有多种方式，最简单的是文件存储，也可以保存到数据库中</p>
<h2 id="文件存储"><a href="#文件存储" class="headerlink" title="文件存储"></a>文件存储</h2><h3 id="txt文件"><a href="#txt文件" class="headerlink" title="txt文件"></a>txt文件</h3><p>txt文件存储操作简单，兼容性好，但不利于检索</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一种</span></span><br><span class="line">f = <span class="built_in">open</span>(filename, <span class="string">&#x27;w&#x27;</span>, encoding)</span><br><span class="line">f.write(content)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;w&#x27;</span>, encoding) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(content)</span><br></pre></td></tr></table></figure>

<ul>
<li>打开方式<ul>
<li>r：只读</li>
<li>b：以二进制形式打开</li>
<li>w：只写，如果文件存在则覆盖</li>
<li>a：追加打开</li>
<li>+：跟在r或w后，以读写方式打开</li>
</ul>
</li>
</ul>
<h3 id="JSON文件"><a href="#JSON文件" class="headerlink" title="JSON文件"></a>JSON文件</h3><p>JSON，即JavaScript对象标记，是一种轻量级的数据交换格式</p>
<ul>
<li><p>对象和数组</p>
<p>在 JavaScript 语言中，一切都是对象。任何支持的类型都可以通过JSON表示，对象和数组是两种特殊且常用的类型</p>
<ul>
<li>对象：在 JavaScript 中是使用花括号<code> &#123;&#125;</code> 包裹起来的内容，数据结构为<code>&#123;key1: value1, key2: value2, ...&#125;</code>，键名可以是整数和字符串，值可以是任意类型</li>
<li>数组：数组在 JavaScript 中是方括号<code>[]</code>包裹起来的内容，数据结构为<code>[value1, value2...]</code></li>
</ul>
</li>
<li><p>JSON库</p>
<ul>
<li><p>读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data = json.loads(<span class="built_in">str</span>)	<span class="comment"># 将字符串转为JSON对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    <span class="built_in">str</span> = file.read()</span><br><span class="line">    data = json.loads(<span class="built_in">str</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意字符串中JSON需要使用双引号，否则<code>loads</code>方法会报错</p>
</blockquote>
</li>
<li><p>访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="number">0</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">data[<span class="number">0</span>].get(<span class="string">&#x27;name&#x27;</span>)	<span class="comment"># 推荐，若键值不存在，则返回None</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">json.dumps(data, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)	</span><br><span class="line"><span class="comment"># 将JSON对象转换为字符串</span></span><br><span class="line"><span class="comment"># indent表示缩进，可以保留JSON格式</span></span><br><span class="line"><span class="comment"># ensure_ascii默认为True，但无法输出中文</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(json.dumps(data))</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="CSV文件"><a href="#CSV文件" class="headerlink" title="CSV文件"></a>CSV文件</h3><p>CSV文件，即逗号分割值文件，以纯文本形式存储表格数据，记录间由某种换行符分割，记录的字段间使用分割符(一般为逗号或制表符)分割</p>
<ul>
<li><p>写入</p>
<ul>
<li><p>写入行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    writer = csv.writer(csvfile, delimiter= <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    writer.writerow([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>使用<code>writer</code>类创建对象，调用<code>writerow()</code>写入每行数据，<code>delimiter</code>指定分割符</p>
</li>
<li><p>写入多行</p>
<p>writerows&#96;方法可以写入多行，要传入二维列表</p>
</li>
<li><p>写入字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    fieldnames = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>]</span><br><span class="line">    writer = csv.DictWriter(csvfile, fieldnames=fieldnames)</span><br><span class="line">    writer.writeheader()</span><br><span class="line">    writer.writerow(&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mike&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>首先使用<code>writeheader()</code>方法写入表头，然后使用<code>writerow()</code>方法写入数据，需要与表头一致</p>
<blockquote>
<p>也可以使用pandas库的<code>DataFrame</code>对象的<code>to_csv()</code>方法写入csv文件</p>
</blockquote>
</li>
</ul>
</li>
<li><p>读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> csvfile:  </span><br><span class="line">    reader = csv.reader(csvfile)  </span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:  </span><br><span class="line">       	<span class="keyword">pass</span> </span><br></pre></td></tr></table></figure>

<p>读取时使用<code>reader</code>类型的对象加载csv文件</p>
<blockquote>
<p>或者使用pandas的<code>read_csv()</code>方法</p>
</blockquote>
</li>
</ul>
<h2 id="关系型数据库存储"><a href="#关系型数据库存储" class="headerlink" title="关系型数据库存储"></a>关系型数据库存储</h2><p>关系型数据库是基于关系模型的数据库，通过二维表来保存，每一列是一个字段，每一行是一条记录，多个表组成数据库</p>
<h3 id="PyMysql使用"><a href="#PyMysql使用" class="headerlink" title="PyMysql使用"></a>PyMysql使用</h3><ul>
<li><p>连接数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">db = pymysql.connect(host=<span class="string">&#x27;domain/ip&#x27;</span>, user=<span class="string">&#x27;user&#x27;</span>, password=<span class="string">&#x27;pass&#x27;</span>, port=<span class="number">3306</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">cursor.execute(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">data = cursor.fetchone()	<span class="comment"># data = cursor.fetchall()</span></span><br><span class="line"></span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<p>连接mysql需要声明一个<code>MySql</code>对象，传入ip，用户名，密码，端口</p>
<p>连接成功后，调用<code>cursor()</code>方法获取操作mysql的游标，使用<code>execute()</code>方法指定SQL语句，如果有返回数据，则使用<code>fetchone()</code>方法获取第一条，<code>fetchall()</code>获取所有数据(也可以使用<code>wihle</code>和<code>fetchone()</code>代替)</p>
</li>
<li><p>插入数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql)</span><br><span class="line">    db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br></pre></td></tr></table></figure>

<p><code>execute()</code>方法可以将sql与param元组进行格式化拼接，<code>commit()</code>方法用于实现数据的写入，数据插入，更新，删除都需要调用该方法生效，<code>rollback()</code>执行数据回滚，一般用于异常处理</p>
<p>根据字典动态构造插入的例子，则可以不修改SQL语句，只需修改字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;20120001&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">keys = <span class="string">&#x27;, &#x27;</span>.join(data.keys())</span><br><span class="line">values = <span class="string">&#x27;, &#x27;</span>.join([<span class="string">&#x27;% s&#x27;</span>] * <span class="built_in">len</span>(data))</span><br><span class="line">sql = <span class="string">&#x27;INSERT INTO &#123;table&#125;(&#123;keys&#125;) VALUES (&#123;values&#125;)&#x27;</span>.<span class="built_in">format</span>(table=table, keys=keys, values=values)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   <span class="keyword">if</span> cursor.execute(sql, <span class="built_in">tuple</span>(data.values())):</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">&#x27;Successful&#x27;</span>)</span><br><span class="line">       db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Failed&#x27;</span>)</span><br><span class="line">    db.rollback()</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>异常时回滚涉及事务的问题，事务机制可以确保数据一致性</p>
<table>
<thead>
<tr>
<th>属　　性</th>
<th>解　　释</th>
</tr>
</thead>
<tbody><tr>
<td>原子性（atomicity）</td>
<td>事务是一个不可分割的工作单位，事务中包括的诸操作要么都做，要么都不做</td>
</tr>
<tr>
<td>一致性（consistency）</td>
<td>事务必须使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的</td>
</tr>
<tr>
<td>隔离性（isolation）</td>
<td>一个事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰</td>
</tr>
<tr>
<td>持久性（durability）</td>
<td>持续性也称永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响</td>
</tr>
</tbody></table>
</blockquote>
</li>
<li><p>更新数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&#x27;UPDATE students SET age = % s WHERE name = % s&#x27;</span></span><br></pre></td></tr></table></figure>

<p>根据字典灵活传值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;20120001&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">21</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">keys = <span class="string">&#x27;, &#x27;</span>.join(data.keys())</span><br><span class="line">values = <span class="string">&#x27;, &#x27;</span>.join([<span class="string">&#x27;% s&#x27;</span>] * <span class="built_in">len</span>(data))</span><br><span class="line"></span><br><span class="line">sql = <span class="string">&#x27;INSERT INTO &#123;table&#125;(&#123;keys&#125;) VALUES (&#123;values&#125;) ON DUPLICATE KEY UPDATE&#x27;</span>.<span class="built_in">format</span>(table=table, keys=keys, values=values)</span><br><span class="line">update = <span class="string">&#x27;,&#x27;</span>.join([<span class="string">&quot;&#123;key&#125; = % s&quot;</span>.<span class="built_in">format</span>(key=key) <span class="keyword">for</span> key <span class="keyword">in</span> data])</span><br><span class="line">sql += update</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> cursor.execute(sql, <span class="built_in">tuple</span>(data.values())*<span class="number">2</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Successful&#x27;</span>)</span><br><span class="line">        db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Failed&#x27;</span>)</span><br><span class="line">    db.rollback()</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<p>实际上是插入语句，但加入<code>ON DUPLICATE KEY UPDATE</code>，表示如果主键存在，则执行更新操作，若果不存在则插入</p>
</li>
<li><p>删除数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&#x27;DELETE FROM  &#123;table&#125; WHERE &#123;condition&#125;&#x27;</span>.<span class="built_in">format</span>(table=table, condition=condition)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&#x27;SELECT * FROM students WHERE age &gt;= 20&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="非关系数据库"><a href="#非关系数据库" class="headerlink" title="非关系数据库"></a>非关系数据库</h2><p>非关系型数据库，基于键值对，不需要经过SQL层的解析，数据没有耦合，性能很高，对于爬虫数据存储，某些字段可能提取失败而缺失，而且数据随时可能调整。使用非关系型数据库，可以避免提前建表，进行序列化操作等</p>
<h3 id="分类-2"><a href="#分类-2" class="headerlink" title="分类"></a>分类</h3><ul>
<li>键值存储数据库：Redis，Voldemort等</li>
<li>列存储数据库：Cassandra等</li>
<li>文档型数据库：MongoDB等</li>
<li>图形数据库：Neo4J等</li>
</ul>
<h3 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h3><p>MongoDB是基于分布式文件存储的非关系数据库系统，其内容存储形式类似JSON对象，且字段值可以包含其它文档，数组及文档数组</p>
<ul>
<li><p>连接MongoDB</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line">client = pymongo.MongoClient(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">27017</span>)</span><br></pre></td></tr></table></figure>

<p>创建<code>Mongoclient</code>对象需要传入MongoDB的IP及端口</p>
</li>
<li><p>指定数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db = client.name</span><br><span class="line">db = client[<span class="string">&#x27;name&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>使用两种形式都可以得到对应的数据库对象</p>
</li>
<li><p>指定集合</p>
<p>MongoDB每个数据库又包含许多集合，类似关系型数据库中的表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">collection = db.name</span><br><span class="line">collection = db[<span class="string">&#x27;name&#x27;</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>插入数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = collection.insert(<span class="built_in">dict</span>)	<span class="comment"># 官方不再推荐使用</span></span><br><span class="line">result = collection.insert_one(<span class="built_in">dict</span>)</span><br><span class="line">result = collection.insert_many(<span class="built_in">dict</span>)</span><br></pre></td></tr></table></figure>

<p>插入字典类型的数据，会自动生成 ObjectId 类型的_id 属性。</p>
<p><code>insert()</code>方法可以插入任意条数据，返回_id或_id的列表，<code>insert_one()</code>和<code>insert_many()</code>返回的是<code>pymongo.results.InsertOneResult</code>和<code>pymongo.results.InsertManyResult</code>对象，需要调用<code>inserted_id</code>和<code>inserted_ids</code>属性获取_id</p>
</li>
<li><p>查询数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = collection.find_one(<span class="built_in">dict</span>)</span><br><span class="line">result = collection.find(<span class="built_in">dict</span>)</span><br></pre></td></tr></table></figure>

<p>如果要用_id查询，需要使用bson库中的ObjectId</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bson.objectid <span class="keyword">import</span> ObjectId</span><br><span class="line"></span><br><span class="line">result = collection.find_one(&#123;<span class="string">&#x27;_id&#x27;</span>: ObjectId(<span class="string">&#x27;593278c115c2602667ec6bae&#x27;</span>)&#125;)</span><br></pre></td></tr></table></figure>

<p><code>find_one</code>的结果是字典类型，如果结果不存在，返回<code>None</code></p>
<p><code>find</code>的结果是<code>Cursor</code>类型，相当于一个生成器，可以遍历获取结果</p>
<p>查询时可以使用比较符号和功能符号</p>
<table>
<thead>
<tr>
<th>符　　号</th>
<th>含　　义</th>
<th>示　　例</th>
</tr>
</thead>
<tbody><tr>
<td>$lt</td>
<td>小于</td>
<td>{‘age’: {‘$lt’: 20}}</td>
</tr>
<tr>
<td>$gt</td>
<td>大于</td>
<td>{‘age’: {‘$gt’: 20}}</td>
</tr>
<tr>
<td>$lte</td>
<td>小于等于</td>
<td>{‘age’: {‘$lte’: 20}}</td>
</tr>
<tr>
<td>$gte</td>
<td>大于等于</td>
<td>{‘age’: {‘$gte’: 20}}</td>
</tr>
<tr>
<td>$ne</td>
<td>不等于</td>
<td>{‘age’: {‘$ne’: 20}}</td>
</tr>
<tr>
<td>$in</td>
<td>在范围内</td>
<td>{‘age’: {‘$in’: [20, 23]}}</td>
</tr>
<tr>
<td>$nin</td>
<td>不在范围内</td>
<td>{‘age’: {‘$nin’: [20, 23]}}</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>符　　号</th>
<th>含　　义</th>
<th>示　　例</th>
<th>示例含义</th>
</tr>
</thead>
<tbody><tr>
<td>$regex</td>
<td>匹配正则表达式</td>
<td>{‘name’: {‘$regex’: ‘^M.*’}}</td>
<td>name 以 M 开头</td>
</tr>
<tr>
<td>$exists</td>
<td>属性是否存在</td>
<td>{‘name’: {‘$exists’: True}}</td>
<td>name 属性存在</td>
</tr>
<tr>
<td>$type</td>
<td>类型判断</td>
<td>{‘age’: {‘$type’: ‘int’}}</td>
<td>age 的类型为 int</td>
</tr>
<tr>
<td>$mod</td>
<td>数字模操作</td>
<td>{‘age’: {‘$mod’: [5, 0]}}</td>
<td>年龄模 5 余 0</td>
</tr>
<tr>
<td>$text</td>
<td>文本查询</td>
<td>{‘$text’: {‘$search’: ‘Mike’}}</td>
<td>text 类型的属性中包含 Mike 字符串</td>
</tr>
<tr>
<td>$where</td>
<td>高级条件查询</td>
<td>{‘$where’: ‘obj.fans_count &#x3D;&#x3D; obj.follows_count’}</td>
<td>自身粉丝数等于关注数</td>
</tr>
</tbody></table>
</li>
</ul>
<blockquote>
<p>可以参考<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query/">https://docs.mongodb.com/manual/reference/operator/query/</a></p>
</blockquote>
<ul>
<li><p>计数</p>
<p>查询结果由多少条数据，可以使用<code>count()</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count = collection.find().count()</span><br></pre></td></tr></table></figure>
</li>
<li><p>排序</p>
<p>排序时，调用<code>sort()</code>方法，并传入排序字段和升降序标志即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>pymongo.ASCENDING</code>为升序，<code>pymongo.DESCENDING</code>为降序</p>
</blockquote>
</li>
<li><p>偏移</p>
<p>可以使用<code>skip(n)</code>进行跳转偏移</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING).skip(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在数据量十分巨大的时候，最好不要使用大的偏移量，可能导致内存溢出</p>
</blockquote>
</li>
<li><p>指定结果的个数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING).skip(<span class="number">2</span>).limit(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新</p>
<p>可以使用<code>update()</code>方法，指定更新条件和更新后的数据，返回字典中<code>nModified</code>代表修改的数据条数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">condition = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Kevin&#x27;</span>&#125;</span><br><span class="line">student = collection.find_one(condition)</span><br><span class="line">student[<span class="string">&#x27;age&#x27;</span>] = <span class="number">25</span></span><br><span class="line">result = collection.update(condition, student)	<span class="comment"># 对name为Kevin的数据将age变为25</span></span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>官方也推荐使用<code>update_one()</code>和<code>update_many()</code>，使用条件更加严格，第二个参数要使用$类型操作符为字典的键名</p>
</blockquote>
</li>
<li><p>删除</p>
<p>直接调用<code>remove()</code>方法，并传入条件，符合条件的数据都会被删除</p>
</li>
</ul>
<blockquote>
<p>更多可以参考<a target="_blank" rel="noopener" href="http://api.mongodb.com/python/current/api/pymongo/collection.html">http://api.mongodb.com/python/current/api/pymongo/collection.html</a>和<a target="_blank" rel="noopener" href="http://api.mongodb.com/python/current/api/pymongo/">http://api.mongodb.com/python/current/api/pymongo/</a></p>
</blockquote>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><ul>
<li><p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install redis-py</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Redis</code>和<code>StrictRedis</code></p>
<p>redis-py提供了<code>Redis</code>和<code>StrictRedis</code>两个类对redis实行操作，<code>StrictRedis</code>实现了绝大部分Redis命令，参数也一一对应，<code>Redis</code>是<code>StrictRedis</code>的子类，主要是用于向后兼容旧版本库中的几个方法，推荐使用<code>StrictRedis</code>类</p>
</li>
<li><p>连接Redis</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> StrictRedis  </span><br><span class="line"></span><br><span class="line">redis = StrictRedis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>, password=<span class="string">&#x27;foobared&#x27;</span>)  </span><br></pre></td></tr></table></figure>

<blockquote>
<p>也可以先构建<code>ConnectionPool</code>类，再将其作为参数传入<code>StrictRedis</code>类，实际<code>StrictRedis</code>类实例时也是调用<code>ConnectionPool</code>类</p>
<p><code>ConnectionPool</code>类可以使用万张的URL创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis://[:password]@host:port/db  <span class="comment"># 使用TCP</span></span><br><span class="line">rediss://[:password]@host:port/db  <span class="comment"># 使用TCP+SSL</span></span><br><span class="line">unix://[:password]@/path/to/socket.sock?db=db	<span class="comment"># 使用Redis UNIX socket</span></span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>键操作</p>
<table>
<thead>
<tr>
<th>方　　法</th>
<th>作　　用</th>
<th>参数说明</th>
<th>示　　例</th>
<th>示例说明</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td>exists(name)</td>
<td>判断一个键是否存在</td>
<td>name：键名</td>
<td>redis.exists(‘name’)</td>
<td>是否存在 name 这个键</td>
<td>True</td>
</tr>
<tr>
<td>delete(name)</td>
<td>删除一个键</td>
<td>name：键名</td>
<td>redis.delete(‘name’)</td>
<td>删除 name 这个键</td>
<td>1</td>
</tr>
<tr>
<td>type(name)</td>
<td>判断键类型</td>
<td>name：键名</td>
<td>redis.type(‘name’)</td>
<td>判断 name 这个键类型</td>
<td>b’string’</td>
</tr>
<tr>
<td>keys(pattern)</td>
<td>获取所有符合规则的键</td>
<td>pattern：匹配规则</td>
<td>redis.keys(‘n*’)</td>
<td>获取所有以 n 开头的键</td>
<td>[b’name’]</td>
</tr>
<tr>
<td>randomkey()</td>
<td>获取随机的一个键</td>
<td></td>
<td>randomkey()</td>
<td>获取随机的一个键</td>
<td>b’name’</td>
</tr>
<tr>
<td>rename(src, dst)</td>
<td>重命名键</td>
<td>src：原键名；dst：新键名</td>
<td>redis.rename(‘name’, ‘nickname’)</td>
<td>将 name 重命名为 nickname</td>
<td>True</td>
</tr>
<tr>
<td>dbsize()</td>
<td>获取当前数据库中键的数目</td>
<td></td>
<td>dbsize()</td>
<td>获取当前数据库中键的数目</td>
<td>100</td>
</tr>
<tr>
<td>expire(name, time)</td>
<td>设定键的过期时间，单位为秒</td>
<td>name：键名；time：秒数</td>
<td>redis.expire(‘name’, 2)</td>
<td>将 name 键的过期时间设置为 2 秒</td>
<td>True</td>
</tr>
<tr>
<td>ttl(name)</td>
<td>获取键的过期时间，单位为秒，1 表示永久不过期</td>
<td>name：键名</td>
<td>redis.ttl(‘name’)</td>
<td>获取 name 这个键的过期时间</td>
<td>1</td>
</tr>
<tr>
<td>move(name, db)</td>
<td>将键移动到其他数据库</td>
<td>name：键名；db：数据库代号</td>
<td>move(‘name’, 2)</td>
<td>将 name 移动到 2 号数据库</td>
<td>True</td>
</tr>
<tr>
<td>flushdb()</td>
<td>删除当前选择数据库中的所有键</td>
<td></td>
<td>flushdb()</td>
<td>删除当前选择数据库中的所有键</td>
<td>True</td>
</tr>
<tr>
<td>flushall()</td>
<td>删除所有数据库中的所有键</td>
<td></td>
<td>flushall()</td>
<td>删除所有数据库中的所有键</td>
<td>True</td>
</tr>
</tbody></table>
</li>
<li><p>字符串操作</p>
<table>
<thead>
<tr>
<th>方　　法</th>
<th>作　　用</th>
<th>参数说明</th>
<th>示　　例</th>
<th>示例说明</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td>set(name, value)</td>
<td>给数据库中键名为 name 的 string 赋予值 value</td>
<td>n ame：键名；value：值</td>
<td>redis.set(‘name’, ‘Bob’)</td>
<td>给 name 这个键的 value 赋值为 Bob</td>
<td>True</td>
</tr>
<tr>
<td>get(name)</td>
<td>返回数据库中键名为 name 的 string 的 value</td>
<td>name：键名</td>
<td>redis.get(‘name’)</td>
<td>返回 name 这个键的 value</td>
<td>b’Bob’</td>
</tr>
<tr>
<td>getset(name, value)</td>
<td>给数据库中键名为 name 的 string 赋予值 value 并返回上次的 value</td>
<td>name：键名；value：新值</td>
<td>redis.getset(‘name’, ‘Mike’)</td>
<td>赋值 name 为 Mike 并得到上次的 value</td>
<td>b’Bob’</td>
</tr>
<tr>
<td>mget(keys, *args)</td>
<td>返回多个键对应的 value 组成的列表</td>
<td>keys：键名序列</td>
<td>redis.mget([‘name’, ‘nickname’])</td>
<td>返回 name 和 nickname 的 value</td>
<td>[b’Mike’, b’Miker’]</td>
</tr>
<tr>
<td>setnx(name, value)</td>
<td>如果不存在这个键值对，则更新 value，否则不变</td>
<td>name：键名</td>
<td>redis.setnx(‘newname’, ‘James’)</td>
<td>如果 newname 这个键不存在，则设置值为 James</td>
<td>第一次运行结果是 True，第二次运行结果是 False</td>
</tr>
<tr>
<td>setex(name, time, value)</td>
<td>设置可以对应的值为 string 类型的 value，并指定此键值对应的有效期</td>
<td>n ame：键名；time：有效期；value：值</td>
<td>redis.setex(‘name’, 1, ‘James’)</td>
<td>将 name 这个键的值设为 James，有效期为 1 秒</td>
<td>True</td>
</tr>
<tr>
<td>setrange(name, offset, value)</td>
<td>设置指定键的 value 值的子字符串</td>
<td>name：键名；offset：偏移量；value：值</td>
<td>redis.set(‘name’, ‘Hello’) redis.setrange (‘name’, 6, ‘World’)</td>
<td>设置 name 为 Hello 字符串，并在 index 为 6 的位置补 World</td>
<td>11，修改后的字符串长度</td>
</tr>
<tr>
<td>mset(mapping)</td>
<td>批量赋值</td>
<td>mapping：字典或关键字参数</td>
<td>redis.mset({‘name1’: ‘Durant’, ‘name2’: ‘James’})</td>
<td>将 name1 设为 Durant，name2 设为 James</td>
<td>True</td>
</tr>
<tr>
<td>msetnx(mapping)</td>
<td>键均不存在时才批量赋值</td>
<td>mapping：字典或关键字参数</td>
<td>redis.msetnx({‘name3’: ‘Smith’, ‘name4’: ‘Curry’})</td>
<td>在 name3 和 name4 均不存在的情况下才设置二者值</td>
<td>True</td>
</tr>
<tr>
<td>incr(name, amount&#x3D;1)</td>
<td>键名为 name 的 value 增值操作，默认为 1，键不存在则被创建并设为 amount</td>
<td>name：键名；amount：增长的值</td>
<td>redis.incr(‘age’, 1)</td>
<td>age 对应的值增 1，若不存在，则会创建并设置为 1</td>
<td>1，即修改后的值</td>
</tr>
<tr>
<td>decr(name, amount&#x3D;1)</td>
<td>键名为 name 的 value 减值操作，默认为 1，键不存在则被创建并将 value 设置为 - amount</td>
<td>name：键名；amount：减少的值</td>
<td>redis.decr(‘age’, 1)</td>
<td>age 对应的值减 1，若不存在，则会创建并设置为1</td>
<td>1，即修改后的值</td>
</tr>
<tr>
<td>append(key, value)</td>
<td>键名为 key 的 string 的值附加 value</td>
<td>key：键名</td>
<td>redis.append(‘nickname’, ‘OK’)</td>
<td>向键名为 nickname 的值后追加 OK</td>
<td>13，即修改后的字符串长度</td>
</tr>
<tr>
<td>substr(name, start, end&#x3D;-1)</td>
<td>返回键名为 name 的 string 的子字符串</td>
<td>name：键名；start：起始索引；end：终止索引，默认为1，表示截取到末尾</td>
<td>redis.substr(‘name’, 1, 4)</td>
<td>返回键名为 name 的值的字符串，截取索引为 1~4 的字符</td>
<td>b’ello’</td>
</tr>
<tr>
<td>getrange(key, start, end)</td>
<td>获取键的 value 值从 start 到 end 的子字符串</td>
<td>key：键名；start：起始索引；end：终止索引</td>
<td>redis.getrange(‘name’, 1, 4)</td>
<td>返回键名为 name 的值的字符串，截取索引为 1~4 的字符</td>
<td>b’ello’</td>
</tr>
</tbody></table>
</li>
<li><p>列表操作</p>
<p>Redis 还提供了列表存储，列表内的元素可以重复，而且可以从两端存储</p>
<table>
<thead>
<tr>
<th>方　　法</th>
<th>作　　用</th>
<th>参数说明</th>
<th>示　　例</th>
<th>示例说明</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td>rpush(name, *values)</td>
<td>在键名为 name 的列表末尾添加值为 value 的元素，可以传多个</td>
<td>name：键名；values：值</td>
<td>redis.rpush(‘list’, 1, 2, 3)</td>
<td>向键名为 list 的列表尾添加 1、2、3</td>
<td>3，列表大小</td>
</tr>
<tr>
<td>lpush(name, *values)</td>
<td>在键名为 name 的列表头添加值为 value 的元素，可以传多个</td>
<td>name：键名；values：值</td>
<td>redis.lpush(‘list’, 0)</td>
<td>向键名为 list 的列表头部添加 0</td>
<td>4，列表大小</td>
</tr>
<tr>
<td>llen(name)</td>
<td>返回键名为 name 的列表的长度</td>
<td>name：键名</td>
<td>redis.llen(‘list’)</td>
<td>返回键名为 list 的列表的长度</td>
<td>4</td>
</tr>
<tr>
<td>lrange(name, start, end)</td>
<td>返回键名为 name 的列表中 start 至 end 之间的元素</td>
<td>name：键名；start：起始索引；end：终止索引</td>
<td>redis.lrange(‘list’, 1, 3)</td>
<td>返回起始索引为 1 终止索引为 3 的索引范围对应的列表</td>
<td>[b’3’, b’2’, b’1’]</td>
</tr>
<tr>
<td>ltrim(name, start, end)</td>
<td>截取键名为 name 的列表，保留索引为 start 到 end 的内容</td>
<td>name：键名；start：起始索引；end：终止索引</td>
<td>ltrim(‘list’, 1, 3)</td>
<td>保留键名为 list 的索引为 1 到 3 的元素</td>
<td>True</td>
</tr>
<tr>
<td>lindex(name, index)</td>
<td>返回键名为 name 的列表中 index 位置的元素</td>
<td>name：键名；index：索引</td>
<td>redis.lindex(‘list’, 1)</td>
<td>返回键名为 list 的列表索引为 1 的元素</td>
<td>b’2’</td>
</tr>
<tr>
<td>lset(name, index, value)</td>
<td>给键名为 name 的列表中 index 位置的元素赋值，越界则报错</td>
<td>name：键名；index：索引位置；value：值</td>
<td>redis.lset(‘list’, 1, 5)</td>
<td>将键名为 list 的列表中索引为 1 的位置赋值为 5</td>
<td>True</td>
</tr>
<tr>
<td>lrem(name, count, value)</td>
<td>删除 count 个键的列表中值为 value 的元素</td>
<td>name：键名；count：删除个数；value：值</td>
<td>redis.lrem(‘list’, 2, 3)</td>
<td>将键名为 list 的列表删除两个 3</td>
<td>1，即删除的个数</td>
</tr>
<tr>
<td>lpop(name)</td>
<td>返回并删除键名为 name 的列表中的首元素</td>
<td>name：键名</td>
<td>redis.lpop(‘list’)</td>
<td>返回并删除名为 list 的列表中的第一个元素</td>
<td>b’5’</td>
</tr>
<tr>
<td>rpop(name)</td>
<td>返回并删除键名为 name 的列表中的尾元素</td>
<td>name：键名</td>
<td>redis.rpop(‘list’)</td>
<td>返回并删除名为 list 的列表中的最后一个元素</td>
<td>b’2’</td>
</tr>
<tr>
<td>blpop(keys, timeout&#x3D;0)</td>
<td>返回并删除名称在 keys 中的 list 中的首个元素，如果列表为空，则会一直阻塞等待</td>
<td>keys：键名序列；timeout：超时等待时间，0 为一直等待</td>
<td>redis.blpop(‘list’)</td>
<td>返回并删除键名为 list 的列表中的第一个元素</td>
<td>[b’5’]</td>
</tr>
<tr>
<td>brpop(keys, timeout&#x3D;0)</td>
<td>返回并删除键名为 name 的列表中的尾元素，如果 list 为空，则会一直阻塞等待</td>
<td>keys：键名序列；timeout：超时等待时间，0 为一直等待</td>
<td>redis.brpop(‘list’)</td>
<td>返回并删除名为 list 的列表中的最后一个元素</td>
<td>[b’2’]</td>
</tr>
<tr>
<td>rpoplpush(src, dst)</td>
<td>返回并删除名称为 src 的列表的尾元素，并将该元素添加到名称为 dst 的列表头部</td>
<td>src：源列表的键；dst：目标列表的 key</td>
<td>redis.rpoplpush(‘list’, ‘list2’)</td>
<td>将键名为 list 的列表尾元素删除并将其添加到键名为 list2 的列表头部，然后返回</td>
<td>b’2’</td>
</tr>
</tbody></table>
</li>
<li><p>集合操作</p>
<p>Redis 还提供了集合存储，集合中的元素都是不重复的</p>
<table>
<thead>
<tr>
<th>方　　法</th>
<th>作　　用</th>
<th>参数说明</th>
<th>示　　例</th>
<th>示例说明</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td>sadd(name, *values)</td>
<td>向键名为 name 的集合中添加元素</td>
<td>name：键名；values：值，可为多个</td>
<td>redis.sadd(‘tags’, ‘Book’, ‘Tea’, ‘Coffee’)</td>
<td>向键名为 tags 的集合中添加 Book、Tea 和 Coffee 这 3 个内容</td>
<td>3，即插入的数据个数</td>
</tr>
<tr>
<td>srem(name, *values)</td>
<td>从键名为 name 的集合中删除元素</td>
<td>name：键名；values：值，可为多个</td>
<td>redis.srem(‘tags’, ‘Book’)</td>
<td>从键名为 tags 的集合中删除 Book</td>
<td>1，即删除的数据个数</td>
</tr>
<tr>
<td>spop(name)</td>
<td>随机返回并删除键名为 name 的集合中的一个元素</td>
<td>name：键名</td>
<td>redis.spop(‘tags’)</td>
<td>从键名为 tags 的集合中随机删除并返回该元素</td>
<td>b’Tea’</td>
</tr>
<tr>
<td>smove(src, dst, value)</td>
<td>从 src 对应的集合中移除元素并将其添加到 dst 对应的集合中</td>
<td>src：源集合；dst：目标集合；value：元素值</td>
<td>redis.smove(‘tags’, ‘tags2’, ‘Coffee’)</td>
<td>从键名为 tags 的集合中删除元素 Coffee 并将其添加到键为 tags2 的集合</td>
<td>True</td>
</tr>
<tr>
<td>scard(name)</td>
<td>返回键名为 name 的集合的元素个数</td>
<td>name：键名</td>
<td>redis.scard(‘tags’)</td>
<td>获取键名为 tags 的集合中的元素个数</td>
<td>3</td>
</tr>
<tr>
<td>sismember(name, value)</td>
<td>测试 member 是否是键名为 name 的集合的元素</td>
<td>name：键值</td>
<td>redis.sismember(‘tags’, ‘Book’)</td>
<td>判断 Book 是否是键名为 tags 的集合元素</td>
<td>True</td>
</tr>
<tr>
<td>sinter(keys, *args)</td>
<td>返回所有给定键的集合的交集</td>
<td>keys：键名序列</td>
<td>redis.sinter([‘tags’, ‘tags2’])</td>
<td>返回键名为 tags 的集合和键名为 tags2 的集合的交集</td>
<td>{b’Coffee’}</td>
</tr>
<tr>
<td>sinterstore(dest, keys, *args)</td>
<td>求交集并将交集保存到 dest 的集合</td>
<td>dest：结果集合；keys：键名序列</td>
<td>redis.sinterstore (‘inttag’, [‘tags’, ‘tags2’])</td>
<td>求键名为 tags 的集合和键名为 tags2 的集合的交集并将其保存为 inttag</td>
<td>1</td>
</tr>
<tr>
<td>sunion(keys, *args)</td>
<td>返回所有给定键的集合的并集</td>
<td>keys：键名序列</td>
<td>redis.sunion([‘tags’, ‘tags2’])</td>
<td>返回键名为 tags 的集合和键名为 tags2 的集合的并集</td>
<td>{b’Coffee’, b’Book’, b’Pen’}</td>
</tr>
<tr>
<td>sunionstore(dest, keys, *args)</td>
<td>求并集并将并集保存到 dest 的集合</td>
<td>dest：结果集合；keys：键名序列</td>
<td>redis.sunionstore (‘inttag’, [‘tags’, ‘tags2’])</td>
<td>求键名为 tags 的集合和键名为 tags2 的集合的并集并将其保存为 inttag</td>
<td>3</td>
</tr>
<tr>
<td>sdiff(keys, *args)</td>
<td>返回所有给定键的集合的差集</td>
<td>keys：键名序列</td>
<td>redis.sdiff([‘tags’, ‘tags2’])</td>
<td>返回键名为 tags 的集合和键名为 tags2 的集合的差集</td>
<td>{b’Book’, b’Pen’}</td>
</tr>
<tr>
<td>sdiffstore(dest, keys, *args)</td>
<td>求差集并将差集保存到 dest 集合</td>
<td>dest：结果集合；keys：键名序列</td>
<td>redis.sdiffstore (‘inttag’, [‘tags’, ‘tags2’])</td>
<td>求键名为 tags 的集合和键名为 tags2 的集合的差集并将其保存为 inttag</td>
<td>3</td>
</tr>
<tr>
<td>smembers(name)</td>
<td>返回键名为 name 的集合的所有元素</td>
<td>name：键名</td>
<td>redis.smembers(‘tags’)</td>
<td>返回键名为 tags 的集合的所有元素</td>
<td>{b’Pen’, b’Book’, b’Coffee’}</td>
</tr>
<tr>
<td>srandmember(name)</td>
<td>随机返回键名为 name 的集合中的一个元素，但不删除元素</td>
<td>name：键值</td>
<td>redis.srandmember(‘tags’)</td>
<td>随机返回键名为 tags 的集合中的一个元素</td>
<td>Srandmember (name)</td>
</tr>
</tbody></table>
</li>
<li><p>有序集合操作</p>
<p>有序集合比集合多了一个分数字段，利用它可以对集合中的数据进行排序</p>
<table>
<thead>
<tr>
<th>方　　法</th>
<th>作　　用</th>
<th>参数说明</th>
<th>示　　例</th>
<th>示例说明</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td>zadd(name, *args, **kwargs)</td>
<td>向键名为 name 的 zset 中添加元素 member，score 用于排序。如果该元素存在，则更新其顺序</td>
<td>name：键名；args：可变参数</td>
<td>redis.zadd(‘grade’, 100, ‘Bob’, 98, ‘Mike’)</td>
<td>向键名为 grade 的 zset 中添加 Bob（其 score 为 100），并添加 Mike（其 score 为 98）</td>
<td>2，即添加的元素个数</td>
</tr>
<tr>
<td>zrem(name, *values)</td>
<td>删除键名为 name 的 zset 中的元素</td>
<td>name：键名；values：元素</td>
<td>redis.zrem(‘grade’, ‘Mike’)</td>
<td>从键名为 grade 的 zset 中删除 Mike</td>
<td>1，即删除的元素个数</td>
</tr>
<tr>
<td>zincrby(name, value, amount&#x3D;1)</td>
<td>如果在键名为 name 的 zset 中已经存在元素 value，则将该元素的 score 增加 amount；否则向该集合中添加该元素，其 score 的值为 amount</td>
<td>name：键名；value：元素；amount：增长的 score 值</td>
<td>redis.zincrby(‘grade’, ‘Bob’, -2)</td>
<td>键名为 grade 的 zset 中 Bob 的 score 减 2</td>
<td>98.0，即修改后的值</td>
</tr>
<tr>
<td>zrank(name, value)</td>
<td>返回键名为 name 的 zset 中元素的排名，按 score 从小到大排序，即名次</td>
<td>name：键名；value：元素值</td>
<td>redis.zrank(‘grade’, ‘Amy’)</td>
<td>得到键名为 grade 的 zset 中 Amy 的排名</td>
<td>1</td>
</tr>
<tr>
<td>zrevrank(name, value)</td>
<td>返回键为 name 的 zset 中元素的倒数排名（按 score 从大到小排序），即名次</td>
<td>name：键名；value：元素值</td>
<td>redis.zrevrank (‘grade’, ‘Amy’)</td>
<td>得到键名为 grade 的 zset 中 Amy 的倒数排名</td>
<td>2</td>
</tr>
<tr>
<td>zrevrange(name, start, end, withscores&#x3D; False)</td>
<td>返回键名为 name 的 zset（按 score 从大到小排序）中 index 从 start 到 end 的所有元素</td>
<td>name：键值；start：开始索引；end：结束索引；withscores：是否带 score</td>
<td>redis.zrevrange (‘grade’, 0, 3)</td>
<td>返回键名为 grade 的 zset 中前四名元素</td>
<td>[b’Bob’, b’Mike’, b’Amy’, b’James’]</td>
</tr>
<tr>
<td>zrangebyscore (name, min, max, start&#x3D;None, num&#x3D;None, withscores&#x3D;False)</td>
<td>返回键名为 name 的 zset 中 score 在给定区间的元素</td>
<td>name：键名；min：最低 score；max：最高 score；start：起始索引；num：个数；withscores：是否带 score</td>
<td>redis.zrangebyscore (‘grade’, 80, 95)</td>
<td>返回键名为 grade 的 zset 中 score 在 80 和 95 之间的元素</td>
<td>[b’Bob’, b’Mike’, b’Amy’, b’James’]</td>
</tr>
<tr>
<td>zcount(name, min, max)</td>
<td>返回键名为 name 的 zset 中 score 在给定区间的数量</td>
<td>name：键名；min：最低 score；max：最高 score</td>
<td>redis.zcount(‘grade’, 80, 95)</td>
<td>返回键名为 grade 的 zset 中 score 在 80 到 95 的元素个数</td>
<td>2</td>
</tr>
<tr>
<td>zcard(name)</td>
<td>返回键名为 name 的 zset 的元素个数</td>
<td>name：键名</td>
<td>redis.zcard(‘grade’)</td>
<td>获取键名为 grade 的 zset 中元素的个数</td>
<td>3</td>
</tr>
<tr>
<td>zremrangebyrank (name, min, max)</td>
<td>删除键名为 name 的 zset 中排名在给定区间的元素</td>
<td>name：键名；min：最低位次；max：最高位次</td>
<td>redis.zremrangebyrank (‘grade’, 0, 0)</td>
<td>删除键名为 grade 的 zset 中排名第一的元素</td>
<td>1，即删除的元素个数</td>
</tr>
<tr>
<td>zremrangebyscore (name, min, max)</td>
<td>删除键名为 name 的 zset 中 score 在给定区间的元素</td>
<td>name：键名；min：最低 score；max：最高 score</td>
<td>redis.zremrangebyscore (‘grade’, 80, 90)</td>
<td>删除 score 在 80 到 90 之间的元素</td>
<td>1，即删除的元素个数</td>
</tr>
</tbody></table>
</li>
<li><p>散列操作</p>
<p>Redis 还提供了散列表的数据结构，我们可以用 name 指定一个散列表的名称，表内存储了各个键值对</p>
<table>
<thead>
<tr>
<th>方　　法</th>
<th>作　　用</th>
<th>参数说明</th>
<th>示　　例</th>
<th>示例说明</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td>hset(name, key, value)</td>
<td>向键名为 name 的散列表中添加映射</td>
<td>name：键名；key：映射键名；value：映射键值</td>
<td>hset(‘price’, ‘cake’, 5)</td>
<td>向键名为 price 的散列表中添加映射关系，cake 的值为 5</td>
<td>1，即添加的映射个数</td>
</tr>
<tr>
<td>hsetnx(name, key, value)</td>
<td>如果映射键名不存在，则向键名为 name 的散列表中添加映射</td>
<td>name：键名；key：映射键名；value：映射键值</td>
<td>hsetnx(‘price’, ‘book’, 6)</td>
<td>向键名为 price 的散列表中添加映射关系，book 的值为 6</td>
<td>1，即添加的映射个数</td>
</tr>
<tr>
<td>hget(name, key)</td>
<td>返回键名为 name 的散列表中 key 对应的值</td>
<td>name：键名；key：映射键名</td>
<td>redis.hget(‘price’, ‘cake’)</td>
<td>获取键名为 price 的散列表中键名为 cake 的值</td>
<td>5</td>
</tr>
<tr>
<td>hmget(name, keys, *args)</td>
<td>返回键名为 name 的散列表中各个键对应的值</td>
<td>name：键名；keys：键名序列</td>
<td>redis.hmget(‘price’, [‘apple’, ‘orange’])</td>
<td>获取键名为 price 的散列表中 apple 和 orange 的值</td>
<td>[b’3’, b’7’]</td>
</tr>
<tr>
<td>hmset(name, mapping)</td>
<td>向键名为 name 的散列表中批量添加映射</td>
<td>name：键名；mapping：映射字典</td>
<td>redis.hmset(‘price’, {‘banana’: 2, ‘pear’: 6})</td>
<td>向键名为 price 的散列表中批量添加映射</td>
<td>True</td>
</tr>
<tr>
<td>hincrby(name, key, amount&#x3D;1)</td>
<td>将键名为 name 的散列表中映射的值增加 amount</td>
<td>name：键名；key：映射键名；amount：增长量</td>
<td>redis.hincrby(‘price’, ‘apple’, 3)</td>
<td>key 为 price 的散列表中 apple 的值增加 3</td>
<td>6，修改后的值</td>
</tr>
<tr>
<td>hexists(name, key)</td>
<td>键名为 name 的散列表中是否存在键名为键的映射</td>
<td>name：键名；key：映射键名</td>
<td>redis.hexists(‘price’, ‘banana’)</td>
<td>键名为 price 的散列表中 banana 的值是否存在</td>
<td>True</td>
</tr>
<tr>
<td>hdel(name, *keys)</td>
<td>在键名为 name 的散列表中，删除键名为键的映射</td>
<td>name：键名；keys：键名序列</td>
<td>redis.hdel(‘price’, ‘banana’)</td>
<td>从键名为 price 的散列表中删除键名为 banana 的映射</td>
<td>True</td>
</tr>
<tr>
<td>hlen(name)</td>
<td>从键名为 name 的散列表中获取映射个数</td>
<td>name：键名</td>
<td>redis.hlen(‘price’)</td>
<td>从键名为 price 的散列表中获取映射个数</td>
<td>6</td>
</tr>
<tr>
<td>hkeys(name)</td>
<td>从键名为 name 的散列表中获取所有映射键名</td>
<td>name：键名</td>
<td>redis.hkeys(‘price’)</td>
<td>从键名为 price 的散列表中获取所有映射键名</td>
<td>[b’cake’, b’book’, b’banana’, b’pear’]</td>
</tr>
<tr>
<td>hvals(name)</td>
<td>从键名为 name 的散列表中获取所有映射键值</td>
<td>name：键名</td>
<td>redis.hvals(‘price’)</td>
<td>从键名为 price 的散列表中获取所有映射键值</td>
<td>[b’5’, b’6’, b’2’, b’6’]</td>
</tr>
<tr>
<td>hgetall(name)</td>
<td>从键名为 name 的散列表中获取所有映射键值对</td>
<td>name：键名</td>
<td>redis.hgetall(‘price’)</td>
<td>从键名为 price 的散列表中获取所有映射键值对</td>
<td>{b’cake’: b’5’, b’book’: b’6’, b’orange’: b’7’, b’pear’: b’6’}</td>
</tr>
</tbody></table>
</li>
<li><p><code>RedisDump</code></p>
<p><code>RedisDump</code>提供了强大的Redis数据的导入和导出功能</p>
<ul>
<li><p><code>redis-dump</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Usage: redis-dump [global options] COMMAND [command options]   </span><br><span class="line">    -u, --uri=S                      Redis URI (e.g. redis://hostname[:port])  </span><br><span class="line">    -d, --database=S                 Redis database (e.g. -d 15)  </span><br><span class="line">    -s, --sleep=S                    Sleep for S seconds after dumping (for debugging)  </span><br><span class="line">    -c, --count=S                    Chunk size (default: 10000)  </span><br><span class="line">    -f, --filter=S                   Filter selected keys (passed directly to redis&#x27; KEYS command)  </span><br><span class="line">    -O, --without_optimizations      Disable run time optimizations  </span><br><span class="line">    -V, --version                    Display version  </span><br><span class="line">    -D, --debug  </span><br><span class="line">        --nosafe</span><br></pre></td></tr></table></figure>

<p>其中<code>- u</code>代表 Redis 连接字符串，<code>-d </code>代表数据库代号，<code>-s </code>代表导出之后的休眠时间，<code>-c</code> 代表分块大小，默认是 10000，<code>-f </code>代表导出时的过滤器，<code>-O </code>代表禁用运行时优化，<code>-V </code>用于显示版本，<code>-D</code> 表示开启调试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-dump -u :passwd@localhost:6379</span><br></pre></td></tr></table></figure>

<p>运行后，可以将数据库数据导出</p>
</li>
<li><p><code>dump-load</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis-load --help  </span><br><span class="line">  Try: redis-load [global options] COMMAND [command options]   </span><br><span class="line">    -u, --uri=S                      Redis URI (e.g. redis://hostname[:port])  </span><br><span class="line">    -d, --database=S                 Redis database (e.g. -d 15)  </span><br><span class="line">    -s, --sleep=S                    Sleep for S seconds after dumping (for debugging)  </span><br><span class="line">    -n, --no_check_utf8  </span><br><span class="line">    -V, --version                    Display version  </span><br><span class="line">    -D, --debug  </span><br><span class="line">        --nosafe</span><br></pre></td></tr></table></figure>

<p>其中<code> - u</code> 代表 Redis 连接字符串，<code>-d </code>代表数据库代号，默认是全部，<code>-s </code>代表导出之后的休眠时间，<code>-n </code>代表不检测 UTF-8 编码，<code>-V </code>表示显示版本，<code>-D</code> 表示开启调试。</p>
</li>
</ul>
</li>
</ul>
<h1 id="动态页面抓取"><a href="#动态页面抓取" class="headerlink" title="动态页面抓取"></a>动态页面抓取</h1><p>Ajax抓取是解决动态页面的一种方式，Ajax是JavaScript动态渲染中较为容易抓取的一种，但JavaScript渲染不止Ajax一种，并且，如果Ajax接口可能含有加密参数，很难找出规律</p>
<p>解决动态页面抓取的另一种方法是直接模拟浏览器运行来实现，直接获取渲染后的界面源码，不再分析JavaScript如何渲染出界面</p>
<h2 id="Ajax数据"><a href="#Ajax数据" class="headerlink" title="Ajax数据"></a>Ajax数据</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>Ajax，全称为 Asynchronous JavaScript and XML，即异步的 JavaScript 和 XML，是利用 JavaScript 在保证页面不被刷新、页面链接不改变的情况下与服务器交换数据并更新部分网页的技术</p>
<ul>
<li><p>发送请求</p>
<p>Ajax是由JavaScript实现的，实际上执行了如下代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xmlhttp;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>) &#123;</span><br><span class="line">    <span class="comment">//code for IE7+, Firefox, Chrome, Opera, Safari</span></span><br><span class="line">    xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();&#125; <span class="keyword">else</span> &#123;<span class="comment">//code for IE6, IE5</span></span><br><span class="line">    xmlhttp=<span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&quot;Microsoft.XMLHTTP&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>) &#123;<span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span> &amp;&amp; xmlhttp.<span class="property">status</span>==<span class="number">200</span>) &#123;<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myDiv&quot;</span>).<span class="property">innerHTML</span>=xmlhttp.<span class="property">responseText</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>,<span class="string">&quot;/ajax/&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">xmlhttp.<span class="title function_">send</span>();</span><br></pre></td></tr></table></figure>

<p>实际上新建了<code>XMLHttpRequest</code>对象，然后调用<code>onreadystatechange</code>属性进行了监听，然后调用<code>open()</code>和<code>send()</code>方法对服务器进行了请求</p>
</li>
<li><p>解析内容</p>
<p>当服务器返回响应时，<code>onreadystatechange</code>对应的方法就会触发，然后调用<code>xmlhttp</code>的<code>responseText</code>属性可以获取响应内容</p>
</li>
<li><p>渲染网页</p>
<p>JavaScript有改变网页内容的能力，在解析完响应内容后，就调用JavaScript对网页进行处理，这样的操作也叫DOM操作</p>
</li>
</ul>
<h3 id="Ajax分析方法"><a href="#Ajax分析方法" class="headerlink" title="Ajax分析方法"></a>Ajax分析方法</h3><ul>
<li><p>查看请求</p>
<p>借助浏览器的开发者工具，在Network选项卡中，筛选出XHR</p>
<p>XHR是Ajax中特殊的请求类型，一般来说，Ajax请求中的<code>Request Headers</code>中有一个信息为<code>X-Requested-With:XMLHttpRequest</code></p>
</li>
<li><p>过滤请求</p>
</li>
</ul>
<h3 id="Ajax结果抓取"><a href="#Ajax结果抓取" class="headerlink" title="Ajax结果抓取"></a>Ajax结果抓取</h3><ul>
<li><p>分析请求</p>
<p>得到请求类型，请求连接，请求参数，并推测各个参数的意义</p>
</li>
<li><p>分析响应</p>
<p>得到响应的格式，并分析响应的意义</p>
</li>
</ul>
<h2 id="Selenium"><a href="#Selenium" class="headerlink" title="Selenium"></a>Selenium</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>Selenium是一个自动化测试工具，可以利用它驱动浏览器完成特定的动作，还可以获取浏览器当前呈现的页面的源代码</p>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><ul>
<li><p>声明浏览器对象</p>
<blockquote>
<p>需要先安装对应的驱动</p>
</blockquote>
<p>Selenium支持多种浏览器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser = webdriver.Edge()</span><br><span class="line">browser = webdriver.PhantomJS()</span><br><span class="line">browser = webdriver.Safari()</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.taobao.com&#x27;</span>)</span><br><span class="line">text = browser.page_source</span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure>

<p>使用<code>get</code>方法可以请求网页，<code>page_source</code>属性能获取浏览器呈现的网页源码</p>
</li>
<li><p>查找节点</p>
<ul>
<li><p>单个节点</p>
<p>使用find_element族方法，可以获取第一个符合条件的标签</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">find_element_by_id()</span><br><span class="line">find_element_by_name()</span><br><span class="line">find_element_by_xpath()</span><br><span class="line">find_element_by_link_text()</span><br><span class="line">find_element_by_partial_link_text()</span><br><span class="line">find_element_by_tag_name()</span><br><span class="line">find_element_by_class_name()</span><br><span class="line">find_element_by_css_selector()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">find_element()	<span class="comment"># 通用方法，第一个为查找方式By.*，另一个为值</span></span><br></pre></td></tr></table></figure>

<p>返回值为<code>WebElement</code>类型</p>
</li>
<li><p>多个节点</p>
<p>使用find_elements族方法，可以获取所有符合条件的标签</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">find_elements_by_id</span><br><span class="line">find_elements_by_name</span><br><span class="line">find_elements_by_xpath</span><br><span class="line">find_elements_by_link_text</span><br><span class="line">find_elements_by_partial_link_text</span><br><span class="line">find_elements_by_tag_name</span><br><span class="line">find_elements_by_class_name</span><br><span class="line">find_elements_by_css_selector</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">lis = browser.find_elements(By.CSS_SELECTOR, <span class="string">&#x27;.service-bd li&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>返回值为<code>WebElement</code>类型的列表</p>
</li>
</ul>
</li>
<li><p>节点交互</p>
<blockquote>
<p>节点操作可以参考：<a target="_blank" rel="noopener" href="http://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.remote.webelement">http://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.remote.webelement</a></p>
</blockquote>
<p>在选中标签获得标签对象后，常用有输入文字时使用<code>send_keys()</code>方法，清空文字时使用<code>clear()</code>方法，点击按钮时使用<code>click()</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.taobao.com&#x27;</span>)</span><br><span class="line"><span class="built_in">input</span> = browser.find_element_by_id(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">&#x27;iPhone&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">input</span>.clear()</span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">&#x27;iPad&#x27;</span>)</span><br><span class="line">button = browser.find_element_by_class_name(<span class="string">&#x27;btn-search&#x27;</span>)</span><br><span class="line">button.click()</span><br></pre></td></tr></table></figure>
</li>
<li><p>动作链</p>
<p>一些没有特定的执行对象的操作，可以使用动作链完成</p>
<blockquote>
<p>动作链可以参考：<a target="_blank" rel="noopener" href="http://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.action_chains">http://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.action_chains</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"></span><br><span class="line">browser.get(url)</span><br><span class="line">source = browser.find_element_by_css_selector(<span class="string">&#x27;#draggable&#x27;</span>)</span><br><span class="line">target = browser.find_element_by_css_selector(<span class="string">&#x27;#droppable&#x27;</span>)</span><br><span class="line">actions = ActionChains(browser)</span><br><span class="line">actions.drag_and_drop(source, target)</span><br></pre></td></tr></table></figure>

<p>使用动作链需要先声明一个<code>ActionChains</code>对象，通过调用<code>drag_and_drop()</code>方法，最后调用<code>perform()</code>方法执行动作</p>
</li>
<li><p>执行JavaScript</p>
<p>对于一些动作，可以直接模拟运行JavaScript代码进行实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser.execute_script(<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取节点信息</p>
<p>获取节点信息可以直接使用<code>page_source</code>属性获取源代码后使用解析库进行解析，但Selenium也提供了选择节点的方法</p>
<ul>
<li><p>获取属性</p>
<p>对<code>WebElement</code>类型的标签对象使用<code>get_attribute()</code>方法，传入属性名，就可以获取值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label.get_attribute(<span class="string">&#x27;class&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取文本值</p>
<p>调用<code>WebElement</code>类型的标签对象的<code>text</code>属性就能获取文本值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label.text</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取ID，位置，标签名，大小</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">label.<span class="built_in">id</span></span><br><span class="line">label.location</span><br><span class="line">label.tag_name</span><br><span class="line">label.size</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>切换Frame</p>
<p>网页中有一种节点叫<code>iframe</code>，也就是子Frame，相当于子页面。在Selenium打开页面后，默认是在父Frame中操作，如果要操作子Frame，需要使用<code>switch_to.frame()</code>来切换</p>
</li>
<li><p>延时等待</p>
<p>在Selenium中，<code>get()</code>方法会在网页框架加载结束后完成执行，但此时如果界面有额外的JS请求，可能不能完全加载，因此需要等待一定时间</p>
<p>延时等待可以分为隐式等待和显式等待</p>
<ul>
<li><p>隐式等待</p>
<p>隐式等待需要调用<code>implicitly_wait()</code>来设定，默认值为0，即Selenium没有在DOM中找到节点时，隐式等待将会等待设定的时间再次查找DOM，没有则抛出异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser.implicitly_wait(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>显式等待</p>
<p>隐式等待的缺点是只规定了一个固定等待时间，显式等待规定一个最大等待时间，如果在规定时间内节点加载出来，则返回节点，否则抛出异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.taobao.com/&#x27;</span>)</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line"><span class="built_in">input</span> = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;q&#x27;</span>)))</span><br><span class="line">button = wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="string">&#x27;.btn-search&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">input</span>, button)</span><br></pre></td></tr></table></figure>

<p>显式等待需要先实例化一个<code>WebDriverWait</code>对象指定最长等待时间，然后调用其<code>until()</code>方法，传入等待条件<code>expected_conditions</code>，例如，使用<code>EC.presence_of_element_located()</code>判断是否加载出节点，参数是节点的定位元组</p>
<blockquote>
<p>等待条件可以参考：<a target="_blank" rel="noopener" href="http://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.expected_conditions">http://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.expected_conditions</a></p>
</blockquote>
<p>如果没有加载出，则会抛出<code>TimeoutException</code>异常</p>
</li>
</ul>
</li>
<li><p>前进后退</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">browser.back()</span><br><span class="line">browser.forward()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Cookies</p>
<p>使用Selenium，可以方便地对Cookies进行操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">browser.add_cookie(&#123;<span class="string">&#x27;&#x27;</span>:<span class="string">&#x27;&#x27;</span>&#125;)</span><br><span class="line">browser.get_cookies()</span><br><span class="line">browser.delete_all_cookies()</span><br></pre></td></tr></table></figure>
</li>
<li><p>选项卡操作</p>
<p>在访问网页时，会开启一个个选项卡，可以用Selenium进行操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser.switch_to_window(browser.window_handles[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>异常处理</p>
<p>对于异常，可以参考<a target="_blank" rel="noopener" href="http://selenium-python.readthedocs.io/api.html#module-selenium.common.exceptions">http://selenium-python.readthedocs.io/api.html#module-selenium.common.exceptions</a></p>
</li>
</ul>
<h3 id="Chrome-Headless模式"><a href="#Chrome-Headless模式" class="headerlink" title="Chrome Headless模式"></a>Chrome Headless模式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br></pre></td></tr></table></figure>

<h2 id="Splash"><a href="#Splash" class="headerlink" title="Splash"></a>Splash</h2><p>Splash是一个JavaScript渲染服务，带有HTTP API的轻量级浏览器，同时对接了Python中的Twisted和QT库</p>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ul>
<li>异步方式处理多个网页渲染</li>
<li>获取渲染后的源代码或截图</li>
<li>关闭图片渲染或使用Adblock规则加快渲染速度</li>
<li>执行特定的JavaScript脚本</li>
<li>通过Lua脚本控制页面渲染过程</li>
<li>获取渲染的详细过程并通过HAR(HTTP Archive)格式呈现</li>
</ul>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>使用docker服务可以方便的使用Splash</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8050:8050 scrapinghub/splash</span><br></pre></td></tr></table></figure>

<p>打开<a target="_blank" rel="noopener" href="http://localhost:8050/">http://localhost:8050/</a>即可打开Web界面</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>在输入框内输入网址即可开始渲染，会返回渲染截图，HAR加载数据统计，网页源码等</p>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/7-7.png" alt="7-7"></p>
<p>渲染过程由一段Lua脚本控制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function main(splash, args)</span><br><span class="line">  <span class="keyword">assert</span>(splash:go(args.url))</span><br><span class="line">  <span class="keyword">assert</span>(splash:wait(<span class="number">0.5</span>))</span><br><span class="line">  <span class="keyword">return</span> &#123;html = splash:html(),</span><br><span class="line">    png = splash:png(),</span><br><span class="line">    har = splash:har(),&#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h3 id="Lua脚本"><a href="#Lua脚本" class="headerlink" title="Lua脚本"></a>Lua脚本</h3><ul>
<li><p>入口及返回值</p>
<p>Splash会默认调用<code>main</code>方法，返回值可以为字符串，也可以是字典</p>
<blockquote>
<p>注意Lua中的字典形式<code>&#123;hello=&quot;world!&quot;&#125;</code></p>
</blockquote>
</li>
<li><p>异步处理</p>
<p>Splash支持异步处理，但无需显式指明回调方法，回调的跳转是在Splash内部完成的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function main(splash, args)</span><br><span class="line">  local example_urls = &#123;<span class="string">&quot;www.baidu.com&quot;</span>, <span class="string">&quot;www.taobao.com&quot;</span>, <span class="string">&quot;www.zhihu.com&quot;</span>&#125;</span><br><span class="line">  local urls = args.urls <span class="keyword">or</span> example_urls</span><br><span class="line">  local results = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> index, url <span class="keyword">in</span> ipairs(urls) do</span><br><span class="line">    local ok, reason = splash:go(<span class="string">&quot;http://&quot;</span> .. url)</span><br><span class="line">    <span class="keyword">if</span> ok then</span><br><span class="line">      splash:wait(<span class="number">2</span>)</span><br><span class="line">      results[url] = splash:png()</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  <span class="keyword">return</span> results</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>其中，<code>wait</code>方法类似于<code>sleep</code>方法，当Splash执行到此处时，会转而处理其他任务，在指定之间后返回继续处理</p>
<blockquote>
<p>Lua的语法：<a target="_blank" rel="noopener" href="http://www.runoob.com/lua/lua-basic-syntax.html">http://www.runoob.com/lua/lua-basic-syntax.html</a></p>
</blockquote>
</li>
<li><p><code>Splash</code>对象属性</p>
<p><code>main</code>方法第一个参数为<code>splash</code>对象，类似于Selenium中的<code>WebDriver</code>对象</p>
<ul>
<li><p><code>args</code></p>
<p>脚本中<code>main</code>方法的参数有一个<code>args</code>，Splash也支持省去，省去后<code>args</code>参数会直接作为<code>splash</code>对象的属性</p>
</li>
<li><p><code>js_enabled</code></p>
<p><code>js_ebabled</code>控制是否执行JavaScript代码，默认为<code>true</code></p>
<blockquote>
<p>注意，如果调用<code>splash:evaljs(&#39;&#39;)</code>执行JavaScript代码便会抛出异常</p>
</blockquote>
</li>
<li><p><code>resource_timeout</code></p>
<p>可以设置加载超时时间，超时会抛出异常，默认为0或<code>nil</code>(类似于Python中的<code>None</code>)，表示不检测超时</p>
</li>
<li><p><code>images_enabled</code></p>
<p>设置图片是否加载，默认加载，禁用可以节省流量并提高加载速度。但要注意禁止图片加载可能影响外层DOM节点的高度和位置，进而影响JavaScript渲染</p>
<blockquote>
<p>如果在加载图片后禁用加载图片，再重新加载页面，由于使用了缓存，图片可能仍会加载</p>
</blockquote>
</li>
<li><p><code>plugins_enabled</code></p>
<p>控制浏览器插件是否开启，默认为<code>false</code></p>
</li>
<li><p><code>scroll_position</code></p>
<p>设置页面上下或左右滚动，比较常用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">splash.scroll_position = &#123;x=<span class="number">100</span>, y=<span class="number">200</span>&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>Splash</code>对象方法</p>
<ul>
<li><p><code>go</code></p>
<p>用于请求某个链接，可以模拟GET和POST请求，同时支持传入请求头，表单等</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, reason = splash:go&#123;url, baseurl=<span class="literal">nil</span>, headers=<span class="literal">nil</span>, http_method=<span class="string">&quot;GET&quot;</span>, body=<span class="literal">nil</span>, formdata=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>url</code>：请求的url</li>
<li><code>baserl</code>：可选参数，默认为空，资源加载的相对路径</li>
<li><code>headers</code>：可选参数，默认为空，请求的Headers</li>
<li><code>http_method</code>：可选参数，默认为GET，支持POST</li>
<li><code>body</code>：可选参数，默认为空，POST请求时的表单数据，使用的Content-Type为<code>application/json</code></li>
<li>formdata：可选参数，默认为空，POST请求时的表单数据，使用的Content-Type为<code>application/x-www-form-urlencoded</code></li>
<li><code>ok</code>：如果<code>ok</code>为空，则网页加载错误，<code>reason</code>中包含了错误的原因</li>
</ul>
</li>
<li><p><code>wait</code></p>
<p>控制页面等待时间</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, reason = splash:wait&#123;<span class="built_in">time</span>, cancel_on_redirect=<span class="literal">false</span>, cancel_on_error=<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>time</code>：等待的秒数</li>
<li><code>cancel_on_redirect</code>：可选参数，默认<code> False</code>，如果发生了重定向就停止等待，并返回重定向结果</li>
<li><code>cancel_on_error</code>：可选参数，默认 <code>False</code>，如果发生了加载错误就停止等待</li>
</ul>
</li>
<li><p><code>jsfunc</code></p>
<p>可以直接调用JavaScript 定义的方法，即将 JavaScript 定义的方法直接转换为Lua方法，但是所调用的方法需要用双中括号包围</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> name = splash:jsfunc(<span class="string">[[function () &#123;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  ]]</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以参阅<a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/scripting-ref.html#splash-jsfunc">https://splash.readthedocs.io/en/stable/scripting-ref.html#splash-jsfunc</a></p>
</blockquote>
</li>
<li><p><code>evaljs</code></p>
<p>可以执行JavaScript 代码并返回最后一条 JavaScript 语句的返回结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = splash:evaljs(js)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>runjs</code></p>
<p>与 evaljs 方法的功能类似，但是更偏向于执行某些动作或声明某些方法</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">splash:runjs(<span class="string">&quot;foo = function() &#123;return &#x27;bar&#x27;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> result = splash:evaljs(<span class="string">&quot;foo()&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>autoload</code></p>
<p>设置每个界面访问时自动加载的代码或库，不执行任何操作</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, reason = splash:autoload&#123;source_or_url, source=<span class="literal">nil</span>, url=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>source_or_url</code>：JavaScript 代码或者 JavaScript 库链接。</li>
<li><code>source</code>：JavaScript 代码。</li>
<li><code>url</code>：JavaScript 库链接</li>
</ul>
</li>
<li><p><code>call_later</code></p>
<p>设定定时任务和延迟时间实现任务延迟执行，并且可以通过<code>cancel</code>方法重新执行定时任务，例如在0.2和1.2秒后截图一次</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> timer = splash:call_later(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  snapshots[<span class="string">&quot;a&quot;</span>] = splash:png()</span><br><span class="line">  splash:wait(<span class="number">1.0</span>)</span><br><span class="line">  snapshots[<span class="string">&quot;b&quot;</span>] = splash:png()</span><br><span class="line"><span class="keyword">end</span>, <span class="number">0.2</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>http_get</code></p>
<p>模拟发送HTTP的GET请求</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = splash:http_get&#123;url, headers=<span class="literal">nil</span>, follow_redirects=<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>url</code>：请求 URL</li>
<li><code>headers</code>：可选参数，默认为空，请求的 Headers</li>
<li><code>follow_redirects</code>：可选参数，默认为 True，是否启动自动重定向</li>
</ul>
</li>
<li><p><code>http_post</code></p>
<p>模拟发送一个POST请求</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = splash:http_post&#123;url, headers=<span class="literal">nil</span>, follow_redirects=<span class="literal">true</span>, body=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>url</code>：请求 URL</li>
<li><code>headers</code>：可选参数，默认为空，请求的 Headers</li>
<li><code>follow_redirects</code>：可选参数，默认为 True，是否启动自动重定向</li>
<li><code>body</code>：可选参数，默认为空，即表单数据</li>
</ul>
</li>
<li><p><code>set_content</code></p>
<p>设置页面的内容</p>
</li>
<li><p><code>html</code></p>
<p>获取网页的源代码</p>
</li>
<li><p><code>png</code></p>
<p>获取PNG格式的网页截图</p>
</li>
<li><p><code>jpeg</code></p>
<p>获取JPEG格式的网页截图</p>
</li>
<li><p><code>har</code></p>
<p>获取页面的加载描述过程</p>
</li>
<li><p><code>url</code></p>
<p>获取正在访问的url</p>
</li>
<li><p><code>get_cookies</code></p>
<p>获取当前页面的Cookies</p>
</li>
<li><p><code>add_cookies</code></p>
<p>为当前页面添加Cookies</p>
</li>
<li><p><code>clear_cookies</code></p>
<p>清除所有的Cookies</p>
</li>
<li><p><code>get_viewport_size</code></p>
<p>获取当前浏览器页面的大小，返回为二维数组</p>
</li>
<li><p><code>set_viewport_size</code></p>
<p>设置当前浏览器的大小</p>
</li>
<li><p><code>set_viewport_full</code></p>
<p>设置全屏显示</p>
</li>
<li><p><code>set_user_agent</code></p>
<p>设置浏览器的User-Agent</p>
</li>
<li><p><code>set_custom_headers</code></p>
<p>设置请求的Headers</p>
</li>
<li><p><code>select</code></p>
<p>使用CSS选择器选择符合条件的第一个节点</p>
</li>
<li><p><code>select_all</code></p>
<p>使用CSS选择器选中所有符合条件的节点</p>
</li>
<li><p><code>mouse_click</code></p>
<p>模拟鼠标的点击操作，传入坐标x，y值，或选中某个节点直接调用此方法</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Splash常用的操作可以参考<a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/scripting-ref.html">https://splash.readthedocs.io/en/stable/scripting-ref.html</a>和<a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/scripting-element-object.html">https://splash.readthedocs.io/en/stable/scripting-element-object.html</a></p>
</blockquote>
<h3 id="Splash-API"><a href="#Splash-API" class="headerlink" title="Splash API"></a>Splash API</h3><p>Splash提供了一些HTTP接口，请求接口并传递响应参数就可以获得结果</p>
<ul>
<li><p><code>render.html</code></p>
<p>获取Splash获取渲染后的页面的HTML代码，使用Splash的运行地址加接口名称就可以访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://localhost:8050/render.html?url=https://www.baidu.com&#x27;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>具体使用参考：<a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/api.html#render-html">https://splash.readthedocs.io/en/stable/api.html#render-html</a></p>
</blockquote>
</li>
<li><p><code>render.png</code></p>
<p>获取网页截图，可以通过&#96;&#96;width<code>和</code>height&#96;控制宽高，返回二进制数据</p>
<blockquote>
<p>详细参考：<a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/api.html#render-png">https://splash.readthedocs.io/en/stable/api.html#render-png</a></p>
</blockquote>
</li>
<li><p><code>render.har</code></p>
<p>获取页面加载的HAR数据，返回值为JSON格式的数据</p>
</li>
<li><p><code>render.json</code></p>
<p>包含前面三个接口的所有功能，返回时JSON格式，可以用参数控制</p>
<blockquote>
<p>详细参考：<a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/api.html#render-json">https://splash.readthedocs.io/en/stable/api.html#render-json</a></p>
</blockquote>
</li>
<li><p><code>execute</code></p>
<p><code>lua_source</code>参数中传递lua脚本源代码，执行lua脚本，并获取结果</p>
<blockquote>
<p>注意用 urllib.parse 模块里的 quote() 方法将脚本进行 URL 转码</p>
</blockquote>
</li>
</ul>
<h3 id="Splash均衡负载"><a href="#Splash均衡负载" class="headerlink" title="Splash均衡负载"></a>Splash均衡负载</h3><p>可以利用Nginx搭建Splash的分布集群实现均衡负载</p>
<ul>
<li><p>Nginx配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	<span class="section">upstream</span> splash &#123;</span><br><span class="line">		least_conn;	<span class="comment"># 代表最少链接负载均衡，适合处理时间长短不一的情况</span></span><br><span class="line">            		<span class="comment"># </span></span><br><span class="line">		<span class="attribute">server</span> ...;	<span class="comment"># 可以加入weight=；指定权重</span></span><br><span class="line">        <span class="attribute">server</span> ...;</span><br><span class="line">        ...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">		<span class="attribute">listen</span> <span class="number">8050</span>;</span><br><span class="line">		<span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://splash;</span><br><span class="line">            <span class="attribute">auth_basic</span> <span class="string">&quot;Restricted&quot;</span>;	<span class="comment"># 若不希望公开，可以使用认证，使用htpasswd生成账户密码，需要在请求时加入auth参数</span></span><br><span class="line">            <span class="attribute">auth_basic_user_file</span> /etc/nginx/conf.d/.htpasswd;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="验证码识别"><a href="#验证码识别" class="headerlink" title="验证码识别"></a>验证码识别</h1><ul>
<li>验证码是一种反爬机制</li>
<li>解决方法：<ul>
<li>人工肉眼识别</li>
<li>库识别</li>
<li>第三方自动识别</li>
</ul>
</li>
</ul>
<h2 id="图形验证码"><a href="#图形验证码" class="headerlink" title="图形验证码"></a>图形验证码</h2><p>图形验证码可以使用OCR技术进行识别，tesserocr库提供了对应的接口</p>
<ul>
<li><p>获取验证码</p>
</li>
<li><p>识别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.jpg&#x27;</span>)</span><br><span class="line">result = tesserocr.image_to_text(image)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line">tesserocr.file_to_text(<span class="string">&#x27;image.png&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>第一种方法借助PIL加载图片，第二种直接调用tesserocr的方法直接转换，但第一种方法识别效果较好</p>
</li>
<li><p>验证码处理</p>
<p>对于有轻度多余线条的图片，可以先进行转灰度和二值化处理，提高识别精度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">image = image.convert(<span class="string">&#x27;1&#x27;</span>)	<span class="comment"># 二值化，默认阈值为127</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="极验滑动验证码"><a href="#极验滑动验证码" class="headerlink" title="极验滑动验证码"></a>极验滑动验证码</h2><p>华东验证码需要拖动合并滑块才能完成验证</p>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-5.jpg" alt="8-5"></p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>极验验证码相较于图形验证码来说识别难度更大，还增加了机器学习方法识别拖动轨迹</p>
<p>当前极验验证码首先判断是否在同一会话下，如果是，则点击后直接通过验证，否则弹出滑动验证窗口</p>
<h3 id="识别"><a href="#识别" class="headerlink" title="识别"></a>识别</h3><ul>
<li><p>过程</p>
<p>识别验证需要完成三步</p>
<ul>
<li>模拟点击验证按钮</li>
<li>识别滑动缺口的位置</li>
<li>模拟拖动滑块</li>
</ul>
</li>
<li><p>思路</p>
<ul>
<li>构造模拟表单提交，但需要分析加密参数构造</li>
<li>模拟浏览器行为，需要注意模仿人类行为</li>
</ul>
</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ul>
<li><p>使用Selenium模拟点击按钮</p>
</li>
<li><p>识别缺口位置</p>
<ul>
<li><p>可以使用边缘检测算法</p>
</li>
<li><p>在没有滑块前，会显示原图，可以通过原图对比来识别缺口位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_position</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取验证码位置</span></span><br><span class="line"><span class="string">    :return: 验证码位置元组</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img = self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">&#x27;geetest_canvas_img&#x27;</span>)))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    location = img.location</span><br><span class="line">    size = img.size</span><br><span class="line">    top, bottom, left, right = location[<span class="string">&#x27;y&#x27;</span>], location[<span class="string">&#x27;y&#x27;</span>] + size[<span class="string">&#x27;height&#x27;</span>], location[<span class="string">&#x27;x&#x27;</span>], location[<span class="string">&#x27;x&#x27;</span>] + size[<span class="string">&#x27;width&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> (top, bottom, left, right)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_geetest_image</span>(<span class="params">self, name=<span class="string">&#x27;captcha.png&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取验证码图片</span></span><br><span class="line"><span class="string">    :return: 图片对象</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    top, bottom, left, right = self.get_position()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27; 验证码位置 &#x27;</span>, top, bottom, left, right)</span><br><span class="line">    screenshot = self.get_screenshot()</span><br><span class="line">    captcha = screenshot.crop((left, top, right, bottom))</span><br><span class="line">    <span class="keyword">return</span> captcha</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_slider</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取滑块</span></span><br><span class="line"><span class="string">    :return: 滑块对象</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    slider = self.wait.until(EC.element_to_be_clickable((By.CLASS_NAME, <span class="string">&#x27;geetest_slider_button&#x27;</span>)))</span><br><span class="line">    <span class="keyword">return</span> slider</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_pixel_equal</span>(<span class="params">self, image1, image2, x, y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    判断两个像素是否相同</span></span><br><span class="line"><span class="string">    :param image1: 图片 1</span></span><br><span class="line"><span class="string">    :param image2: 图片 2</span></span><br><span class="line"><span class="string">    :param x: 位置 x</span></span><br><span class="line"><span class="string">    :param y: 位置 y</span></span><br><span class="line"><span class="string">    :return: 像素是否相同</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 取两个图片的像素点</span></span><br><span class="line">    pixel1 = image1.load()[x, y]</span><br><span class="line">    pixel2 = image2.load()[x, y]</span><br><span class="line">    threshold = <span class="number">60</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(pixel1[<span class="number">0</span>] - pixel2[<span class="number">0</span>]) &lt;threshold <span class="keyword">and</span> <span class="built_in">abs</span>(pixel1[<span class="number">1</span>] - pixel2[<span class="number">1</span>]) &lt; threshold <span class="keyword">and</span> <span class="built_in">abs</span>(pixel1[<span class="number">2</span>] - pixel2[<span class="number">2</span>]) &lt; threshold:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_gap</span>(<span class="params">self, image1, image2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取缺口偏移量</span></span><br><span class="line"><span class="string">    :param image1: 不带缺口图片</span></span><br><span class="line"><span class="string">    :param image2: 带缺口图片</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    left = <span class="number">60</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(left, image1.size[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(image1.size[<span class="number">1</span>]):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.is_pixel_equal(image1, image2, i, j):</span><br><span class="line">                left = i</span><br><span class="line">                <span class="keyword">return</span> left</span><br><span class="line">    <span class="keyword">return</span> left</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>模拟拖动</p>
<p>正常人拖动一般为先加速，后减速，极验验证码利用机器学习模型，匀速，围绕平均速度随机抖动都无法通过</p>
<p>可以使用加速度公式完成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = v0 * t + <span class="number">0.5</span> * a * t * t </span><br><span class="line">v = v0 + a * t</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_track</span>(<span class="params">self, distance</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据偏移量获取移动轨迹</span></span><br><span class="line"><span class="string">    :param distance: 偏移量</span></span><br><span class="line"><span class="string">    :return: 移动轨迹</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 移动轨迹</span></span><br><span class="line">    track = []</span><br><span class="line">    <span class="comment"># 当前位移</span></span><br><span class="line">    current = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 减速阈值</span></span><br><span class="line">    mid = distance * <span class="number">4</span> / <span class="number">5</span></span><br><span class="line">    <span class="comment"># 计算间隔</span></span><br><span class="line">    t = <span class="number">0.2</span></span><br><span class="line">    <span class="comment"># 初速度</span></span><br><span class="line">    v = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> current &lt; distance:</span><br><span class="line">        <span class="keyword">if</span> current &lt; mid:</span><br><span class="line">            <span class="comment"># 加速度为正 2</span></span><br><span class="line">            a = <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 加速度为负 3</span></span><br><span class="line">            a = -<span class="number">3</span></span><br><span class="line">        <span class="comment"># 初速度 v0</span></span><br><span class="line">        v0 = v</span><br><span class="line">        <span class="comment"># 当前速度 v = v0 + at</span></span><br><span class="line">        v = v0 + a * t</span><br><span class="line">        <span class="comment"># 移动距离 x = v0t + 1/2 * a * t^2</span></span><br><span class="line">        move = v0 * t + <span class="number">1</span> / <span class="number">2</span> * a * t * t</span><br><span class="line">        <span class="comment"># 当前位移</span></span><br><span class="line">        current += move</span><br><span class="line">        <span class="comment"># 加入轨迹</span></span><br><span class="line">        track.append(<span class="built_in">round</span>(move))</span><br><span class="line">    <span class="keyword">return</span> track</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_to_gap</span>(<span class="params">self, slider, tracks</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    拖动滑块到缺口处</span></span><br><span class="line"><span class="string">    :param slider: 滑块</span></span><br><span class="line"><span class="string">    :param tracks: 轨迹</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ActionChains(self.browser).click_and_hold(slider).perform()</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> tracks:</span><br><span class="line">        ActionChains(self.browser).move_by_offset(xoffset=x, yoffset=<span class="number">0</span>).perform()</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    ActionChains(self.browser).release().perform()</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="点触验证码"><a href="#点触验证码" class="headerlink" title="点触验证码"></a>点触验证码</h2><p>典型的点触验证码如下图所示，一个提供点触验证码的网站为<a target="_blank" rel="noopener" href="https://www.touclick.com/">https://www.touclick.com/</a></p>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-18.jpg" alt="8-18"></p>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-21.jpg" alt="8-21"></p>
<h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><ul>
<li>识别难度大，需要先识别文字，然后识别文字对应的图像，或背景改绕大</li>
</ul>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><ul>
<li>可以借助第三方平台解决，例如<a target="_blank" rel="noopener" href="https://www.chaojiying.com/">超级鹰</a></li>
</ul>
<h2 id="宫格验证码"><a href="#宫格验证码" class="headerlink" title="宫格验证码"></a>宫格验证码</h2><p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/8-25.jpg" alt="8-25"></p>
<h3 id="识别思路"><a href="#识别思路" class="headerlink" title="识别思路"></a>识别思路</h3><ul>
<li><p>可以发现，这种宫格所有的情况并不多，可以借助穷举模板实现</p>
</li>
<li><p>只匹配箭头，但箭头只有几个像素值，成功率不高</p>
</li>
<li><p>匹配全图，虽然模板多，但工作量更少，精度更高</p>
</li>
</ul>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><ul>
<li><p>获取模板</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USERNAME = <span class="string">&#x27;&#x27;</span></span><br><span class="line">PASSWORD = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CrackWeiboSlide</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.url = <span class="string">&#x27;https://passport.weibo.cn/signin/login&#x27;</span></span><br><span class="line">        self.browser = webdriver.Chrome()</span><br><span class="line">        self.wait = WebDriverWait(self.browser, <span class="number">20</span>)</span><br><span class="line">        self.username = USERNAME</span><br><span class="line">        self.password = PASSWORD</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__del__</span>(<span class="params">self</span>):</span><br><span class="line">        self.browser.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        打开网页输入用户名密码并点击</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.browser.get(self.url)</span><br><span class="line">        username = self.wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;loginName&#x27;</span>)))</span><br><span class="line">        password = self.wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;loginPassword&#x27;</span>)))</span><br><span class="line">        submit = self.wait.until(EC.element_to_be_clickable((By.ID, <span class="string">&#x27;loginAction&#x27;</span>)))</span><br><span class="line">        username.send_keys(self.username)</span><br><span class="line">        password.send_keys(self.password)</span><br><span class="line">        submit.click()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_position</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取验证码位置</span></span><br><span class="line"><span class="string">        :return: 验证码位置元组</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            img = self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">&#x27;patt-shadow&#x27;</span>)))</span><br><span class="line">        <span class="keyword">except</span> TimeoutException:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27; 未出现验证码 &#x27;</span>)</span><br><span class="line">            self.<span class="built_in">open</span>()</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        location = img.location</span><br><span class="line">        size = img.size</span><br><span class="line">        top, bottom, left, right = location[<span class="string">&#x27;y&#x27;</span>], location[<span class="string">&#x27;y&#x27;</span>] + size[<span class="string">&#x27;height&#x27;</span>], location[<span class="string">&#x27;x&#x27;</span>], location[<span class="string">&#x27;x&#x27;</span>] + size[<span class="string">&#x27;width&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> (top, bottom, left, right)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_screenshot</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取网页截图</span></span><br><span class="line"><span class="string">        :return: 截图对象</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        screenshot = self.browser.get_screenshot_as_png()</span><br><span class="line">        screenshot = Image.<span class="built_in">open</span>(BytesIO(screenshot))</span><br><span class="line">        <span class="keyword">return</span> screenshot</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_image</span>(<span class="params">self, name=<span class="string">&#x27;captcha.png&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取验证码图片</span></span><br><span class="line"><span class="string">        :return: 图片对象</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        top, bottom, left, right = self.get_position()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; 验证码位置 &#x27;</span>, top, bottom, left, right)</span><br><span class="line">        screenshot = self.get_screenshot()</span><br><span class="line">        captcha = screenshot.crop((left, top, right, bottom))</span><br><span class="line">        captcha.save(name)</span><br><span class="line">        <span class="keyword">return</span> captcha</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        批量获取验证码</span></span><br><span class="line"><span class="string">        :return: 图片对象</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            self.<span class="built_in">open</span>()</span><br><span class="line">            self.get_image(<span class="built_in">str</span>(count) + <span class="string">&#x27;.png&#x27;</span>)</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    crack = CrackWeiboSlide()</span><br><span class="line">    crack.main()</span><br></pre></td></tr></table></figure>
</li>
<li><p>模板匹配</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_image</span>(<span class="params">self, image</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    匹配图片</span></span><br><span class="line"><span class="string">    :param image: 图片</span></span><br><span class="line"><span class="string">    :return: 拖动顺序</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> template_name <span class="keyword">in</span> listdir(TEMPLATES_FOLDER):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; 正在匹配 &#x27;</span>, template_name)</span><br><span class="line">        template = Image.<span class="built_in">open</span>(TEMPLATES_FOLDER + template_name)</span><br><span class="line">        <span class="keyword">if</span> self.same_image(image, template):</span><br><span class="line">            <span class="comment"># 返回顺序</span></span><br><span class="line">            numbers = [<span class="built_in">int</span>(number) <span class="keyword">for</span> number <span class="keyword">in</span> <span class="built_in">list</span>(template_name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>])]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27; 拖动顺序 &#x27;</span>, numbers)</span><br><span class="line">            <span class="keyword">return</span> numbers</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_pixel_equal</span>(<span class="params">self, image1, image2, x, y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    判断两个像素是否相同</span></span><br><span class="line"><span class="string">    :param image1: 图片 1</span></span><br><span class="line"><span class="string">    :param image2: 图片 2</span></span><br><span class="line"><span class="string">    :param x: 位置 x</span></span><br><span class="line"><span class="string">    :param y: 位置 y</span></span><br><span class="line"><span class="string">    :return: 像素是否相同</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 取两个图片的像素点</span></span><br><span class="line">    pixel1 = image1.load()[x, y]</span><br><span class="line">    pixel2 = image2.load()[x, y]</span><br><span class="line">    threshold = <span class="number">20</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(pixel1[<span class="number">0</span>] - pixel2[<span class="number">0</span>]) &lt;threshold <span class="keyword">and</span> <span class="built_in">abs</span>(pixel1[<span class="number">1</span>] - pixel2[<span class="number">1</span>]) &lt; threshold <span class="keyword">and</span> <span class="built_in">abs</span>(pixel1[<span class="number">2</span>] - pixel2[<span class="number">2</span>]) &lt; threshold:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">same_image</span>(<span class="params">self, image, template</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    识别相似验证码</span></span><br><span class="line"><span class="string">    :param image: 待识别验证码</span></span><br><span class="line"><span class="string">    :param template: 模板</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 相似度阈值</span></span><br><span class="line">    threshold = <span class="number">0.99</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(image.width):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(image.height):</span><br><span class="line">            <span class="comment"># 判断像素是否相同</span></span><br><span class="line">            <span class="keyword">if</span> self.is_pixel_equal(image, template, x, y):</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">    result = <span class="built_in">float</span>(count) / (image.width * image.height)</span><br><span class="line">    <span class="keyword">if</span> result &gt; threshold:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; 成功匹配 &#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>模拟拖动</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">move</span>(<span class="params">self, numbers</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据顺序拖动</span></span><br><span class="line"><span class="string">    :param numbers:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 获得四个按点</span></span><br><span class="line">    circles = self.browser.find_elements_by_css_selector(<span class="string">&#x27;.patt-wrap .patt-circ&#x27;</span>)</span><br><span class="line">    dx = dy = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        circle = circles[numbers[index] - <span class="number">1</span>]</span><br><span class="line">        <span class="comment"># 如果是第一次循环</span></span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 点击第一个按点</span></span><br><span class="line">            ActionChains(self.browser) \</span><br><span class="line">                .move_to_element_with_offset(circle, circle.size[<span class="string">&#x27;width&#x27;</span>] / <span class="number">2</span>, circle.size[<span class="string">&#x27;height&#x27;</span>] / <span class="number">2</span>) \</span><br><span class="line">                .click_and_hold().perform()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 小幅移动次数</span></span><br><span class="line">            times = <span class="number">30</span></span><br><span class="line">            <span class="comment"># 拖动</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">                ActionChains(self.browser).move_by_offset(dx /times, dy /times).perform()</span><br><span class="line">                time.sleep(<span class="number">1</span> /times)</span><br><span class="line">        <span class="comment"># 如果是最后一次循环</span></span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">3</span>:</span><br><span class="line">            <span class="comment"># 松开鼠标</span></span><br><span class="line">            ActionChains(self.browser).release().perform()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 计算下一次偏移</span></span><br><span class="line">            dx = circles[numbers[index + <span class="number">1</span>] - <span class="number">1</span>].location[<span class="string">&#x27;x&#x27;</span>] - circle.location[<span class="string">&#x27;x&#x27;</span>]</span><br><span class="line">            dy = circles[numbers[index + <span class="number">1</span>] - <span class="number">1</span>].location[<span class="string">&#x27;y&#x27;</span>] - circle.location[<span class="string">&#x27;y&#x27;</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="代理-2"><a href="#代理-2" class="headerlink" title="代理"></a>代理</h1><ul>
<li>破解封ip的反爬机制</li>
<li>作用：<ul>
<li>突破自身IP访问的限制</li>
<li>隐藏自身的IP</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy = &#123;<span class="string">&quot;https&quot;</span>:<span class="string">&quot;&quot;</span>&#125;	<span class="comment"># 代理的ip字典，协议:地址</span></span><br><span class="line">response = requests.get(url, proxies=proxy)	<span class="comment"># 使用代理发送get请求</span></span><br></pre></td></tr></table></figure>

<ul>
<li>匿名度：<ul>
<li>透明：既知道使用了代理，也知道真实IP</li>
<li>匿名：知道使用了代理，但不知道真实IP</li>
<li>高匿：既不知道使用了代理，也不知道真实IP</li>
</ul>
</li>
</ul>
<h2 id="代理设置"><a href="#代理设置" class="headerlink" title="代理设置"></a>代理设置</h2><h3 id="urllib"><a href="#urllib" class="headerlink" title="urllib"></a>urllib</h3><ul>
<li><p>urllib模块需要使用<code>ProxyHandler</code>类创建Opener</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">&#x27;username:password@127.0.0.1:9743&#x27;</span>	<span class="comment"># 如果需要认证</span></span><br><span class="line">proxy_handler = ProxyHandler(&#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">&#125;)</span><br><span class="line">opener = build_opener(proxy_handler)</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果为socks5类型，则可以直接设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9742</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br></pre></td></tr></table></figure>

<p>需要先安装socks模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PySocks</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h3><ul>
<li><p>对于requests，只需要传入<code>proxies</code>参数即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">&#x27;127.0.0.1:9743&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, proxies=proxies)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用socks代理需要安装模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install &quot;requests[socks]&quot;</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ul>
<h3 id="Selenium-1"><a href="#Selenium-1" class="headerlink" title="Selenium"></a>Selenium</h3><ul>
<li><p>对于Chrome，直接通过<code>ChromeOptions</code>来设置代理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">&#x27;127.0.0.1:9743&#x27;</span></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--proxy-server=http://&#x27;</span> + proxy)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br></pre></td></tr></table></figure>

<p>带有认证的代理设置相对比较麻烦，需要创建manifest.json配置文件和background.js脚本设置代理，运行后会生成一个proxy_auth_plugin.zip文件来保存当前配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">9743</span></span><br><span class="line">username = <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;bar&#x27;</span></span><br><span class="line"></span><br><span class="line">manifest_json = <span class="string">&quot;&quot;&quot;&#123;&quot;version&quot;:&quot;1.0.0&quot;,&quot;manifest_version&quot;: 2,&quot;name&quot;:&quot;Chrome Proxy&quot;,&quot;permissions&quot;: [&quot;proxy&quot;,&quot;tabs&quot;,&quot;unlimitedStorage&quot;,&quot;storage&quot;,&quot;&lt;all_urls&gt;&quot;,&quot;webRequest&quot;,&quot;webRequestBlocking&quot;],&quot;background&quot;: &#123;&quot;scripts&quot;: [&quot;background.js&quot;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>background_js =<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">var config = &#123;</span></span><br><span class="line"><span class="string">        mode: &quot;fixed_servers&quot;,</span></span><br><span class="line"><span class="string">        rules: &#123;</span></span><br><span class="line"><span class="string">          singleProxy: &#123;</span></span><br><span class="line"><span class="string">            scheme: &quot;http&quot;,</span></span><br><span class="line"><span class="string">            host: &quot;%(ip) s&quot;,</span></span><br><span class="line"><span class="string">            port: %(port) s</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.proxy.settings.set(&#123;value: config, scope: &quot;regular&quot;&#125;, function() &#123;&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function callbackFn(details) &#123;</span></span><br><span class="line"><span class="string">    return &#123;</span></span><br><span class="line"><span class="string">        authCredentials: &#123;username: &quot;%(username) s&quot;,</span></span><br><span class="line"><span class="string">            password: &quot;%(password) s&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.webRequest.onAuthRequired.addListener(</span></span><br><span class="line"><span class="string">            callbackFn,</span></span><br><span class="line"><span class="string">            &#123;urls: [&quot;&lt;all_urls&gt;&quot;]&#125;,</span></span><br><span class="line"><span class="string">            [&#x27;blocking&#x27;]</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % &#123;<span class="string">&#x27;ip&#x27;</span>: ip, <span class="string">&#x27;port&#x27;</span>: port, <span class="string">&#x27;username&#x27;</span>: username, <span class="string">&#x27;password&#x27;</span>: password&#125;</span><br><span class="line"></span><br><span class="line">plugin_file = <span class="string">&#x27;proxy_auth_plugin.zip&#x27;</span></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(plugin_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zp:</span><br><span class="line">    zp.writestr(<span class="string">&quot;manifest.json&quot;</span>, manifest_json)</span><br><span class="line">    zp.writestr(<span class="string">&quot;background.js&quot;</span>, background_js)</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--start-maximized&quot;</span>)</span><br><span class="line">chrome_options.add_extension(plugin_file)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="代理池"><a href="#代理池" class="headerlink" title="代理池"></a>代理池</h2><p>代理池可以提前对代理进行筛选，保留可用代理</p>
<h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>代理池基本模块分为4个</p>
<ul>
<li>存储模块：负责存储抓取的代理，要保证不重复并动态实时处理每个代理，可以使用Redis的<code>Sorted Set</code></li>
<li>获取模块：定时从代理网站获取代理，成功后保存到数据库中</li>
<li>检测模块：定时检测数据库中的代理，最好是检测需要爬取的网站。需要设置代理的状态，设置分数标识，如果代理可用，加一分，否则减一分，当分数低于一定阈值后，进行删除</li>
<li>接口模块：用API提供对外的接口服务</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/9-1.jpg" alt="9-1"></p>
<h3 id="IP有效性判断"><a href="#IP有效性判断" class="headerlink" title="IP有效性判断"></a>IP有效性判断</h3><p>分数是判断代理稳定性的标准。可以设定以下规则：</p>
<ul>
<li>分数100为可用，检测器会定时检测每个代理，一旦可用就设置为100，由此可以最大程度上筛选出可用代理</li>
<li>如果检测代理不可用，则分数减1，减至0后移除代理，保证拯救代理的机会多</li>
<li>新代理分数设置为10，检测的机会没有可用代理那么多，减少系统开销</li>
</ul>
<h3 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h3><ul>
<li><p>存储模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">MAX_SCORE = <span class="number">100</span></span><br><span class="line">MIN_SCORE = <span class="number">0</span></span><br><span class="line">INITIAL_SCORE = <span class="number">10</span></span><br><span class="line">REDIS_HOST = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span></span><br><span class="line">REDIS_PASSWORD = <span class="literal">None</span></span><br><span class="line">REDIS_KEY = <span class="string">&#x27;proxies&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisClient</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host=REDIS_HOST, port=REDIS_PORT, password=REDIS_PASSWORD</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化</span></span><br><span class="line"><span class="string">        :param host: Redis 地址</span></span><br><span class="line"><span class="string">        :param port: Redis 端口</span></span><br><span class="line"><span class="string">        :param password: Redis 密码</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.db = redis.StrictRedis(host=host, port=port, password=password, decode_responses=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, proxy, score=INITIAL_SCORE</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        添加代理，设置分数为最高</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :param score: 分数</span></span><br><span class="line"><span class="string">        :return: 添加结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.db.zscore(REDIS_KEY, proxy):</span><br><span class="line">            <span class="keyword">return</span> self.db.zadd(REDIS_KEY, score, proxy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        随机获取有效代理，首先尝试获取最高分数代理，如果不存在，按照排名获取，否则异常</span></span><br><span class="line"><span class="string">        :return: 随机代理</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        result = self.db.zrangebyscore(REDIS_KEY, MAX_SCORE, MAX_SCORE)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result):</span><br><span class="line">            <span class="keyword">return</span> choice(result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result = self.db.zrevrange(REDIS_KEY, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(result):</span><br><span class="line">                <span class="keyword">return</span> choice(result)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> PoolEmptyError</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrease</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        代理值减一分，小于最小值则删除</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 修改后的代理分数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        score = self.db.zscore(REDIS_KEY, proxy)</span><br><span class="line">        <span class="keyword">if</span> score <span class="keyword">and</span> score &gt; MIN_SCORE:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27; 代理 &#x27;</span>, proxy, <span class="string">&#x27; 当前分数 &#x27;</span>, score, <span class="string">&#x27; 减 1&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zincrby(REDIS_KEY, proxy, -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27; 代理 &#x27;</span>, proxy, <span class="string">&#x27; 当前分数 &#x27;</span>, score, <span class="string">&#x27; 移除 &#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zrem(REDIS_KEY, proxy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exists</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        判断是否存在</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 是否存在</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> self.db.zscore(REDIS_KEY, proxy) == <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">max</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将代理设置为 MAX_SCORE</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 设置结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; 代理 &#x27;</span>, proxy, <span class="string">&#x27; 可用，设置为 &#x27;</span>, MAX_SCORE)</span><br><span class="line">        <span class="keyword">return</span> self.db.zadd(REDIS_KEY, MAX_SCORE, proxy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">count</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取数量</span></span><br><span class="line"><span class="string">        :return: 数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.db.zcard(REDIS_KEY)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">all</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取全部代理</span></span><br><span class="line"><span class="string">        :return: 全部代理列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span><span class="keyword">return</span> self.db.zrangebyscore(REDIS_KEY, MIN_SCORE, MAX_SCORE)```</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> .utils <span class="keyword">import</span> get_page</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProxyMetaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, name, bases, attrs</span>):</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        attrs[<span class="string">&#x27;__CrawlFunc__&#x27;</span>] = []</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;crawl_&#x27;</span> <span class="keyword">in</span> k:</span><br><span class="line">                attrs[<span class="string">&#x27;__CrawlFunc__&#x27;</span>].append(k)</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">        attrs[<span class="string">&#x27;__CrawlFuncCount__&#x27;</span>] = count</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>.__new__(cls, name, bases, attrs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Crawler</span>(<span class="built_in">object</span>, metaclass=ProxyMetaclass):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_proxies</span>(<span class="params">self, callback</span>):</span><br><span class="line">        proxies = []</span><br><span class="line">        <span class="keyword">for</span> proxy <span class="keyword">in</span> <span class="built_in">eval</span>(<span class="string">&quot;self.&#123;&#125;()&quot;</span>.<span class="built_in">format</span>(callback)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27; 成功获取到代理 &#x27;</span>, proxy)</span><br><span class="line">            proxies.append(proxy)</span><br><span class="line">        <span class="keyword">return</span> proxies</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl_daili66</span>(<span class="params">self, page_count=<span class="number">4</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取代理 66</span></span><br><span class="line"><span class="string">        :param page_count: 页码</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        start_url = <span class="string">&#x27;http://www.66ip.cn/&#123;&#125;.html&#x27;</span></span><br><span class="line">        urls = [start_url.<span class="built_in">format</span>(page) <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, page_count + <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Crawling&#x27;</span>, url)</span><br><span class="line">            html = get_page(url)</span><br><span class="line">            <span class="keyword">if</span> html:</span><br><span class="line">                doc = pq(html)</span><br><span class="line">                trs = doc(<span class="string">&#x27;.containerbox table tr:gt(0)&#x27;</span>).items()</span><br><span class="line">                <span class="keyword">for</span> tr <span class="keyword">in</span> trs:</span><br><span class="line">                    ip = tr.find(<span class="string">&#x27;td:nth-child(1)&#x27;</span>).text()</span><br><span class="line">                    port = tr.find(<span class="string">&#x27;td:nth-child(2)&#x27;</span>).text()</span><br><span class="line">                    <span class="keyword">yield</span> <span class="string">&#x27;:&#x27;</span>.join([ip, port])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl_proxy360</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取 Proxy360</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        start_url = <span class="string">&#x27;http://www.proxy360.cn/Region/China&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Crawling&#x27;</span>, start_url)</span><br><span class="line">        html = get_page(start_url)</span><br><span class="line">        <span class="keyword">if</span> html:</span><br><span class="line">            doc = pq(html)</span><br><span class="line">            lines = doc(<span class="string">&#x27;div[name=&quot;list_proxy_ip&quot;]&#x27;</span>).items()</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                ip = line.find(<span class="string">&#x27;.tbBottomLine:nth-child(1)&#x27;</span>).text()</span><br><span class="line">                port = line.find(<span class="string">&#x27;.tbBottomLine:nth-child(2)&#x27;</span>).text()</span><br><span class="line">                <span class="keyword">yield</span> <span class="string">&#x27;:&#x27;</span>.join([ip, port])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl_goubanjia</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取 Goubanjia</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        start_url = <span class="string">&#x27;http://www.goubanjia.com/free/gngn/index.shtml&#x27;</span></span><br><span class="line">        html = get_page(start_url)</span><br><span class="line">        <span class="keyword">if</span> html:</span><br><span class="line">            doc = pq(html)</span><br><span class="line">            tds = doc(<span class="string">&#x27;td.ip&#x27;</span>).items()</span><br><span class="line">            <span class="keyword">for</span> td <span class="keyword">in</span> tds:</span><br><span class="line">                td.find(<span class="string">&#x27;p&#x27;</span>).remove()</span><br><span class="line">                <span class="keyword">yield</span> td.text().replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> crawler <span class="keyword">import</span> Crawler</span><br><span class="line"></span><br><span class="line">POOL_UPPER_THRESHOLD = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Getter</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line">        self.crawler = Crawler()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_over_threshold</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;判断是否达到了代理池限制&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.redis.count()&gt;= POOL_UPPER_THRESHOLD:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; 获取器开始执行 &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_over_threshold():</span><br><span class="line">            <span class="keyword">for</span> callback_label <span class="keyword">in</span> <span class="built_in">range</span>(self.crawler.__CrawlFuncCount__):</span><br><span class="line">                callback = self.crawler.__CrawlFunc__[callback_label]</span><br><span class="line">                proxies = self.crawler.get_proxies(callback)</span><br><span class="line">                <span class="keyword">for</span> proxy <span class="keyword">in</span> proxies:</span><br><span class="line">                    self.redis.add(proxy)</span><br></pre></td></tr></table></figure>
</li>
<li><p>检测模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">VALID_STATUS_CODES = [<span class="number">200</span>]</span><br><span class="line">TEST_URL = <span class="string">&#x27;http://www.baidu.com&#x27;</span></span><br><span class="line">BATCH_TEST_SIZE = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tester</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_single_proxy</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        测试单个代理</span></span><br><span class="line"><span class="string">        :param proxy: 单个代理</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        conn = aiohttp.TCPConnector(verify_ssl=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=conn) <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(proxy, <span class="built_in">bytes</span>):</span><br><span class="line">                    proxy = proxy.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">                real_proxy = <span class="string">&#x27;http://&#x27;</span> + proxy</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27; 正在测试 &#x27;</span>, proxy)</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> session.get(TEST_URL, proxy=real_proxy, timeout=<span class="number">15</span>) <span class="keyword">as</span> response:</span><br><span class="line">                    <span class="keyword">if</span> response.status <span class="keyword">in</span> VALID_STATUS_CODES:</span><br><span class="line">                        self.redis.<span class="built_in">max</span>(proxy)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27; 代理可用 &#x27;</span>, proxy)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.redis.decrease(proxy)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27; 请求响应码不合法 &#x27;</span>, proxy)</span><br><span class="line">            <span class="keyword">except</span> (ClientError, ClientConnectorError, TimeoutError, AttributeError):</span><br><span class="line">                self.redis.decrease(proxy)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27; 代理请求失败 &#x27;</span>, proxy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        测试主函数</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27; 测试器开始运行 &#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            proxies = self.redis.<span class="built_in">all</span>()</span><br><span class="line">            loop = asyncio.get_event_loop()</span><br><span class="line">            <span class="comment"># 批量测试</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(proxies), BATCH_TEST_SIZE):</span><br><span class="line">                test_proxies = proxies[i:i + BATCH_TEST_SIZE]</span><br><span class="line">                tasks = [self.test_single_proxy(proxy) <span class="keyword">for</span> proxy <span class="keyword">in</span> test_proxies]</span><br><span class="line">                loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">                time.sleep(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27; 测试器发生错误 &#x27;</span>, e.args)</span><br></pre></td></tr></table></figure>
</li>
<li><p>接口模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> RedisClient</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">&#x27;app&#x27;</span>]</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_conn</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(g, <span class="string">&#x27;redis&#x27;</span>):</span><br><span class="line">        g.redis = RedisClient()</span><br><span class="line">    <span class="keyword">return</span> g.redis</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h2&gt;Welcome to Proxy Pool System&lt;/h2&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/random&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_proxy</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取随机可用代理</span></span><br><span class="line"><span class="string">    :return: 随机代理</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> conn.random()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/count&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_counts</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取代理池总量</span></span><br><span class="line"><span class="string">    :return: 代理池总量</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(conn.count())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="付费代理"><a href="#付费代理" class="headerlink" title="付费代理"></a>付费代理</h2><p>付费代理分为两类：</p>
<ul>
<li>一类提供接口获取海量代理</li>
<li>一类搭建了代理隧道，设置固定域名代理</li>
</ul>
<p>可以尝试<a target="_blank" rel="noopener" href="http://www.xdaili.cn/">讯代理</a>，<a target="_blank" rel="noopener" href="https://www.abuyun.com/">阿布云代理</a></p>
<h2 id="ADSL拨号代理"><a href="#ADSL拨号代理" class="headerlink" title="ADSL拨号代理"></a>ADSL拨号代理</h2><p>ADSL，非对称数字用户环路，上行和下行带宽部队称，采用频分服用技术将普通电话线分为电话，上行和下行3个独立信道</p>
<p>ADSL拨号上网每次拨号就更换一个IP，IP分布在多个A段，主机稳定性很好，响应也很快</p>
<blockquote>
<p>购买可以使用<a target="_blank" rel="noopener" href="http://www.yunlifang.cn/dynamicvps.asp">云立方</a>，安装系统后进行拨号</p>
</blockquote>
<h3 id="设置代理服务器"><a href="#设置代理服务器" class="headerlink" title="设置代理服务器"></a>设置代理服务器</h3><ul>
<li><p>安装TinyProxy</p>
</li>
<li><p>配置TinyProxy</p>
<p>配置文件路径为&#x2F;etc&#x2F;tinyproxy&#x2F;tinyproxy.conf，设置端口，允许主机</p>
</li>
<li><p>动态获取IP</p>
<p>可以执行命令让主机动态切换IP，切换途中不可用，接口数据最理想的还是使用数据库存储，可以使用MySQL或者Redis的Hash存储</p>
</li>
<li><p>实现</p>
<ul>
<li><p>首先操作Redis数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis 数据库 IP</span></span><br><span class="line">REDIS_HOST = <span class="string">&#x27;remoteaddress&#x27;</span></span><br><span class="line"><span class="comment"># Redis 数据库密码，如无则填 None</span></span><br><span class="line">REDIS_PASSWORD = <span class="string">&#x27;foobared&#x27;</span></span><br><span class="line"><span class="comment"># Redis 数据库端口</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span></span><br><span class="line"><span class="comment"># 代理池键名</span></span><br><span class="line">PROXY_KEY = <span class="string">&#x27;adsl&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisClient</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host=REDIS_HOST, port=REDIS_PORT, password=REDIS_PASSWORD, proxy_key=PROXY_KEY</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化 Redis 连接</span></span><br><span class="line"><span class="string">        :param host: Redis 地址</span></span><br><span class="line"><span class="string">        :param port: Redis 端口</span></span><br><span class="line"><span class="string">        :param password: Redis 密码</span></span><br><span class="line"><span class="string">        :param proxy_key: Redis 哈希表名</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.db = redis.StrictRedis(host=host, port=port, password=password, decode_responses=<span class="literal">True</span>)</span><br><span class="line">        self.proxy_key = proxy_key</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, name, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        设置代理</span></span><br><span class="line"><span class="string">        :param name: 主机名称</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 设置结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.db.hset(self.proxy_key, name, proxy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取代理</span></span><br><span class="line"><span class="string">        :param name: 主机名称</span></span><br><span class="line"><span class="string">        :return: 代理</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.db.hget(self.proxy_key, name)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">count</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取代理总数</span></span><br><span class="line"><span class="string">        :return: 代理总数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.db.hlen(self.proxy_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        删除代理</span></span><br><span class="line"><span class="string">        :param name: 主机名称</span></span><br><span class="line"><span class="string">        :return: 删除结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.db.hdel(self.proxy_key, name)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">names</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取主机名称列表</span></span><br><span class="line"><span class="string">        :return: 获取主机名称列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.db.hkeys(self.proxy_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">proxies</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取代理列表</span></span><br><span class="line"><span class="string">        :return: 代理列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.db.hvals(self.proxy_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        随机获取代理</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        proxies = self.proxies()</span><br><span class="line">        <span class="keyword">return</span> random.choice(proxies)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">all</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取字典</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span><span class="keyword">return</span> self.db.hgetall(self.proxy_key)</span><br></pre></td></tr></table></figure>
</li>
<li><p>定时拨号</p>
<p>在服务器上定时拨号更换IP，并向数据库更新信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> ConnectionError, ReadTimeout</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> RedisClient</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拨号网卡</span></span><br><span class="line">ADSL_IFNAME = <span class="string">&#x27;ppp0&#x27;</span></span><br><span class="line"><span class="comment"># 测试 URL</span></span><br><span class="line">TEST_URL = <span class="string">&#x27;http://www.baidu.com&#x27;</span></span><br><span class="line"><span class="comment"># 测试超时时间</span></span><br><span class="line">TEST_TIMEOUT = <span class="number">20</span></span><br><span class="line"><span class="comment"># 拨号间隔</span></span><br><span class="line">ADSL_CYCLE = <span class="number">100</span></span><br><span class="line"><span class="comment"># 拨号出错重试间隔</span></span><br><span class="line">ADSL_ERROR_CYCLE = <span class="number">5</span></span><br><span class="line"><span class="comment"># ADSL 命令</span></span><br><span class="line">ADSL_BASH = <span class="string">&#x27;adsl-stop;adsl-start&#x27;</span></span><br><span class="line"><span class="comment"># 代理运行端口</span></span><br><span class="line">PROXY_PORT = <span class="number">8888</span></span><br><span class="line"><span class="comment"># 客户端唯一标识</span></span><br><span class="line">CLIENT_NAME = <span class="string">&#x27;adsl1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sender</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ip</span>(<span class="params">self, ifname=ADSL_IFNAME</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取本机 IP</span></span><br><span class="line"><span class="string">        :param ifname: 网卡名称</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        (status, output) = subprocess.getstatusoutput(<span class="string">&#x27;ifconfig&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">            pattern = re.<span class="built_in">compile</span>(ifname + <span class="string">&#x27;.*?inet.*?(\d+\.\d+\.\d+\.\d+).*?netmask&#x27;</span>, re.S)</span><br><span class="line">            result = re.search(pattern, output)</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                ip = result.group(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span> ip</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_proxy</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        测试代理</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: 测试结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.get(TEST_URL, proxies=&#123;</span><br><span class="line">                <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">                <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">            &#125;, timeout=TEST_TIMEOUT)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> (ConnectionError, ReadTimeout):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_proxy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        移除代理</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line">        self.redis.remove(CLIENT_NAME)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Successfully Removed Proxy&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_proxy</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        设置代理</span></span><br><span class="line"><span class="string">        :param proxy: 代理</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line">        <span class="keyword">if</span> self.redis.<span class="built_in">set</span>(CLIENT_NAME, proxy):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Successfully Set Proxy&#x27;</span>, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">adsl</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        拨号主进程</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ADSL Start, Remove Proxy, Please wait&#x27;</span>)</span><br><span class="line">            self.remove_proxy()</span><br><span class="line">            (status, output) = subprocess.getstatusoutput(ADSL_BASH)</span><br><span class="line">            <span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;ADSL Successfully&#x27;</span>)</span><br><span class="line">                ip = self.get_ip()</span><br><span class="line">                <span class="keyword">if</span> ip:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;Now IP&#x27;</span>, ip)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;Testing Proxy, Please Wait&#x27;</span>)</span><br><span class="line">                    proxy = <span class="string">&#x27;&#123;ip&#125;:&#123;port&#125;&#x27;</span>.<span class="built_in">format</span>(ip=ip, port=PROXY_PORT)</span><br><span class="line">                    <span class="keyword">if</span> self.test_proxy(proxy):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;Valid Proxy&#x27;</span>)</span><br><span class="line">                        self.set_proxy(proxy)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;Sleeping&#x27;</span>)</span><br><span class="line">                        time.sleep(ADSL_CYCLE)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;Invalid Proxy&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;Get IP Failed, Re Dialing&#x27;</span>)</span><br><span class="line">                    time.sleep(ADSL_ERROR_CYCLE)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;ADSL Failed, Please Check&#x27;</span>)</span><br><span class="line">                time.sleep(ADSL_ERROR_CYCLE)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    sender = Sender()</span><br><span class="line">    sender.adsl()</span><br></pre></td></tr></table></figure>
</li>
<li><p>接口模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> tornado.web <span class="keyword">import</span> RequestHandler, Application</span><br><span class="line"></span><br><span class="line"><span class="comment"># API 端口</span></span><br><span class="line">API_PORT = <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainHandler</span>(<span class="title class_ inherited__">RequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">self, redis</span>):</span><br><span class="line">        self.redis = redis</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, api=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> api:</span><br><span class="line">            links = [<span class="string">&#x27;random&#x27;</span>, <span class="string">&#x27;proxies&#x27;</span>, <span class="string">&#x27;names&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;count&#x27;</span>]</span><br><span class="line">            self.write(<span class="string">&#x27;&lt;h4&gt;Welcome to ADSL Proxy API&lt;/h4&gt;&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">                self.write(<span class="string">&#x27;&lt;a href=&#x27;</span> + link + <span class="string">&#x27;&gt;&#x27;</span> + link + <span class="string">&#x27;&lt;/a&gt;&lt;br&gt;&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> api == <span class="string">&#x27;random&#x27;</span>:</span><br><span class="line">            result = self.redis.random()</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                self.write(result)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> api == <span class="string">&#x27;names&#x27;</span>:</span><br><span class="line">            result = self.redis.names()</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                self.write(json.dumps(result))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> api == <span class="string">&#x27;proxies&#x27;</span>:</span><br><span class="line">            result = self.redis.proxies()</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                self.write(json.dumps(result))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> api == <span class="string">&#x27;all&#x27;</span>:</span><br><span class="line">            result = self.redis.<span class="built_in">all</span>()</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                self.write(json.dumps(result))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> api == <span class="string">&#x27;count&#x27;</span>:</span><br><span class="line">            self.write(<span class="built_in">str</span>(self.redis.count()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server</span>(<span class="params">redis, port=API_PORT, address=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    application = Application([(<span class="string">r&#x27;/&#x27;</span>, MainHandler, <span class="built_in">dict</span>(redis=redis)),</span><br><span class="line">        (<span class="string">r&#x27;/(.*)&#x27;</span>, MainHandler, <span class="built_in">dict</span>(redis=redis)),</span><br><span class="line">    ])</span><br><span class="line">    application.listen(port, address=address)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ADSL API Listening on&#x27;</span>, port)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="请求队列"><a href="#请求队列" class="headerlink" title="请求队列"></a>请求队列</h2><p>对于反爬能力很强的网站，可以借助数据库构造爬取队列，将待爬取的请求都放到队列中，请求失败时重新放回队列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> dumps, loads</span><br><span class="line"><span class="keyword">from</span> request <span class="keyword">import</span> WeixinRequest</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisQueue</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;初始化 Redis&quot;&quot;&quot;</span></span><br><span class="line">        self.db = StrictRedis(host=REDIS_HOST, port=REDIS_PORT, password=REDIS_PASSWORD)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        向队列添加序列化后的 Request</span></span><br><span class="line"><span class="string">        :param request: 请求对象</span></span><br><span class="line"><span class="string">        :param fail_time: 失败次数</span></span><br><span class="line"><span class="string">        :return: 添加结果</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(request, WeixinRequest):</span><br><span class="line">            <span class="keyword">return</span> self.db.rpush(REDIS_KEY, dumps(request))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        取出下一个 Request 并反序列化</span></span><br><span class="line"><span class="string">        :return: Request or None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.db.llen(REDIS_KEY):</span><br><span class="line">            <span class="keyword">return</span> loads(self.db.lpop(REDIS_KEY))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">empty</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.db.llen(REDIS_KEY) == <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h1 id="模拟登陆"><a href="#模拟登陆" class="headerlink" title="模拟登陆"></a>模拟登陆</h1><h2 id="登陆"><a href="#登陆" class="headerlink" title="登陆"></a>登陆</h2><ul>
<li><p>请求登陆的Cookie可能是在请求页面以Set-Cookie的形式传送，加密方式可能隐藏在输入的源码中</p>
</li>
<li><p>登陆一般会发送一个post请求，请求会携带登陆前录入的相关信息</p>
</li>
<li><p>一些网站在登陆后拿到的不一定会是页面源码，可以使用pose请求的响应状态码判断登陆是否成功</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.status_code	<span class="comment"># 获取响应状态码，200为登陆成功</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>一般来说，登陆后反爬的概率较低</p>
</blockquote>
<h2 id="cookie操作"><a href="#cookie操作" class="headerlink" title="cookie操作"></a>cookie操作</h2><ul>
<li>http&#x2F;https协议特性：无状态</li>
<li>cookie：用来让服务器端记录客户端的相关状态 <ul>
<li>手动cookie处理：手动写headers(处理麻烦，可能有有效时长)</li>
<li>自动处理：一般cookie可以从post请求中获取</li>
</ul>
</li>
</ul>
<h3 id="session会话对象"><a href="#session会话对象" class="headerlink" title="session会话对象"></a>session会话对象</h3><ul>
<li><p>可以进行请求的发送</p>
</li>
<li><p>如果请求中产生了cookie，则cookie会被存储在该session对象中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session = request.Session()	<span class="comment"># 创建session对象</span></span><br><span class="line">session.post()	<span class="comment"># 使用session进行post请求发送</span></span><br><span class="line">session.get()</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Cookie池"><a href="#Cookie池" class="headerlink" title="Cookie池"></a>Cookie池</h3><p>Cookie池可以存储登陆后的Cookies信息，定时检测Cookie的有效性，在Cookie无效后删除并模拟登陆生成新的Cookie，Cookie池与代理池结构类似</p>
<h1 id="异步爬虫"><a href="#异步爬虫" class="headerlink" title="异步爬虫"></a>异步爬虫</h1><h2 id="分类-3"><a href="#分类-3" class="headerlink" title="分类"></a>分类</h2><ul>
<li><p>多线程，多进程(不建议)</p>
<ul>
<li>好处：可以为相关阻塞操作开启单独线程或进程</li>
<li>弊端：无法无限制开启多线程或多进程</li>
</ul>
</li>
<li><p>进程池，线程池(适当使用)：</p>
<ul>
<li>好处：降低系统对进程或线程创建和销毁的频率，降低系统的开销</li>
<li>弊端：池中线程或进程的数量有上限(如果阻塞方法远大于池中线程数量，效果不明显)</li>
<li>原则：线程池处理的是阻塞且耗时的操作(视频的下载，写入文件…)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool</span><br><span class="line"></span><br><span class="line">pool = Pool(<span class="number">4</span>)	<span class="comment"># 实例化一个线程池对象</span></span><br><span class="line">pool.<span class="built_in">map</span>(method, <span class="built_in">list</span>)	<span class="comment"># 将列表中的元素交给方法进行处理</span></span><br><span class="line">pool.close()	<span class="comment"># 关闭线程池</span></span><br><span class="line">pool.join()	<span class="comment"># 主线程等待子线程结束</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>单线程+异步协程</p>
<ul>
<li><p>event_loop：事件循环，可以将函数注册到事件循环上，当满足条件，函数就会被循环执行</p>
</li>
<li><p>coroutine：协程对象，可以将协程对象注册到时间循环中，其会被事件循环调用</p>
<ul>
<li>async关键字可以定义一个方法，在调用时不会被立即执行，而是返回一个协程对象</li>
</ul>
</li>
<li><p>task：任务，对协程对象的进一步封装，包含了任务的各个状态</p>
</li>
<li><p>future：代表将来执行或还没有执行的任务，实际和task没有本质区别(实现方式不同)</p>
</li>
<li><p>async：定义一个协程</p>
</li>
<li><p>await：挂起阻塞方法的执行</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio	<span class="comment"># 导入包</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">request</span>():	<span class="comment"># 定义一个方法，调用时不会立即执行，而是返回一个协程对象</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">c = request()	<span class="comment"># 接收协程对象</span></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()	<span class="comment"># 创建一个事件循环对象</span></span><br><span class="line"></span><br><span class="line">task1 = loop.create_task(c)	<span class="comment"># 基于loop创建一个task任务对象</span></span><br><span class="line">							<span class="comment"># pending表示待执行，finished表示已执行</span></span><br><span class="line">task2 = asyncio.ensure_future(c)	<span class="comment"># 创建一个future任务对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">callback_func</span>(<span class="params">task</span>):	<span class="comment"># 定义回调函数，默认会将任务对象作为参数传入</span></span><br><span class="line">    task.result()	<span class="comment"># 返回任务的结果，即任务方法的返回值</span></span><br><span class="line">task.add_done_callback(callback_func)	<span class="comment"># 绑定回调函数，在任务执行完成后调用</span></span><br><span class="line"></span><br><span class="line">loop.run_until_complete(c)	<span class="comment"># 将协程对象或任务对象注册到loop中，并启动循环</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>多任务协程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tasks = [task1, ...]	<span class="comment"># 创建任务列表</span></span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))	<span class="comment"># 不能将tasks直接传入</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在异步协程中出现了同步模块相关的代码，那么就无法实现异步</p>
<p>time.sleep(2)  –&gt; await asyncio.sleep(2)</p>
<p>遇到阻塞操作要用await手动挂起</p>
</blockquote>
</li>
</ul>
<h2 id="aiohttp"><a href="#aiohttp" class="headerlink" title="aiohttp"></a>aiohttp</h2><p>在异步协程中出现了同步模块相关的代码，那么就无法实现异步，例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time.sleep(<span class="number">2</span>)  --&gt; <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)	<span class="comment"># 遇到阻塞操作要用await手动挂起</span></span><br></pre></td></tr></table></figure>

<p>request库中请求是基于同步的，异步需要使用aiohttp库</p>
<ul>
<li><p>安装</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install aiohttp</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> <span class="keyword">await</span> session.get (url) <span class="keyword">as</span> response:	<span class="comment"># 要用await手动挂起</span></span><br><span class="line">        page_text = <span class="keyword">await</span> response.text()	<span class="comment"># text在此处为方法</span></span><br><span class="line">        page_content = <span class="keyword">await</span> response.read()	<span class="comment"># read返回二进制形式的数据</span></span><br><span class="line">        page_json = <span class="keyword">await</span> response.json()	<span class="comment"># 返回json对象</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>这里的get和post的proxy参数传入的为一个字符串而非字典</p>
</blockquote>
<h1 id="scrapy框架"><a href="#scrapy框架" class="headerlink" title="scrapy框架"></a>scrapy框架</h1><h2 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h2><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src="https://raw.githubusercontent.com/chanochLi/photo/master/blog_pic/13-1.jpg" alt="13-1"></p>
<ul>
<li>Engine，引擎，用来处理整个系统的数据流处理，触发事务，是整个框架的核心</li>
<li>Item，项目，它定义了爬取结果的数据结构，爬取的数据会被赋值成该对象</li>
<li>Scheduler， 调度器，用来接受引擎发过来的请求并加入队列中，并在引擎再次请求的时候提供给引擎</li>
<li>Downloader，下载器，用于下载网页内容，并将网页内容返回给蜘蛛</li>
<li>Spiders，蜘蛛，其内定义了爬取的逻辑和网页的解析规则，它主要负责解析响应并生成提取结果和新的请求</li>
<li>Item Pipeline，项目管道，负责处理由蜘蛛从网页中抽取的项目，它的主要任务是清洗、验证和存储数据</li>
<li>Downloader Middlewares，下载器中间件，位于引擎和下载器之间的钩子框架，主要是处理引擎与下载器之间的请求及响应</li>
<li>Spider Middlewares， 蜘蛛中间件，位于引擎和蜘蛛之间的钩子框架，主要工作是处理蜘蛛输入的响应和输出的结果及新的请求</li>
</ul>
<h3 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h3><ul>
<li>高性能的持久化存储</li>
<li>异步的数据下载</li>
<li>高性能的数据解析</li>
<li>分布式</li>
</ul>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><ul>
<li>Engine 首先打开一个网站，找到处理该网站的 Spider 并向该 Spider 请求第一个要爬取的 URL</li>
<li>Engine 从 Spider 中获取到第一个要爬取的 URL 并通过 Scheduler 以 Request 的形式调度</li>
<li>Engine 向 Scheduler 请求下一个要爬取的 URL</li>
<li>Scheduler 返回下一个要爬取的 URL 给 Engine，Engine 将 URL 通过 Downloader Middlewares 转发给 Downloader 下载</li>
<li>一旦页面下载完毕， Downloader 生成一个该页面的 Response，并将其通过 Downloader Middlewares 发送给 Engine</li>
<li>Engine 从下载器中接收到 Response 并通过 Spider Middlewares 发送给 Spider 处理。</li>
<li>Spider 处理 Response 并返回爬取到的 Item 及新的 Request 给 Engine</li>
<li>Engine 将 Spider 返回的 Item 给 Item Pipeline，将新的 Request 给 Scheduler</li>
<li>重复第二步到最后一步，直到  Scheduler 中没有更多的 Request，Engine 关闭该网站，爬取结束</li>
</ul>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">scrapy<span class="selector-class">.cfg</span></span><br><span class="line">project/</span><br><span class="line">    __init__<span class="selector-class">.py</span></span><br><span class="line">    items<span class="selector-class">.py</span></span><br><span class="line">    pipelines<span class="selector-class">.py</span></span><br><span class="line">    settings<span class="selector-class">.py</span></span><br><span class="line">    middlewares<span class="selector-class">.py</span></span><br><span class="line">    spiders/</span><br><span class="line">        __init__<span class="selector-class">.py</span></span><br><span class="line">        spider1<span class="selector-class">.py</span></span><br><span class="line">        spider2<span class="selector-class">.py</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<ul>
<li><p>scrapy.cfg：它是 Scrapy 项目的配置文件，其内定义了项目的配置文件路径、部署相关信息等内容</p>
</li>
<li><p>items.py：它定义 Item 数据结构，所有的 Item 的定义都可以放这里</p>
</li>
<li><p>pipelines.py：它定义 Item Pipeline 的实现，所有的 Item Pipeline 的实现都可以放这里</p>
</li>
<li><p>settings.py：它定义项目的全局配置</p>
</li>
<li><p>middlewares.py：它定义 Spider Middlewares 和 Downloader Middlewares 的实现</p>
</li>
<li><p>spiders：其内包含一个个 Spider 的实现，每个 Spider 都有一个文件</p>
</li>
</ul>
<h2 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install scrapy</span><br></pre></td></tr></table></figure>

<h2 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h2><h3 id="工程指令"><a href="#工程指令" class="headerlink" title="工程指令"></a>工程指令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">scrapy startproject xxx	<span class="comment"># 创建一个scrapy工程</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> xxx	<span class="comment"># 进入工程目录</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">scrapy genspider spiderName www.xxx.com	<span class="comment"># 生成爬虫文件，指定名称和初始网址</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">scrapy crawl spiderName	<span class="comment"># 执行特定爬虫</span></span></span><br></pre></td></tr></table></figure>

<h3 id="爬虫文件"><a href="#爬虫文件" class="headerlink" title="爬虫文件"></a>爬虫文件</h3><ul>
<li><p>爬虫类：父类为scrapy.Spider</p>
<ul>
<li><p>属性：</p>
<ul>
<li><p>name：爬虫文件的名称，已经设定</p>
</li>
<li><p>allowed_domains &#x3D; [‘ ‘]：允许的域名，限定start_urls中哪些url可以被请求</p>
</li>
<li><p>start_urls &#x3D; [‘’]：起始url列表，会被scrapy进行自动请求发送</p>
<blockquote>
<p>但一般allowed_domains一般注释不使用</p>
</blockquote>
</li>
</ul>
</li>
<li><p>方法：</p>
<ul>
<li><p>parse(self, response)：该方法负责解析返回的响应、提取数据或者进一步生成要处理的请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, response</span>):</span><br><span class="line">    selector_list = response.xpath(<span class="string">&#x27;&#x27;</span>)	<span class="comment"># 对响应对象使用xpath</span></span><br><span class="line">    									<span class="comment"># 返回的是Selector对象列表</span></span><br><span class="line">    selector.extract()	<span class="comment"># 调用selector对象extract方法提取，返回内容</span></span><br><span class="line">    selector_list.extract()	<span class="comment"># 对每个对象调用extract方法，返回仍为列表</span></span><br><span class="line">    selector_list.extract_first()	<span class="comment"># 若保证只有一个元素，对其解析</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>scrapy中response.text获取html，response.body获取二进制</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><ul>
<li>ROBOTSTXT_OBEY：是否遵从robots协议</li>
<li>LOG_LEVEL：输出日志类型，’ERROR’等</li>
<li>USER_AGENT：scrapy所使用的UA伪装</li>
<li>ITEM_PIPELINES：字典，键为管道类名，值为管道优先级，越小优先级越高</li>
<li>IMAGES_STORE：字符串，指定ImagePipeline存储图片的目录</li>
</ul>
<h3 id="持久化存储-Item和Pipeline"><a href="#持久化存储-Item和Pipeline" class="headerlink" title="持久化存储(Item和Pipeline)"></a>持久化存储(Item和Pipeline)</h3><ul>
<li><p>基于终端指令</p>
<ul>
<li>要求：只能将parse方法的返回值存储到本地的特定类型的文件中</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">scrapy crawl spiderName -o file	<span class="comment"># 将解析的输出保存到文件</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>文件类型只能为json，jsonlines，jl，csv，xml，marshal，pickle</li>
</ul>
</li>
<li><p>基于管道</p>
<ul>
<li><p>流程：</p>
<ul>
<li><p>数据解析</p>
</li>
<li><p>在item.py的item类中定义相关的属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content = scrapy.Field()	<span class="comment"># 使用方法封装属性</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将解析的数据封装存储到item类型的对象中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">item = xxxItem()</span><br><span class="line">item[<span class="string">&#x27;content&#x27;</span>] = xxx	<span class="comment"># 需要使用[&#x27;&#x27;]访问，不能用.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将item类型的对象提交给管道进行持久化存储</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> item	<span class="comment"># 使用yield进行异步返回</span></span><br></pre></td></tr></table></figure>

<p>修改pipelines.py中的process_item进行修改，进行存储</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">xxxPipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    fp = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open_spider</span>(<span class="params">self, spider</span>):</span><br><span class="line">    <span class="comment"># 重写父类方法，只会在开始时调用一次，打开文件只需一次</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">       	xxx = item[<span class="string">&#x27;author&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回的item会传递给次优先级的管道</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close_spider</span>(<span class="params">self,spider</span>):</span><br><span class="line">    <span class="comment"># 只会在结束时调用一次，可以用于关闭文件</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在配置文件中开启管道</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="全站爬取-CrawlSpider"><a href="#全站爬取-CrawlSpider" class="headerlink" title="全站爬取(CrawlSpider)"></a>全站爬取(CrawlSpider)</h3><ul>
<li><p>就将网站某板块下全部页码(分页)下的全部数据爬取</p>
</li>
<li><p>手动请求发送</p>
<ul>
<li><p>将所有页面的元素加入到start_urls中(不推荐)</p>
</li>
<li><p>实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> parse(self, response):</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 用新的url请求，并回调parse进行解析，为递归，需要退出条件</span></span><br><span class="line">    <span class="keyword">yield</span> scrapy.Request(url=new_url, callback=self.parse)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>CrawlSpider类：Spider的一个子类，用于全站数据爬取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">scrapy genspider -t crawl xxx www.xxx.com	<span class="comment"># 基于cralSpicder创建爬虫文件</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</span><br><span class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestSpider</span>(<span class="title class_ inherited__">CrawlSpider</span>):</span><br><span class="line">	<span class="comment"># 链接提取器</span></span><br><span class="line">    link = LinkExtractor(allow=<span class="string">r&#x27;&#x27;</span>)	<span class="comment"># allow指定规则，输入正则表达式</span></span><br><span class="line">    <span class="comment"># 规则解析器</span></span><br><span class="line">    <span class="comment"># follow决定是否对子页面也进行提取</span></span><br><span class="line">    rules = (Rule(link, callback=<span class="string">&#x27;parse_item&#x27;</span>, follow=<span class="literal">False</span>),)</span><br></pre></td></tr></table></figure>

<ul>
<li>链接提取器：根据指定规则(allow参数的正则)进行指定链接的提取</li>
<li>规则解析器：对链接提取器提取的链接进行制定规则(callback)的解析</li>
</ul>
</li>
</ul>
<h3 id="请求传参"><a href="#请求传参" class="headerlink" title="请求传参"></a>请求传参</h3><ul>
<li><p>使用场景：解析的数据不在同一张页面中(深度爬取)</p>
</li>
<li><p>使用meta参数传送，使用meta方法接受</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> scrapy.Request(url, callback=self.parse1, meta=item)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse1</span>(<span class="params">self, response</span>):</span><br><span class="line">    item = response.meta[<span class="string">&#x27;item&#x27;</span>]</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="图片爬取ImagesPipeline"><a href="#图片爬取ImagesPipeline" class="headerlink" title="图片爬取ImagesPipeline"></a>图片爬取ImagesPipeline</h3><ul>
<li><p>对比</p>
<ul>
<li>字符串：只需要基于xpath解析且提交管道进行持久化存储</li>
<li>图片：xpath解析出src属性值，还需单独对图片发送请求获取二进制数据</li>
</ul>
</li>
<li><p>基于ImagesPipeline</p>
<ul>
<li><p>只需要解析出图片的地址，提交到管道，不需要传送二进制，管道会请求二进制数据并进行存储</p>
</li>
<li><p>用IMAGES——STORE指定存储目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.pipelines.images <span class="keyword">import</span> ImagesPipeline</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YandeReDbPipeline</span>(<span class="title class_ inherited__">ImagesPipeline</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重写父类方法，获取图片响应对象</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_media_requests</span>(<span class="params">self, item, info</span>):</span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(url=item[<span class="string">&#x27;src&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重写父类方法，获取图片存储路径</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">file_path</span>(<span class="params">self, request, response=<span class="literal">None</span>, info=<span class="literal">None</span>, *, item=<span class="literal">None</span></span>):</span><br><span class="line">        imgName = request.url.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">yield</span> imgName</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重写父类方法，返回item给下一个管道</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">item_completed</span>(<span class="params">self, results, item, info</span>):</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>图片懒加载</p>
<ul>
<li>使用src2伪属性，被拖动到可视区域，才会变为src进行加载</li>
<li>scrapy没有可视化，需要对伪属性进行解析</li>
</ul>
</li>
</ul>
<h3 id="分布式爬虫"><a href="#分布式爬虫" class="headerlink" title="分布式爬虫"></a>分布式爬虫</h3><ul>
<li><p>搭建一个分布式的机群，对一组资源进行分布联合爬取，提升爬虫效率</p>
</li>
<li><p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install scrapy-redis	# 原生scrapy不能实现分布式爬虫</span><br><span class="line">							# 组件可以实现调度器和管道的共享</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现流程</p>
<ul>
<li><p>修改爬虫文件</p>
<ul>
<li><p>导入模块，将爬虫类父类修改为RedisCrawlSpider</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy_redis.spiders <span class="keyword">import</span> RedisCrawlSpider</span><br></pre></td></tr></table></figure>
</li>
<li><p>注释start_urls和allowed_domains进行注释，加入redis_key&#x3D;’name’属性，表示可以被共享的调度器队列</p>
</li>
<li><p>编写数据解析相关为操作</p>
</li>
</ul>
</li>
<li><p>修改配置文件</p>
<ul>
<li><p>指定可以被共享的管道</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="string">&#x27;scrapy_redis.pipelines.RedisPipeline&#x27;</span>:<span class="number">400</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定调度器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DUPEFILTER_CLASS = <span class="string">&#x27;scrapy_redis.dupefilter.RFPDupeFilter&#x27;</span>	<span class="comment"># 过滤器</span></span><br><span class="line">SCHEDULER = <span class="string">&#x27;scrapy_redis.scheduler.Scheduler&#x27;</span>	<span class="comment"># 调度器</span></span><br><span class="line">SCHEDULER_PERSIST = <span class="literal">True</span>	<span class="comment"># 是否持久化</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>redis相关配置：</p>
<ul>
<li><p>注释bind 127.0.0.1，否则其它客户端不能访问</p>
</li>
<li><p>关闭保护模式：protected-mode no，否则其它客户端不能写数据</p>
</li>
<li><p>开启redis服务</p>
</li>
<li><p>指定redis服务器(默认为本机)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REDIS_HOST = <span class="string">&#x27;ip&#x27;</span></span><br><span class="line">REDIS_PORT = port</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>执行工程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">scrapy runspider xxx.py</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>向调度器的队列放入一个起始url</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lpush redis_key www.xxx.com</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="增量式爬虫"><a href="#增量式爬虫" class="headerlink" title="增量式爬虫"></a>增量式爬虫</h3><ul>
<li>可以使用redis的set，加入判断，根据返回值决定是否爬取</li>
</ul>
<h3 id="Spider"><a href="#Spider" class="headerlink" title="Spider"></a>Spider</h3><ul>
<li>对url封装为请求对象</li>
<li>对响应对象进行解析</li>
</ul>
<h3 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h3><ul>
<li>对请求对象去重</li>
<li>对请求对象进行排队</li>
</ul>
<h3 id="下载器"><a href="#下载器" class="headerlink" title="下载器"></a>下载器</h3><blockquote>
<p> twisted实现异步下载</p>
</blockquote>
<ul>
<li>对数据进行下载</li>
</ul>
<h3 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h3><ul>
<li>进行持久化存储</li>
</ul>
<h3 id="引擎"><a href="#引擎" class="headerlink" title="引擎"></a>引擎</h3><ul>
<li>用于数据流处理</li>
<li>触发事务(对象实例化，调用方法)</li>
</ul>
<blockquote>
<p>根据收到的数据流判断触发的事务</p>
</blockquote>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><ul>
<li><p>爬虫中间件：引擎与Spider间</p>
</li>
<li><p>下载中间件：在引擎和下载间</p>
<ul>
<li><p>拦截请求：头信息(UA伪装)，代理ip</p>
<blockquote>
<p>配置文件中是基于全局的，但中间件中是对于每个请求</p>
</blockquote>
<ul>
<li><p>middlewares文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载中间件重写</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MiddleproDownloaderMiddleware</span>:</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="comment"># 拦截请求</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_request</span>(<span class="params">self, request, spider</span>):</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 拦截异常</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_exception</span>(<span class="params">self, request, exception, spider</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>在配置文件中设置DOWNLOADER__MIDDLEWARES使用下载中间件</p>
</li>
</ul>
</li>
<li><p>拦截响应：篡改响应数据或响应对象</p>
<blockquote>
<p>一般通过中间件拦截响应来处理动态加载问题</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_response</span>(<span class="params">self, request, response, spider</span>):</span><br><span class="line">    <span class="comment"># 通过url指定request，通过request指定response</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> request.url <span class="keyword">in</span> spider.url_list:</span><br><span class="line">        <span class="comment"># 五大板块的响应对象</span></span><br><span class="line">        <span class="comment"># 基于selemium获取动态响应对象替代原响应对象</span></span><br><span class="line">        <span class="comment"># selenium最好在爬虫对象中定义</span></span><br><span class="line">        bro = spider.bro</span><br><span class="line">        bro.get(request.url)</span><br><span class="line">        time.sleep(<span class="number">3</span>)</span><br><span class="line">        page_text = bro.page_source</span><br><span class="line">        new_response = HtmlResponse(url=request.url, body=page_text, encoding=<span class="string">&#x27;utf-8&#x27;</span>, request=request)</span><br><span class="line">        <span class="keyword">return</span> new_response</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h1 id="APP爬取"><a href="#APP爬取" class="headerlink" title="APP爬取"></a>APP爬取</h1><p>APP爬取相比于Web端更加容易，反爬虫能力没有那么强，APP端需要借助各种抓包工具，分析APP运行过程中的请求和响应，如果没有规律，可以利用mitmdump直接处理Response，另外，也要对APP进行自动化控制</p>
<h2 id="Charles"><a href="#Charles" class="headerlink" title="Charles"></a>Charles</h2><h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><p>Charles运行在PC上，运行时会在PC的8888端口开启HTTP&#x2F;HTTPS代理服务</p>
<p>设置手机代理为Charles的代理地址，手机访问的数据包就会流经Charles，Charles起到中间人的作用，可以捕获所有的流量包，同时Charles还有权利对请求和响应进行修改</p>
<p>Charles对于明文抓包比较友好</p>
<h2 id="mitmproxy"><a href="#mitmproxy" class="headerlink" title="mitmproxy"></a>mitmproxy</h2><p>mitmproxy类似于Charles，支持HTTP&#x2F;HTTPS抓包，但为命令行形式，它有两个插件，一个是mitmdump，是mitmproxy的命令行接口，可以对接Python脚本，另一个是mitmweb，是一个Web程序，可以观察不获得请求</p>
<h3 id="功能-2"><a href="#功能-2" class="headerlink" title="功能"></a>功能</h3><ul>
<li>拦截HTTP&#x2F;HTTPS响应</li>
<li>保存HTTP会话并分析</li>
<li>模拟客户端发起请求，模拟服务端返回响应</li>
<li>进行流量转发</li>
<li>支持透明代理</li>
<li>利用Python对HTTP请求和响应进行处理</li>
</ul>
<h3 id="mitmdump"><a href="#mitmdump" class="headerlink" title="mitmdump"></a>mitmdump</h3><p>mitmdump可以对接Python</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -w outfile	# 保存截获的数据包</span><br><span class="line">mitmdump -s script.py	# 将截获的数据包交给脚本处理</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">flow</span>):</span><br><span class="line">    flow.request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;MitmProxy&#x27;</span></span><br></pre></td></tr></table></figure>

<p>脚本中接受一个<code>HTTPFlow</code>对象</p>
<ul>
<li><p>日志</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">flow</span>):</span><br><span class="line">    ctx.log.info(<span class="built_in">str</span>(flow.request.headers))</span><br></pre></td></tr></table></figure>

<p>日志需要调用<code>ctx</code>模块，调用不同的方法进行输出</p>
</li>
<li><p>Request</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">flow</span>):</span><br><span class="line">    url = flow.request.url</span><br></pre></td></tr></table></figure>

<p><code>flow.request</code>是一个请求对象，由URL，Headers，Cookies等常见属性，可以直接赋值修改</p>
<blockquote>
<p>更多可以参考<a target="_blank" rel="noopener" href="http://docs.mitmproxy.org/en/latest/scripting/api.html">http://docs.mitmproxy.org/en/latest/scripting/api.html</a></p>
</blockquote>
</li>
<li><p>Response</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">flow</span>):</span><br><span class="line">    response = flow.response</span><br></pre></td></tr></table></figure>

<p>使用<code>flow.response</code>是一个Response对象，可以获取每个请求的响应内容</p>
</li>
</ul>
<h2 id="Appium"><a href="#Appium" class="headerlink" title="Appium"></a>Appium</h2><p>Appium是一个跨平台自动化测试工具，可以模拟App内部的各种操作，实际上继承自Selenium。对IOS，Appium使用UIAutomation来驱动，对Android，使用UiAutomator和Selendroid实现驱动</p>
<h3 id="启动APP"><a href="#启动APP" class="headerlink" title="启动APP"></a>启动APP</h3><ul>
<li><p>Appium内置驱动器</p>
<p>需要配置启动 App 时的 Desired Capabilities 参数，它们分别是 platformName、deviceName、appPackage、appActivity</p>
<ul>
<li>platformName，平台名称，需要区分是 Android 还是 iOS</li>
<li>deviceName，设备名称，是手机的具体类型</li>
<li>appPackage，APP 程序包名</li>
<li>appActivity，入口 Activity 名，这里通常需要以。开头</li>
</ul>
<p>Start Session后，手机启动App，PC上会弹出调试窗口，可以查看界面并查看源码，可以显示基本信息和可执行的操作</p>
<p>Appium也提供了录制操作，在窗口的App的操作都会被记录，可以自动生成相应的代码</p>
</li>
<li><p>Python代码驱动</p>
<ul>
<li><p>首先指定Appium Server</p>
</li>
<li><p>使用字典配置Desired Capabilities 参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br><span class="line">desired_caps = &#123;</span><br><span class="line">    <span class="string">&#x27;platformName&#x27;</span>: <span class="string">&#x27;Android&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;deviceName&#x27;</span>: <span class="string">&#x27;MI_NOTE_Pro&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;appPackage&#x27;</span>: <span class="string">&#x27;com.tencent.mm&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;appActivity&#x27;</span>: <span class="string">&#x27;.ui.LauncherUI&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"></span><br><span class="line">driver = webdriver.Remote(server, desired_caps)</span><br></pre></td></tr></table></figure>
</li>
<li><p>之后就可以使用自动生成的代码</p>
</li>
</ul>
</li>
</ul>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>代码操作APP，总结API为<a target="_blank" rel="noopener" href="https://github.com/appium/python-client">https://github.com/appium/python-client</a></p>
<ul>
<li><p>初始化</p>
<p>需要配置Desired Capabilities 参数，可以参考<a target="_blank" rel="noopener" href="https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md">https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md</a></p>
</li>
<li><p>查找元素</p>
<p>可以使用类似Selenium中通用的方法查找</p>
<p>在Android，可以使用UIAutomator进行查找</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_android_uiautomator(<span class="string">&#x27;new UiSelector().description(&quot;Animation&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在IOS，可以使用iOS Predicates或iOS Class Chain进行查找</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_predicate(<span class="string">&#x27;wdName == &quot;Buttons&quot;&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_class_chain(<span class="string">&#x27;XCUIElementTypeWindow/XCUIElementTypeButton[3]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>可以参考<a target="_blank" rel="noopener" href="https://github.com/appium/appium-xcuitest-driver">https://github.com/appium/appium-xcuitest-driver</a></p>
</li>
<li><p>点击</p>
<p>可以使用<code>tap()</code>方法点击(最多5个手指)，设置按的时长(毫秒)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tap(self, positions, duration=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>positions</code>，点击的位置组成的列表</li>
<li><code>duration</code>，点击持续时间</li>
</ul>
<p>也可以对元素调用<code>click()</code>方法进行点击</p>
</li>
<li><p>屏幕拖动</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scroll(self, origin_el, destination_el)</span><br></pre></td></tr></table></figure>

<p>可以使用<code>scroll()</code>方法模拟屏幕滚动，实现从元素<code>origin_el</code>滚动至元素<code>destination_el</code></p>
<ul>
<li><code>original_el</code>，被操作的元素</li>
<li><code>destination_el</code>，目标元素</li>
</ul>
<p>也可以使用<code>swipe()</code>模拟从A滑到B</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swipe(self, start_x, start_y, end_x, end_y, duration=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>start_x</code>，开始位置的横坐标</li>
<li><code>start_y</code>，开始位置的纵坐标</li>
<li><code>end_x</code>，终止位置的横坐标</li>
<li><code>end_y</code>，终止位置的纵坐标</li>
<li><code>duration</code>，持续时间，毫秒</li>
</ul>
<p>又或者使用<code>flick()</code>方法模拟从A点快速滑动到B点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flick(self, start_x, start_y, end_x, end_y)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>start_x</code>，开始位置的横坐标</li>
<li><code>start_y</code>，开始位置的纵坐标</li>
<li><code>end_x</code>，终止位置的横坐标</li>
<li><code>end_y</code>，终止位置的纵坐标</li>
</ul>
</li>
<li><p>拖拽</p>
<p>可以使用<code>drag_and_drop()</code>方法实现某个元素拖动到另一个元素上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drag_and_drop(self, origin_el, destination_el)</span><br></pre></td></tr></table></figure>

<ul>
<li>original_el，被拖拽的元素</li>
<li>destination_el，目标元素</li>
</ul>
</li>
<li><p>文本输入</p>
<p>使用<code>set_text()</code>实现文本输入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">el.set_text(<span class="string">&#x27;Hello&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>动作链</p>
<p>与Selenium中的<code>ActionChains</code>类似，Appium中的<code>TouchAction</code>可支持的方法有<code>tap()</code>、<code>press()</code>、<code>long_press()</code>、<code>release()</code>、<code>move_to()</code>、<code>wait()</code>、<code>cancel()</code>等</p>
</li>
</ul>
<blockquote>
<p>更多可以参考<a target="_blank" rel="noopener" href="https://testerhome.com/topics/3711">https://testerhome.com/topics/3711</a></p>
</blockquote>
<h3 id="Appium-mitmdump"><a href="#Appium-mitmdump" class="headerlink" title="Appium+mitmdump"></a>Appium+mitmdump</h3><p>Appium可以对动作进行模拟，但只能获取呈现的信息，mitmproxy可以获取所有响应，但无法自动化，可以使用Appium进行操作，同时mitmdump截取数据的方法进行爬取数据</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://blog.chanoch.top/2023/01/30/raw-spider-note/" title="原始笔记--python爬虫" target="_blank" rel="external">https://blog.chanoch.top/2023/01/30/raw-spider-note/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/chanochLi" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/favicon.ico" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/chanochLi" target="_blank"><span class="text-dark">chanoch</span><small class="ml-1x">student&amp;engineer</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2023/02/26/thinkbook14/" title="Thinkbook14+锐龙版安装Linux避坑指南"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/chanochLi" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="mailto:kujou.zao@gmail.com" target="_blank" title="Email" data-toggle=tooltip data-placement=top><i class="icon icon-email"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        &copy; 2023 chanoch
        
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     



  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>